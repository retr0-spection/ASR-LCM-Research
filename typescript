Script started on 2025-10-16 07:00:14+02:00 [TERM="xterm-256color" TTY="/dev/pts/15" COLUMNS="202" LINES="55"]
^C^C^C^C
[?2004honailana@mscluster-login1:~/ASR-LCM-Research$ ^C[?2004l[?2004h[?2004l
[?2004honailana@mscluster-login1:~/ASR-LCM-Research$ ^C[?2004l[?2004h[?2004l
[?2004honailana@mscluster-login1:~/ASR-LCM-Research$ s[Kcd scripts
[?2004l[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ vim exec_lcm_training3.sh 
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;55r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[55;1H"exec_lcm_training3.sh" 35L, 961B[2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[1;1H[34m#!/bin/bash
#SBATCH --job-name=Latent-Training-Final[m[2;41H[K[3;1H[34m#SBATCH --output=/home-mscluster/onailana/ASR-LCM-Research/training_final.log[m[3;78H[K[4;1H[34m#SBATCH --partition=biggpu
#SBATCH --nodes=1

# ------------------------------
# Environment
# ------------------------------[m
[38;5;130msource[m ~/.bashrc
[38;5;130mecho[m[31m [m[38;5;130m"[m[31mActivating virtual environment...[m[38;5;130m"[m
conda activate env

[38;5;130mecho[m[31m [m[38;5;130m"[m[31mStarting LCM training with DDP[m[38;5;130m"[m

[34m# ------------------------------
# Run training
# ------------------------------[m
torchrun [35m--nproc_per_node[m[38;5;130m=[m[31m2[m ~/ASR-LCM-Research/training5.py [38;5;130m\[m
    [35m--csv_path[m /datasets/onailana/codes/code_data.csv [38;5;130m\[m
    [35m--val_csv_path[m /datasets/onailana/test_codes/test_code_data.csv [38;5;130m\[m
    [35m--d_model[m [31m256[m [38;5;130m\[m
    [35m--n_heads[m [31m8[m [38;5;130m\[m
    [35m--num_layers[m [31m6[m [38;5;130m\[m
    [35m--batch_size[m [31m2[m [38;5;130m\[m
    [35m--val_batch_size[m [31m2[m [38;5;130m\[m
    [35m--epochs[m [31m1500[m [38;5;130m\[m
    [35m--lr[m 1e-4 [38;5;130m\[m
    [35m--checkpoint_dir[m /datasets/onailana/checkpoints3 [38;5;130m\[m
    [35m--lambda_waveform[m [31m0[m.[31m5[m [38;5;130m\[m
    [35m--lambda_stft[m [31m0[m.[31m5[m [38;5;130m\[m
    [35m--wandb_project[m [38;5;130m"[m[31mlcm-distill[m[38;5;130m"[m [38;5;130m\[m
    [35m--resume[m [31m1[m [38;5;130m\[m
    [35m--log_grads[m

[94m~                                                                                                                                                                                                         [37;1H~                                                                                                                                                                                                         [38;1H~                                                                                                                                                                                                         [39;1H~                                                                                                                                                                                                         [40;1H~                                                                                                                                                                                                         [41;1H~                                                                                                                                                                                                         [42;1H~                                                                                                                                                                                                         [43;1H~                                                                                                                                                                                                         [44;1H~                                                                                                                                                                                                         [45;1H~                                                                                                                                                                                                         [46;1H~                                                                                                                                                                                                         [47;1H~                                                                                                                                                                                                         [48;1H~                                                                                                                                                                                                         [49;1H~                                                                                                                                                                                                         [50;1H~                                                                                                                                                                                                         [51;1H~                                                                                                                                                                                                         [52;1H~                                                                                                                                                                                                         [53;1H~                                                                                                                                                                                                         [54;1H~                                                                                                                                                                                                         [m[55;185H32,32[9CAll[32;32H[?25h[27m[23m[29m[m[H[2J[?25l[1;1H[96m#!/bin/bash
#SBATCH --job-name=Latent-Training-Final
#SBATCH --output=/home-mscluster/onailana/ASR-LCM-Research/training_final.log
#SBATCH --partition=biggpu
#SBATCH --nodes=1

# ------------------------------
# Environment
# ------------------------------[m
[93msource[m ~/.bashrc
[93mecho[m[95m [m[93m"[m[95mActivating virtual environment...[m[93m"[m
conda activate env

[93mecho[m[95m [m[93m"[m[95mStarting LCM training with DDP[m[93m"[m

[96m# ------------------------------
# Run training
# ------------------------------[m
torchrun [38;5;224m--nproc_per_node[m[93m=[m[95m2[m ~/ASR-LCM-Research/training5.py [93m\[m
    [38;5;224m--csv_path[m /datasets/onailana/codes/code_data.csv [93m\[m
    [38;5;224m--val_csv_path[m /datasets/onailana/test_codes/test_code_data.csv [93m\[m
    [38;5;224m--d_model[m [95m256[m [93m\[m
    [38;5;224m--n_heads[m [95m8[m [93m\[m
    [38;5;224m--num_layers[m [95m6[m [93m\[m
    [38;5;224m--batch_size[m [95m2[m [93m\[m
    [38;5;224m--val_batch_size[m [95m2[m [93m\[m
    [38;5;224m--epochs[m [95m1500[m [93m\[m
    [38;5;224m--lr[m 1e-4 [93m\[m
    [38;5;224m--checkpoint_dir[m /datasets/onailana/checkpoints3 [93m\[m
    [38;5;224m--lambda_waveform[m [95m0[m.[95m5[m [93m\[m
    [38;5;224m--lambda_stft[m [95m0[m.[95m5[m [93m\[m
    [38;5;224m--wandb_project[m [93m"[m[95mlcm-distill[m[93m"[m [93m\[m
    [38;5;224m--resume[m [95m1[m [93m\[m
    [38;5;224m--log_grads[m

[94m~                                                                                                                                                                                                         [37;1H~                                                                                                                                                                                                         [38;1H~                                                                                                                                                                                                         [39;1H~                                                                                                                                                                                                         [40;1H~                                                                                                                                                                                                         [41;1H~                                                                                                                                                                                                         [42;1H~                                                                                                                                                                                                         [43;1H~                                                                                                                                                                                                         [44;1H~                                                                                                                                                                                                         [45;1H~                                                                                                                                                                                                         [46;1H~                                                                                                                                                                                                         [47;1H~                                                                                                                                                                                                         [48;1H~                                                                                                                                                                                                         [49;1H~                                                                                                                                                                                                         [50;1H~                                                                                                                                                                                                         [51;1H~                                                                                                                                                                                                         [52;1H~                                                                                                                                                                                                         [53;1H~                                                                                                                                                                                                         [54;1H~                                                                                                                                                                                                         [m[55;185H32,32[9CAll"exec_lcm_training3.sh" 35L, 961B[32;32H[?25h[?25l[55;175H~@k[32;32H[55;175H   [33;16H[55;186H3,16[33;16H[?25h[?25l[55;175H~@k[33;16H[55;175H   [34;15H[55;186H4,15[34;15H[?25h[?25l[55;175H~@k[34;15H[55;175H   [35;1H[55;186H5,0-1[35;1H[?25h[?25l[55;175H~@k[35;1H[55;175H   [34;15H[55;186H4,15 [34;15H[?25h[?25l[55;175H~@k[34;15H[55;175H   [33;16H[55;186H3,16[33;16H[?25h[?25l[55;175H~@k[33;16H[55;175H   [32;16H[55;186H2[32;16H[?25h[?25l[55;175H~@k[32;16H[55;175H   [31;16H[55;186H1[31;16H[?25h[?25l[55;175H~@k[31;16H[55;175H   [30;16H[55;186H0[30;16H[?25h[?25l[55;175H~@k[30;16H[55;175H   [29;16H[55;185H29[29;16H[?25h[?25l[55;175H~@k[29;16H[55;175H   [28;15H[55;186H8,15[28;15H[?25h[?25l[55;175H~@k[28;15H[55;175H   [27;16H[55;186H7,16[27;16H[?25h[?25l[55;175H~@k[27;16H[55;175H   [26;16H[55;186H6[26;16H[?25h[?25l[55;175H~@k[26;16H[55;175H   [25;16H[55;186H5[25;16H[?25h[?25l[55;175H~@k[25;16H[55;175H   [24;16H[55;186H4[24;16H[?25h[?25l[55;175H~@k[24;16H[55;175H   [23;16H[55;186H3[23;16H[?25h[?25l[55;175H~@k[23;16H[55;175H   [22;16H[55;186H2[22;16H[?25h[?25l[55;175H~@k[22;16H[55;175H   [21;16H[55;186H1[21;16H[?25h[?25l[55;175H~@k[21;16H[55;175H   [20;16H[55;186H0[20;16H[?25h[?25l[55;175H~@k[20;16H[55;175H   [19;16H[55;185H19[19;16H[?25h[?25l[55;175H~@k[19;16H[55;175H   [18;16H[55;186H8[18;16H[?25h[?25l[55;175H~@k[18;16H[55;175H   [17;14H[55;186H7,14[17;14H[?25h[?25l[55;175H~@k[17;14H[55;175H   [16;16H[55;186H6,16[16;16H[?25h[?25l[55;175H~@k[16;16H[55;175H   [15;1H[55;186H5,0-1[15;1H[?25h[?25l[55;175Hi[15;1H[55;175H [15;1H[55;1H[1m-- INSERT --[m[55;13H[K[55;185H15,1[10CAll[15;1H[?25h[?25l[16;54r[16;1H[L[1;55r[55;185H[K[55;185H16,1[10CAll[16;1H[?25h[?25l[17;54r[17;1H[L[1;55r[16;1H[93mexport[m [1m[96mNCCL_BLOCKING_WAIT[m=[95m1[m
[93mexport[m [1m[96mNCCL_ASYNC_ERROR_HANDLING[m=[95m1[m[55;11H[1m(paste) --[m[55;185H[K[17;35H[?25h[?25l[18;54r[18;1H[2L[1;55r[18;1H[93mexport[m [1m[96mTORCH_DISTRIBUTED_DEBUG[m=DETAIL
[93mexport[m PYTORCH_CUDA_ALLOC_CO[?25h[?25l[20;54r[20;1H[L[1;55r[19;8H[1m[96mPYTORCH_CUDA_ALLOC_CONF[m=max_split_size_mb:128[55;11H[1m--a[m[55;13H[K[55;185H20,1[10CAll[20;1H[?25h[55;1H[K[20;1H[?25l[55;175H^[[20;1H[55;175H  [20;1H[55;185H20,0-1[8CAll[20;1H[?25h[?25l[55;175H^[[20;1H[55;175H  [20;1H[55;175H^[[20;1H[55;175H  [20;1H[?25h[?25l[55;175Hq[20;1H[?25h[?25l[55;176H^[[20;1H[55;176H  [20;1H[55;176H^[[20;1H[55;175H   [20;1H[?25h[?25l[55;175H:[20;1H[55;175H[K[55;1H:[?25hq[?25l[55;2H[K[55;2H[?25hwq[?25l[?2004l[>4;m"exec_lcm_training3.sh" 40L, 1116B written[23;2t[23;1t
[?1004l[?2004l[?1l>[?25h[>4;m[?1049l[23;0;0t[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ vim l[K../lcm.py 
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;55r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[55;1H"../lcm.py" 419L, 16515B[2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[2;1H        [34m# Aggregate stats across ranks if DDP[m[2;46H[K[3;1H        [38;5;130mif[m is_ddp:[3;19H[K[4;13Hstats = torch.tensor([epoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count], device=device)[5;13Hdist.all_reduce(stats, op=dist.ReduceOp.SUM)[6;13Hepoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count = [stats[i].item() [38;5;130mfor[m i [38;5;130min[m [36mrange[m([31m5[m)][8;9H[34m# compute averages[m[9;9H[38;5;130mif[m epoch_count > [31m0[m:[10;13Havg_loss = epoch_loss / epoch_count[11;13Havg_ce = epoch_ce / epoch_count[12;13Havg_stft = epoch_stft / epoch_count[13;13Havg_wf = epoch_wf / epoch_count[14;9H[38;5;130melse[m:[15;13Havg_loss = avg_ce = avg_stft = avg_wf = [31m0.0[m[17;9H[34m# validation[m[18;9Hval_metrics = [36mNone[m[19;9H[38;5;130mif[m val_loader [38;5;130mis[m [38;5;130mnot[m [36mNone[m:[20;13Hval_metrics = validate_one_epoch([21;17Hval_loader, model, device, encodec_model,[22;17Hn_codebooks=args.n_codebooks,[23;17Hlambda_waveform=args.lambda_waveform,[24;17Hlambda_stft=args.lambda_stft,[25;17His_ddp=is_ddp[26;13H)[27;13H[38;5;130mif[m rank == [31m0[m:[28;17Hlogger.info(f[31m"Epoch {epoch+1}: train loss={avg_loss:.6f} ce={avg_ce:.6f} stft={avg_stft:.6f} wf={avg_wf:.6f} | val: {val_metrics}"[m)[29;9H[38;5;130melse[m:[30;13H[38;5;130mif[m rank == [31m0[m:[31;17Hlogger.info(f[31m"Epoch {epoch+1}: train loss={avg_loss:.6f} ce={avg_ce:.6f} stft={avg_stft:.6f} wf={avg_wf:.6f}"[m)[33;9H[34m# Save checkpoint (rank 0 only)[m[34;9H[38;5;130mif[m rank == [31m0[m:[35;13Hos.makedirs(args.checkpoint_dir, exist_ok=[36mTrue[m)[36;13Hckpt_path = os.path.join(args.checkpoint_dir, f[31m"lcm_epoch{epoch+1}.pt"[m)[37;13Htorch.save({[38;17H[31m"epoch"[m: epoch+[31m1[m,[39;17H[31m"model_state_dict"[m: model.module.state_dict() [38;5;130mif[m is_ddp [38;5;130melse[m model.state_dict(),[40;17H[31m"optimizer_state_dict"[m: optimizer.state_dict(),[41;17H[31m"scheduler_state_dict"[m: scheduler.state_dict(),[42;13H}, ckpt_path)[43;13Hlogger.info(f[31m"Saved checkpoint: {ckpt_path}"[m)[44;13Hwandb.log({[45;17H[31m"epoch"[m: epoch+[31m1[m,[46;17H[31m"train_loss"[m: avg_loss,[47;17H[31m"train_ce"[m: avg_ce,[48;17H[31m"train_stft"[m: avg_stft,[49;17H[31m"train_wf"[m: avg_wf,[50;17H**({f[31m"val_{k}"[m: v [38;5;130mfor[m k,v [38;5;130min[m val_metrics.items()} [38;5;130mif[m val_metrics [38;5;130melse[m {})[51;13H})[53;5Hlogger.info([31m"Training finished"[m)
[34m# ---------------------------[m[55;185H419,1[9CBot[54;1H[?25h[27m[23m[29m[m[H[2J[?25l[2;9H[96m# Aggregate stats across ranks if DDP[m[3;9H[93mif[m is_ddp:[4;13Hstats = torch.tensor([epoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count], device=device)[5;13Hdist.all_reduce(stats, op=dist.ReduceOp.SUM)[6;13Hepoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count = [stats[i].item() [93mfor[m i [93min[m [1m[96mrange[m([95m5[m)][8;9H[96m# compute averages[m[9;9H[93mif[m epoch_count > [95m0[m:[10;13Havg_loss = epoch_loss / epoch_count[11;13Havg_ce = epoch_ce / epoch_count[12;13Havg_stft = epoch_stft / epoch_count[13;13Havg_wf = epoch_wf / epoch_count[14;9H[93melse[m:[15;13Havg_loss = avg_ce = avg_stft = avg_wf = [95m0.0[m[17;9H[96m# validation[m[18;9Hval_metrics = [1m[96mNone[m[19;9H[93mif[m val_loader [93mis[m [93mnot[m [1m[96mNone[m:[20;13Hval_metrics = validate_one_epoch([21;17Hval_loader, model, device, encodec_model,[22;17Hn_codebooks=args.n_codebooks,[23;17Hlambda_waveform=args.lambda_waveform,[24;17Hlambda_stft=args.lambda_stft,[25;17His_ddp=is_ddp[26;13H)[27;13H[93mif[m rank == [95m0[m:[28;17Hlogger.info(f[95m"Epoch {epoch+1}: train loss={avg_loss:.6f} ce={avg_ce:.6f} stft={avg_stft:.6f} wf={avg_wf:.6f} | val: {val_metrics}"[m)[29;9H[93melse[m:[30;13H[93mif[m rank == [95m0[m:[31;17Hlogger.info(f[95m"Epoch {epoch+1}: train loss={avg_loss:.6f} ce={avg_ce:.6f} stft={avg_stft:.6f} wf={avg_wf:.6f}"[m)[33;9H[96m# Save checkpoint (rank 0 only)[m[34;9H[93mif[m rank == [95m0[m:[35;13Hos.makedirs(args.checkpoint_dir, exist_ok=[1m[96mTrue[m)[36;13Hckpt_path = os.path.join(args.checkpoint_dir, f[95m"lcm_epoch{epoch+1}.pt"[m)[37;13Htorch.save({[38;17H[95m"epoch"[m: epoch+[95m1[m,[39;17H[95m"model_state_dict"[m: model.module.state_dict() [93mif[m is_ddp [93melse[m model.state_dict(),[40;17H[95m"optimizer_state_dict"[m: optimizer.state_dict(),[41;17H[95m"scheduler_state_dict"[m: scheduler.state_dict(),[42;13H}, ckpt_path)[43;13Hlogger.info(f[95m"Saved checkpoint: {ckpt_path}"[m)[44;13Hwandb.log({[45;17H[95m"epoch"[m: epoch+[95m1[m,[46;17H[95m"train_loss"[m: avg_loss,[47;17H[95m"train_ce"[m: avg_ce,[48;17H[95m"train_stft"[m: avg_stft,[49;17H[95m"train_wf"[m: avg_wf,[50;17H**({f[95m"val_{k}"[m: v [93mfor[m k,v [93min[m val_metrics.items()} [93mif[m val_metrics [93melse[m {})[51;13H})[53;5Hlogger.info([95m"Training finished"[m)
[96m# ---------------------------[m[55;185H419,1[9CBot"../lcm.py" 419L, 16515B[54;1H[?25h[?25l[55;175HG[54;1H[55;175H [54;1H[?25h[?25l[55;175HV[54;1H[55;175H1[54;1H[1C[96m[48;5;242m ---------------------------[m[48;5;242m [m
[1m-- VISUAL LINE --[m[55;19H[K[55;175H1[54;1H[55;185H419,1[9CBot[54;1H[?25h[?25l[55;175Hg[54;1H[?25h[?25l[55;175H1[54;1H[55;176Hgg[54;1H[55;175H419[1;1H[27m[23m[29m[m[H[2J[1;1H[96m#[m[96m[48;5;242m!/usr/bin/env python3[m[48;5;242m [m
[95m[48;5;242m"""[m[48;5;242m [m
[95m[48;5;242mtraining_final_ddp_safe.py[m[48;5;242m [m
[95m[48;5;242m 
DDP-safe LCM training with token CE + waveform L1 + multi-resolution STFT losses,[m[48;5;242m [m
[95m[48;5;242mEncodec decoding, OOM adaptive batch, warmup scheduler, checkpoint resume, W&B logging.[m[48;5;242m [m
[95m[48;5;242m 
Author: generated by assistant for user's LCM workflow[m[48;5;242m [m
[95m[48;5;242m"""[m[48;5;242m 
 [m
[38;5;81m[48;5;242mimport[m[48;5;242m os [m
[38;5;81m[48;5;242mimport[m[48;5;242m sys [m
[38;5;81m[48;5;242mimport[m[48;5;242m argparse [m
[38;5;81m[48;5;242mimport[m[48;5;242m logging [m
[38;5;81m[48;5;242mimport[m[48;5;242m traceback [m
[38;5;81m[48;5;242mfrom[m[48;5;242m datetime [m[38;5;81m[48;5;242mimport[m[48;5;242m datetime [m
[38;5;81m[48;5;242mimport[m[48;5;242m time 
 [m
[38;5;81m[48;5;242mimport[m[48;5;242m torch [m
[38;5;81m[48;5;242mimport[m[48;5;242m torch.nn [m[93m[48;5;242mas[m[48;5;242m nn [m
[38;5;81m[48;5;242mimport[m[48;5;242m torch.nn.functional [m[93m[48;5;242mas[m[48;5;242m F [m
[38;5;81m[48;5;242mfrom[m[48;5;242m torch.utils.data [m[38;5;81m[48;5;242mimport[m[48;5;242m DataLoader [m
[38;5;81m[48;5;242mfrom[m[48;5;242m torch.nn.utils.rnn [m[38;5;81m[48;5;242mimport[m[48;5;242m pad_sequence [m
[38;5;81m[48;5;242mimport[m[48;5;242m torch.distributed [m[93m[48;5;242mas[m[48;5;242m dist [m
[38;5;81m[48;5;242mfrom[m[48;5;242m torch.utils.data.distributed [m[38;5;81m[48;5;242mimport[m[48;5;242m DistributedSampler 
 [m
[38;5;81m[48;5;242mimport[m[48;5;242m wandb [m
[38;5;81m[48;5;242mfrom[m[48;5;242m encodec [m[38;5;81m[48;5;242mimport[m[48;5;242m EncodecModel 
 [m
[96m[48;5;242m# ---------------------------[m[48;5;242m [m
[96m[48;5;242m# Utils: DDP init & exception hook[m[48;5;242m [m
[96m[48;5;242m# ---------------------------[m[48;5;242m [m
[93m[48;5;242mdef[m[48;5;242m [m[1m[96m[48;5;242minstall_except_hook[m[48;5;242m(rank): 
    [m[93m[48;5;242mdef[m[48;5;242m [m[1m[96m[48;5;242mhandle_exception[m[48;5;242m(exc_type, exc_value, exc_traceback): 
        [m[93m[48;5;242mif[m[48;5;242m [m[1m[96m[48;5;242missubclass[m[48;5;242m(exc_type, [m[38;5;121m[48;5;242mKeyboardInterrupt[m[48;5;242m): 
            sys.__excepthook__(exc_type, exc_value, exc_traceback) 
            [m[93m[48;5;242mreturn[m[48;5;242m 
        logging.error(f[m[95m[48;5;242m"Uncaught exception on rank {rank}"[m[48;5;242m, exc_info=(exc_type, exc_value, exc_traceback)) 
        [m[93m[48;5;242mwith[m[48;5;242m [m[1m[96m[48;5;242mopen[m[48;5;242m(f[m[95m[48;5;242m"traceback_rank{rank}.log"[m[48;5;242m, [m[95m[48;5;242m"w"[m[48;5;242m) [m[93m[48;5;242mas[m[48;5;242m f: 
            traceback.print_exception(exc_type, exc_value, exc_traceback, file=f) 
    sys.excepthook = handle_exception 
 [m
[93m[48;5;242mdef[m[48;5;242m [m[1m[96m[48;5;242mddp_setup_from_env[m[48;5;242m(): 
    local_rank = [m[1m[96m[48;5;242mint[m[48;5;242m(os.environ.get([m[95m[48;5;242m"LOCAL_RANK"[m[48;5;242m, [m[95m[48;5;242m"0"[m[48;5;242m)) 
    rank = [m[1m[96m[48;5;242mint[m[48;5;242m(os.environ.get([m[95m[48;5;242m"RANK"[m[48;5;242m, os.environ.get([m[95m[48;5;242m"LOCAL_RANK"[m[48;5;242m, [m[95m[48;5;242m"0"[m[48;5;242m))) 
    world_size = [m[1m[96m[48;5;242mint[m[48;5;242m(os.environ.get([m[95m[48;5;242m"WORLD_SIZE"[m[48;5;242m, [m[95m[48;5;242m"1"[m[48;5;242m)) 
 
    device = torch.device(f[m[95m[48;5;242m"cuda:{local_rank}"[m[48;5;242m [m[93m[48;5;242mif[m[48;5;242m torch.cuda.is_available() [m[93m[48;5;242melse[m[48;5;242m [m[95m[48;5;242m"cpu"[m[48;5;242m) 
    [m[93m[48;5;242mif[m[48;5;242m torch.cuda.is_available(): 
        torch.cuda.set_device(device) 
 
    is_ddp = world_size > [m[95m[48;5;242m1[m[48;5;242m 
    [m[93m[48;5;242mif[m[48;5;242m is_ddp [m[93m[48;5;242mand[m[48;5;242m [m[93m[48;5;242mnot[m[48;5;242m dist.is_initialized(): 
        dist.init_process_group(backend=[m[95m[48;5;242m"nccl"[m[48;5;242m, init_method=[m[95m[48;5;242m"env://"[m[48;5;242m) [m
[1m-- VISUAL LINE --[m[157C419[1;1H[55;185H1,1[11CTop[1;1H[?25h[?25l[55;175Hd  [1;1H[55;175H [1;1H[1;1H[K[2;1H[94m~                                                                                                                                                                                                         [3;1H~                                                                                                                                                                                                         [4;1H~                                                                                                                                                                                                         [5;1H~                                                                                                                                                                                                         [6;1H~                                                                                                                                                                                                         [7;1H~                                                                                                                                                                                                         [8;1H~                                                                                                                                                                                                         [9;1H~                                                                                                                                                                                                         [10;1H~                                                                                                                                                                                                         [11;1H~                                                                                                                                                                                                         [12;1H~                                                                                                                                                                                                         [13;1H~                                                                                                                                                                                                         [14;1H~                                                                                                                                                                                                         [15;1H~                                                                                                                                                                                                         [16;1H~                                                                                                                                                                                                         [17;1H~                                                                                                                                                                                                         [18;1H~                                                                                                                                                                                                         [19;1H~                                                                                                                                                                                                         [20;1H~                                                                                                                                                                                                         [21;1H~                                                                                                                                                                                                         [22;1H~                                                                                                                                                                                                         [23;1H~                                                                                                                                                                                                         [24;1H~                                                                                                                                                                                                         [25;1H~                                                                                                                                                                                                         [26;1H~                                                                                                                                                                                                         [27;1H~                                                                                                                                                                                                         [28;1H~                                                                                                                                                                                                         [29;1H~                                                                                                                                                                                                         [30;1H~                                                                                                                                                                                                         [31;1H~                                                                                                                                                                                                         [32;1H~                                                                                                                                                                                                         [33;1H~                                                                                                                                                                                                         [34;1H~                                                                                                                                                                                                         [35;1H~                                                                                                                                                                                                         [36;1H~                                                                                                                                                                                                         [37;1H~                                                                                                                                                                                                         [38;1H~                                                                                                                                                                                                         [39;1H~                                                                                                                                                                                                         [40;1H~                                                                                                                                                                                                         [41;1H~                                                                                                                                                                                                         [42;1H~                                                                                                                                                                                                         [43;1H~                                                                                                                                                                                                         [44;1H~                                                                                                                                                                                                         [45;1H~                                                                                                                                                                                                         [46;1H~                                                                                                                                                                                                         [47;1H~                                                                                                                                                                                                         [48;1H~                                                                                                                                                                                                         [49;1H~                                                                                                                                                                                                         [50;1H~                                                                                                                                                                                                         [51;1H~                                                                                                                                                                                                         [52;1H~                                                                                                                                                                                                         [53;1H~                                                                                                                                                                                                         [54;1H~                                                                                                                                                                                                         [m[55;1H[K[55;185H0,0-1[9CAll--No lines in buffer--[55;185H[K[55;185H0,0-1[9CAll[1;1H[?25h[?25l[55;1H[1m-- INSERT --[m[55;13H[K[55;185H0,1[11CAll[1;1H[96m#!/usr/bin/env python3[m
[95m"""[m[2;4H[K[3;1H[95mtraining_final.py[m[3;18H[K[4;1H[K[5;1H[95mDDP-safe LCM trai[m[5;18H[K[5;18H[?25h[?25l[95mning with:
 - token cross-entropy (backprop)[m[6;34H[K[7;1H[95m - waveform L1 + multi[m[7;23H[K[7;23H[?25h[?25l[95m-resolution STFT (perceptual metrics; detached)
 - Encodec decode [m[8;19H[K[8;19H[?25h[?25l[95munder no_grad()
 - AMP (autocast + GradScaler)[m[9;31H[K[10;1H[95m - gradient accumu[m[10;19H[K[10;19H[?25h[?25l[95mlation with DDP no_sync()
 - synchronized OOM handling across ra[m[11;39H[K[11;39H[?25h[?25l[95mnks (reduces batch size and restarts epoch)
"""[m[12;4H[K[13;1H[38;5;81mimport[m os[13;10H[K[14;1H[38;5;81mimport[m[14;7H[K[14;7H[?25h[?25l sys
[38;5;81mimport[m argparse[15;16H[K[16;1H[38;5;81mimport[m logging[16;15H[K[17;1H[38;5;81mimport[m traceback[17;17H[K[18;1H[38;5;81mfrom[m dateti[18;12H[K[18;12H[?25h[?25lme [38;5;81mimport[m datetime
[38;5;81mimport[m time[19;12H[K[20;1H[38;5;81mfrom[m contextlib [38;5;81mimport[m nullconte[20;33H[K[20;33H[?25h[?25lxt[21;1H[K[22;1H[38;5;81mimport[m torch[22;13H[K[23;1H[38;5;81mimport[m torch.nn [93mas[m nn[23;22H[K[24;1H[38;5;81mimport[m torch.nn.function[24;25H[K[24;25H[?25h[?25lal [93mas[m F
[38;5;81mfrom[m torch.utils.data [38;5;81mimport[m DataLoader[25;40H[K[26;1H[38;5;81mfrom[m torch.nn.u[26;16H[K[26;16H[?25h[?25ltils.rnn [38;5;81mimport[m pad_sequence
[38;5;81mimport[m torch.distributed [93mas[m dist[27;33H[K[28;1Hf[28;2H[K[28;2H[?25h[?25l[38;5;81mfrom[m torch.utils.data.distributed [38;5;81mimport[m DistributedSampler[29;1H[K[30;1Himp[30;4H[K[30;4H[?25h[?25l[38;5;81mimport[m wandb
[38;5;81mfrom[m encodec [38;5;81mimport[m EncodecModel[31;33H[K[32;1H[K[33;1H[96m# -----------------[m[33;20H[K[33;20H[?25h[?25l[96m----------
# Utils: DDP init & exception hook[m[34;35H[K[35;1H[96m# ---------------[m[35;18H[K[35;18H[?25h[?25l[96m------------[m
[93mdef[m [1m[96minstall_except_hook[m(rank):[36;31H[K[37;1H    [93mdef[m [1m[96mhandle_exce[m[37;20H[K[37;20H[?25h[?25l[1m[96mption[m(exc_type, exc_value, exc_traceback):
        [93mif[m issub[38;17H[K[38;17H[?25h[?25l[1m[96missubclass[m(exc_type, [38;5;121mKeyboardInterrupt[m):
            sys.__excepthook_[39;30H[K[39;30H[?25h[?25l_(exc_type, exc_value, exc_traceback)
            [93mreturn[m[40;19H[K[41;1H       [41;8H[K[41;8H[?25h[?25l logging.error(f[95m"Uncaught exception on rank {rank}"[m, exc_info=(e[?25h[?25lxc_type, exc_value, exc_traceback))
        [93mwith[m [1m[96mopen[m(f[95m"traceba[m[42;28H[K[42;28H[?25h[?25l[95mck_rank{rank}.log"[m, [95m"w"[m) [93mas[m f:
            traceback.print_exce[43;33H[K[43;33H[?25h[?25lption(exc_type, exc_value, exc_traceback, file=f)
    sys.excep[44;14H[K[44;14H[?25h[?25lthook = handle_exception[45;1H[K[46;1H[93mdef[m [1m[96mddp_setup_from_env[m():[46;26H[K[47;1H    local_r[47;12H[K[47;12H[?25h[?25lank = [1m[96mint[m(os.environ.get([95m"LOCAL_RANK"[m, [95m"0"[m))
    rank = [1m[96mint[m(os.[48;19H[K[48;19H[?25h[?25lenviron.get([95m"RANK"[m, os.environ.get([95m"LOCAL_RANK"[m, [95m"0"[m)))
    wor[49;8H[K[49;8H[?25h[?25lld_size = [1m[96mint[m(os.environ.get([95m"WORLD_SIZE"[m, [95m"1"[m))[50;1H[K[51;1H    device = [51;14H[K[51;14H[?25h[?25ltorch.device(f[95m"cuda:{local_rank}"[m [93mif[m torch.cuda.is_available() [?25h[?25l[93melse[m [95m"cpu"[m)
    [93mif[m torch.cuda.is_available():[52;34H[K[53;1H        torch.cud[53;18H[K[53;18H[?25h[?25la.set_device(device)[54;1H[K[1;54r[1;1H[2M[1;55r[53;5His_ddp = world_size > [95m1[m
    [93mif[m is_ddp[55;11H[1m(paste) --[m[55;185H[K[54;14H[?25h[?25l [93mand[m [93mnot[m dist.is_initialized():[54;32H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hdist.init_process_group(backend=[95m"nccl"[m, init_method=[95m"env://"[m)[54;25H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mreturn[m world_size, rank, local_rank, device, is_ddp[?25h[?25l[1;54r[1;1H[3M[1;55r[53;1H[96m# ---------------------------
# Logging[?25h[?25l[1;54r[m[54;1H
[1;55r[54;1H[96m# ---------------------------[m [?25h[?25l[1;54r[54;1H
[1;55r[54;1H[93mdef[m [1m[96msetup_logging[m(checkpoint_dir, rank=[95m0[m, log_level=logging.INFO):[54;25H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hos.makedirs(checkpoint_dir, exist_ok=[1m[96mTrue[m)[54;40H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Htimestamp = datetime.now().strftime([95m"%Y%m%d_%H%M%S"[m)[54;45H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hlogfile = os.path.join(checkpoint_dir, f[95m"train_{timestamp}_rank{rank}.log"[m)[54;27H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hhandlers = [logging.StreamHandler()] [93mif[m rank != [95m0[m [93melse[m [logging.FileHandler(logfile),[?25h[?25l logging.StreamHandler()][54;13H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;5Hlogging.basicConfig([54;9Hlevel=log_level,[26C[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[1m[96mformat[m=[95m"%(asctime)s | %(levelname)s | %(message)s"[m,[54;17H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;9Hdatefmt=[95m"%Y-%m-%d %H:%M:%S"[m,[54;9Hhandlers=handlers   [?25h[?25l[1;54r[1;1H[3M[1;55r[52;5H)
    logger = logging.getLogger([95m"lcm_train"[m)
    logger.info(f[95m"Logging to {logfile} (rank {rank})"[m)[54;12H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mreturn[m logger[?25h[?25l[1;54r[1;1H[4M[1;55r[52;1H[96m# ---------------------------
# Collate
# ---------------------------[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;1H[93mdef[m [1m[96mcollate_fn[m(batch):
    degraded_list, teacher_list, mask_list = [1m[96mzip[m(*[(b[[95m0[m], b[[95m1[m], b[[95m2[m]) [93mfor[m b [93min[m batch]) [?25h[?25l[1;54r[54;1H
[1;55r[54;5Hdegraded_list = [d.squeeze([95m0[m).transpose([95m0[m, [95m1[m) [93mfor[m d [93min[m degra[?25h[?25lded_list][54;54H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hteacher_list = [t.squeeze([95m0[m).transpose([95m0[m, [95m1[m) [93mfor[m t [93min[m teacher_list]   [?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmask_list = [m.squeeze() [93mfor[m m [93min[m mask_list][54;10H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hdegraded_padded = pad_sequence(degraded_list, batch_first=[1m[96mTrue[m,[?25h[?25l padding_value=[95m0[m)[54;43H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hteacher_padded = pad_sequence(teacher_list, batch_first=[1m[96mTrue[m, padding_value=[95m0[m)[54;21H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmask_padded = pad_sequence(mask_list, batch_first=[1m[96mTrue[m, padding_value=[95m0[m)    [?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmask_padded = mask_padded.unsqueeze([95m1[m).expand(-[95m1[m, degraded_pad[?25h[?25lded.shape[[95m2[m], -[95m1[m)[54;45H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mreturn[m degraded_padded, teacher_padded, mask_padded[54;13H[?25h[?25l[1;54r[1;1H[4M[1;55r[52;1H[96m# ---------------------------
# Model
# ---------------------------[54;20H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;1H[93mclass[m [1m[96mLCM_MCB[m(nn.Module):
    [93mdef[m [1m[96m__init__[m(self, vocab_size, n_codebooks, d_model=[95m256[m, n_heads=[95m4[m, num_layers[?25h[?25l=[95m4[m):[54;32H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;9H[1m[96msuper[m().__init__()[54;9Hself.n_codebooks = n_codebooks[17C[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hself.embedding = nn.Embedding(vocab_size, d_model)[54;8H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;9Hencoder_layer = nn.TransformerEncoderLayer([54;13Hd_model=d_model, nhead=n_heads, dim_feedforward=[95m4[m*d_model,[?25h[?25l batch_first=[1m[96mTrue[54;36H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;9H)[54;9Hself.transformer = nn.TransformerEncoder(encoder_layer, num_layers=num_layers)[54;12H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hself.output_heads = nn.ModuleList([nn.L[?25h[?25linear(d_model, vocab_size) [93mfor[m _ [93min[m [1m[96mrange[m(n_codeboo[?25h[?25lks)]) [?25h[?25l[1;54r[1;1H[3M[1;55r[53;5H[93mdef[m [1m[96mforward[m(self, x, attention_mask=[1m[96mNone[m):[54;9Hlogits_list = [][9C[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mfor[m i [93min[m [1m[96mrange[m(self.n_codebooks):[9C[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htokens = x[..., i][15C[96m# [B, S][?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;13Hx_emb = self.embedding(tokens)   [96m# [B, S, D][m[54;13Hsrc_key_padding_mask = (attention_mask[:, i, :] =[?25h[?25l= [95m0[m) [93mif[m attention_mask [93mis[m [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[54;18H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;13Hx_trans = self.transformer(x_emb, src_key_padding_mask=src_key_padd[?25h[?25ling_mask)[54;54H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hlogits_list.append(self.output_heads[i](x_trans))[54;55H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mreturn[m torch.stack(logits_list, dim=-[95m1[m)  [96m# [B, S, vocab, n_codebooks][54;9H[?25h[?25l[1;54r[m[1;1H[3M[1;55r[53;1H[96m# ---------------------------
# Losses[24C[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;1H[96m# ---------------------------[m
[93mclass[m [1m[96mMultiResolutionSTFTLoss[m(nn.Module):[12C[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mdef[m [1m[96m__init__[m(self, fft_sizes=[[95m512[m, [95m1024[m, [95m2048[m], hop_sizes=[[95m128[m, [95m256[m, [95m512[m], win_lengths=[[95m512[m, [95m1024[m, [95m2048[m]):[54;6H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[1m[96msuper[m().__init__()[54;7H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;9Hself.fft_sizes = fft_sizes[54;9Hself.hop_sizes = hop_sizes[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hself.win_lengths = win_lengths[54;16H[?25h[?25l[1;54r[1;1H[3M[1;55r[53;5H[93mdef[m [1m[96mforward[m(self, x, y):[54;9Hx = x.squeeze([95m1[m) [93mif[m x.dim() == [95m3[m [93melse[m x[54;35H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hy = y.squeeze([95m1[m) [93mif[m y.dim() == [95m3[m [93melse[m y[54;8H[?25h[?25l[1;54r[1;1H[3M[1;55r[52;9Hdevice = x.device[53;9Hloss = [95m0.0[m[54;9H[93mfor[m n_fft, hop, win [93min[m [1m[96mzip[m(self.fft_sizes, self.hop_sizes, self.[?25h[?25lwin_lengths):[54;51H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hwin_tensor = torch.hann_window(win, device=device)[54;52H[?25h[?25l[1;54r[54;1H
[1;55r[54;13HX = torch.stft(x, n_fft=n_fft, hop_length=hop, win_length=win, window=win_tensor, return_complex=[1m[96mTrue[m)[?25h[?25l[54;63H[?25h[?25l[1;54r[54;1H
[1;55r[54;13HY = torch.stft(y, n_fft=n_fft, hop_length=hop, win_length=win, window=win_tensor, return_complex=[1m[96mTrue[m)[54;11H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hmag_x = torch.abs(X)[54;8H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;13Hmag_y = torch.abs(Y)[54;13Hsc_loss = torch.norm(mag_y - mag_x, p=[95m'fro'[m) / (torch.norm[?25h[?25l(mag_y, p=[95m'fro'[m) + [95m1e-8[m)[54;39H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hmag_loss = F.l1_loss(torch.log1p(mag_x), torch.log1p(mag_y))[54;29H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hloss += sc_loss + mag_loss[54;10H[?25h[?25l[1;54r[1;1H[3M[1;55r[52;9H[93mreturn[m loss / [1m[96mlen[m(self.fft_sizes)

[93mclass[m [1m[96mWaveformL1Loss[m(nn.Module):[54;16H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;5H[93mdef[m [1m[96m__init__[m(self):[54;9H[1m[96msuper[m().__init__()[?25h[?25l[1;54r[1;1H[2M[1;55r[53;9Hself.l1 = nn.L1Loss()
    [93mdef[m [1m[96mforward[m(self, x, y):[?25h[?25l[1;54r[1;1H[3M[1;55r[52;9H[93mreturn[m self.l1(x, y)

[96m# --------------------------[?25h[?25l-[54;12H[?25h[?25l[1;54r[m[1;1H[3M[1;55r[52;1H[96m# Checkpoint utils
# ---------------------------[m
[93mdef[m [1m[96mlatest_checkpoint[m(checkpoint_dir):[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hckpts = [os.path.join(checkpoint_dir, f) [93mfor[m f [93min[m os.listdir(checkpoint_dir) [93mif[m f.endswith([95m".p[?25h[?25lt"[m)][54;59H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mreturn[m [1m[96mmax[m(ckpts, key=os.path.getmtime) [93mif[m ckpts [93melse[m [1m[96mNone[?25h[?25l[1;54r[m[1;1H[2M[1;55r[54;1H[93mdef[m [1m[96mload_checkpoint_compatible[m(model, ckpt_path, device, ddp):[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hcheckpoint = torch.load(ckpt_path, map_location=device) [?25h[?25l[1;54r[54;1H
[1;55r[54;5Hstate_dict = checkpoint.get([95m"model_state_dict"[m) [93mor[m checkpoint.get([95m"state_dict"[m) [93mor[m checkpoint.get([95m"model"[m)[54;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m state_dict [93mis[m [1m[96mNone[m:[22C[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mraise[m [38;5;121mKeyError[m([95m"No model weights found in checkpoint"[m)[54;30H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;5Hnew_state = {}
    [93mfor[m k, v [93min[m state_dict.items():[54;9H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;9H[93mif[m k.startswith([95m"module."[m) [93mand[m [93mnot[m ddp:[54;13Hnew_state[k[[1m[96mlen[m([95m"module."[m):]] = v[54;26H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93melif[m [93mnot[m k.startswith([95m"module."[m) [93mand[m ddp:[54;39H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hnew_state[[95m"module."[m + k] = v[54;18H[?25h[?25l[1;54r[1;1H[3M[1;55r[52;9H[93melse[m:[53;13Hnew_state[k] = v
    model.load_state_dict(new_state, strict=[1m[96mTrue[m)[54;8H[?25h[?25l[1;54r[1;1H[3M[1;55r[52;5H[93mreturn[m checkpoint

[96m# ---------------------------[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;1H[96m# Validation
# ---------------------------[54;13H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;1H[93mdef[m [1m[96mvalidate_one_epoch[m(val_loader, model, device, encodec_model, n_cod[?25h[?25lebooks, lambda_waveform, lambda_stft, is_ddp):[54;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmodel.eval() [?25h[?25l[1;54r[1;1H[2M[1;55r[53;5Hmrstft = MultiResolutionSTFTLoss()
    wf_fn = WaveformL1Loss()[21C[?25h[?25l[1;54r[54;1H
[1;55r[54;5Htotal = total_ce = total_stft = total_wf = count = [95m0.0[54;26H[?25h[?25l[1;54r[m[1;1H[3M[1;55r[53;5H[93mwith[m torch.no_grad():[54;9H[93mfor[m degraded, teacher, mask [93min[m val_loader:[54;37H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hdegraded, teacher, mask = degraded.to(device), teacher.to(device), mask.to(device)    [?25h[?25l[1;54r[54;1H
[1;55r[54;13Hlogits = model(degraded, attention_mask=mask)[54;9H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;13Hce = [95m0.0[54;10H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;13H[93mfor[m i [93min[m [1m[96mrange[m(n_codebooks):[54;17Hce += F.cross_entropy(logits[..., i].transpose([95m1[m,[95m2[m), tea[?25h[?25lcher[..., i], reduction=[95m'mean'[m)[54;32H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hce = ce / n_codebooks[26C[?25h[?25l[1;54r[1;1H[2M[1;55r[54;13Hpred_tokens = torch.argmax(logits, dim=[95m2[m).transpose([95m1[m,[95m2[m)  [?25h[?25l[1;54r[1;1H[2M[1;55r[53;13Hteacher_codes = teacher.transpose([95m1[m,[95m2[m)[54;13Hpred_wav = encodec_model.decode([(pred_tokens, [1m[96mNone[m)][?25h[?25l)[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htgt_wav = encodec_model.decode([(teacher_codes, [1m[96mNone[m)])[54;9H[?25h[?25l[1;54r[1;1H[3M[1;55r[53;13Hstft_l = mrstft(pred_wav, tgt_wav)[54;13Hwf_l = wf_fn(pred_wav, tg[?25h[?25lt_wav)   [?25h[?25l[1;54r[54;1H
[1;55r[54;13Hloss = ce + lambda_waveform * wf_l + lambda_stft * stft_l[54;32H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;13Hbsz = degraded.size([95m0[m)[54;17H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;13Htotal += loss.item() * bsz[54;13Htotal_ce += ce.item() * bsz[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htotal_stft += stft_l.item() * bsz[54;10H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;13Htotal_wf += wf_l.item() * bsz[54;13Hcount += bsz      [?25h[?25l[1;54r[1;1H[3M[1;55r[53;5H[93mif[m is_ddp:[54;9Ht = torch.tensor([total, total_ce, total_stft, total_wf, count], device=device)    [?25h[?25l[1;54r[54;1H
[1;55r[54;9Hdist.all_reduce(t, op=dist.ReduceOp.SUM)[54;18H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Htotal, total_ce, total_stft, total_wf, count = [t[i].item() [93mfor[m i [93min[m ran[?25h[?25l[1m[96mrange[m([95m5[m)][54;19H[?25h[?25l[1;54r[1;1H[4M[1;55r[52;5Hmodel.train()
    [93mif[m count == [95m0[m:[54;9H[93mreturn[m [1m[96mNone[42C[?25h[?25l[1;54r[m[54;1H
[1;55r[54;5H[93mreturn[m {[95m"loss"[m: total/count, [95m"ce"[m: total_ce/count, [95m"stft"[m: total_stft/count, [95m"waveform"[m: total_wf/count}[54;15H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;1H[96m# ---------------------------[18C[?25h[?25l[1;54r[m[54;1H
[1;55r[54;1H[96m# Training (with synchronized OOM handling + AMP + accumulation)[54;16H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;1H[96m# ---------------------------[m
[93mdef[m [1m[96mtrain[m(dataset, model, train_sampler, val_dataset, args, device, rank, loca[?25h[?25ll_rank, world_size, is_ddp):[54;35H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hlogger = setup_logging(args.checkpoint_dir, rank=rank)[54;19H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hinstall_except_hook(rank)[54;22H[?25h[?25l[1;54r[1;1H[3M[1;55r[53;5Hn_codebooks = args.n_codebooks
    [93mif[m [93mnot[m [1m[96mhasattr[m(args, [95m"accum_steps"[m):[54;18H[?25h[?25l[1;54r[1;1H[3M[1;55r[52;9Hargs.accum_steps = [95m4[m[54;5H[96m# helper to build train loader (recreated if batch size changes)[54;15H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;5H[93mdef[m [1m[96mmake_train_loader[m():[22C[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mreturn[m DataLoader(dataset, batch_size=args.per_step_batch_size, sampler=train_sampler, collate_fn=collate_[?25h[?25lfn)[54;21H[?25h[?25l[1;54r[1;1H[3M[1;55r[53;5Htrain_loader = make_train_loader()
    val_loader = DataLoader(val_dataset, batch_size=args.val_batch_size, sampler=Dis[?25h[?25ltributedSampler(val_dataset) [93mif[m is_ddp [93mand[m val_dataset [93mis[m [93mnot[m N[?25h[?25l[1m[96mNone[m [93melse[m [1m[96mNone[m, collate_fn=collate_fn) [93mif[m val_dataset [93mis[m[54;1H[94m@@@                                                                                                                                                                                                       [1;54r[m[54;1H
[1;55r[53;1H    val_loader = DataLoader(val_dataset, batch_size=args.val_batch_size, sampler=DistributedSampler(val_dataset) [93mif[m is_ddp [93mand[m val_dataset [93mis[m [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m, collate_fn=collate_fn) [93mif[m val_dataset [93miss[m[54;1H [93mnot[m Non[?25h[?25l[1m[96mNone[m [93melse[m [1m[96mNone[31C[?25h[?25l[1;54r[m[1;1H[2M[1;55r[54;5Hoptimizer = torch.optim.AdamW(model.parameters(), lr=args.lr, weight_decay=[1m[96mgetattr[m(args, [95m"weight_decay"[m, [95m0.0[m)[?25h[?25l)[54;13H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;5H[96m# lambda scheduler: warmup then linear decay[m
    warmup_steps = [1m[96mgetattr[m(args, [95m"warmup_steps"[m, [95m500[m)[54;22H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mdef[m [1m[96mlr_lambda[m(step):   [?25h[?25l[1;54r[1;1H[2M[1;55r[53;9H[93mif[m step < warmup_steps:[54;13H[93mreturn[m [1m[96mfloat[m(step + [95m1[m) / [1m[96mfloat[m([1m[96mmax[m([95m1[m, warmup_steps))[54;26H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Htotal_steps = args.epochs * [1m[96mmax[m([95m1[m, [1m[96mlen[m(train_loader))[54;23H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mreturn[m [1m[96mmax[m([95m0.0[m, [1m[96mfloat[m(total_steps - step) / [1m[96mfloat[m([1m[96mmax[m([95m1[m, total_steps - warmup_s[?25h[?25lteps)))[54;57H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hscheduler = torch.optim.lr_scheduler.LambdaLR(optimizer, lr_lambda)[54;48H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;5Hencodec_model = EncodecModel.encodec_model_24khz().to(device)[54;19H[?25h[?25l[1;54r[1;1H[3M[1;55r[52;5Hencodec_model.eval()[54;5Hstft_fn = MultiResolutionSTFTLoss()[54;12H[?25h[?25l[1;54r[1;1H[3M[1;55r[52;5Hwf_fn = WaveformL1Loss()[54;5H[96m# resume[m  [?25h[?25l[1;54r[1;1H[3M[1;55r[52;5Hstart_epoch = [95m0[m
    [93mif[m [1m[96mgetattr[m(args, [95m"resume"[m, [1m[96mFalse[m):[54;9Hckpt = latest_checkpoint(args.checkpoint_dir)[54;12H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mif[m ckpt:[54;9H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;13Hlogger.info(f[95m"Resuming from {ckpt}"[m)[54;13Hloaded = load_checkpoint_compatible(model, ckpt, device, dd[?25h[?25lp=is_ddp)    [?25h[?25l[1;54r[1;1H[2M[1;55r[53;13H[93mif[m [95m"optimizer_state_dict"[m [93min[m loaded:[54;17Hoptimizer.load_state_dict(loaded[[95m"optimizer_state_d[?25h[?25lict"[m])[54;8H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;13H[93mif[m [95m"scheduler_state_dict"[m [93min[m loaded:[54;17Hscheduler.load_state_dict(loaded[[95m"scheduler_state_dict[?25h[?25l"[m])[54;11H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;13Hstart_epoch = loaded.get([95m"epoch"[m, [95m0[m)[54;9H[93melse[m:[46C[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hlogger.info([95m"No checkpoint found; starting fresh"[m)[54;41H[?25h[?25l[1;54r[1;1H[3M[1;55r[53;5H[93mif[m rank == [95m0[m:[54;9Hwandb.init(project=[1m[96mgetattr[m(args, [95m"wandb_pr[?25h[?25loject"[m, [95m"lcm-training"[m), config=[1m[96mvars[m(args), resume=[95m"allow"[m i[?25h[?25l[93mif[m [1m[96mgetattr[m(args, [95m"resume"[m, [1m[96mFalse[m) [93melse[m [1m[96mNone[m)[54;18H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hwandb.watch(model, log=[95m"gradients"[m [93mif[m [1m[96mgetattr[m(args, [95m"log_grads"[m, [1m[96mFalse[m)[?25h[?25l [93melse[m [1m[96mNone[m)[54;9H[?25h[?25l[1;54r[1;1H[3M[1;55r[53;5Hscaler = torch.cuda.amp.GradScaler()
    accum_steps = [1m[96mint[m([1m[96mgetattr[m(args, [95m"accum_steps"[m, [95m4[m))[54;15H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;5Hlogger.info(f[95m"Starting training: epochs={args.epochs}, per_step_batch_siz[?25h[?25le={args.per_step_batch_size}, accum_steps={accum_steps}, ddp={i[?25h[?25ls_ddp}"[m)   [?25h[?25l[1;54r[1;1H[3M[1;55r[53;5H[93mfor[m epoch [93min[m [1m[96mrange[m(start_epoch, args.epochs):[54;9H[93mif[m is_ddp:[29C[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htrain_sampler.set_epoch(epoch) [93mif[m train_sampler [93mis[m [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m     [?25h[?25l[1;54r[1;1H[3M[1;55r[52;9Hmodel.train()[54;9H[96m# Create fresh loader in case it was recreated after OOM[m   [?25h[?25l[1;54r[54;1H
[1;55r[54;9Htrain_loader = make_train_loader()[54;23H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;9Hepoch_loss = epoch_ce = epoch_stft = epoch_wf = epoch_count = [95m0.0[54;12H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;9Hrestart_epoch = [1m[96mFalse[54;14H[?25h[?25l[1;54r[m[1;1H[3M[1;55r[53;9Hoptimizer.zero_grad()[54;9H[96m# iterate with index to enable no_sync decisions[1;54r[m[54;1H
[1;55r[54;9H[93mfor[m batch_i[?25h[?25ldx, (degraded, teacher, mask) [93min[m [1m[96menumerate[m(train_loader):     [?25h[?25l[1;54r[54;1H
[1;55r[54;13Hdegraded, teach[?25h[?25ler, mask = degraded.to(device), teacher.to(device), mas[?25h[?25lk.to(device)[54;45H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;13H[96m# choose no_sync context for DDP when not stepping this iter[54;32H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;13Huse_no_sync = is_ddp [93mand[m ((batch_idx + [95m1[m) % accum_steps != [95m0[m)[54;19H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hddp_ctx = model.no_sync [93mif[m use_no_sync [93melse[m nullcontext[54;11H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;13H[93mtry[m:[7C[?25h[?25l[1;54r[1;1H[2M[1;55r[53;17H[93mwith[m ddp_ctx():[54;21H[93mwith[m torch.cuda.amp.autocast():[54;34H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hlogits = model(degraded, attention_mask=mask)  [96m# [B, S, vocab, n_codeboo[?25h[?25lks][54;22H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;25Hce_loss = [95m0.0[m[54;25H[93mfor[m i [93min[m [1m[96mrange[m(n_codebooks):[54;32H[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hce_loss += F.cross_entropy(logits[..., i].transpose([95m1[m,[95m2[m), teacher[[?25h[?25l..., i], reduction=[95m'mean'[m)[54;37H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hce_loss = ce_loss / [1m[96mfloat[m(n_codebooks)[54;36H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;25H[96m# decode under no_grad()[m [?25h[?25l[1;54r[54;1H
[1;55r[54;25Hpred_tokens = torch.argmax(logits, dim=[95m2[m).transpose([95m1[m,[95m2[m)[54;32H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hteacher_codes = teacher.transpose([95m1[m,[95m2[m)[54;32H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[93mwith[m torch.no_grad():[54;22H[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hpred_wav = encodec_model.decode([(pred_token[?25h[?25ls, [1m[96mNone[m)])[54;45H[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hteacher_wav = encodec_model.decode([(teacher_codes, [1m[96mNone[m)])[54;13H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;25H[96m# compute audio losses (detached from autograd)[?25h[?25l[54;61H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hstft_loss = stft_fn(pred_wav, teacher_wav).detach()[54;46H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hwf_loss = wf_fn(pred_wav, teacher_wav).detach()[54;35H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;25H[96m# combine losses but scale CE for accumulation[54;26H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hloss = ce_loss + args.lambda_waveform * wf_loss + args.lambda_st[?25h[?25lft * stft_loss[54;49H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hloss_scaled = loss / accum_steps[?25h[?25l[1;54r[1;1H[2M[1;55r[54;21Hscaler.scale(loss_scaled).backward()[?25h[?25l[1;54r[1;1H[3M[1;55r[53;17H[96m# Step when accumulation boundary reached[m[54;17His_last_step = (batch_idx + [95m1[m == [1m[96mlen[m(train_load[?25h[?25ler))[54;59H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[93mif[m ((batch_idx + [95m1[m) % accum_steps == [95m0[m) [93mor[m is_last_step:     [?25h[?25l[1;54r[1;1H[2M[1;55r[53;21Hscaler.step(optimizer)[54;21Hscaler.update()[?25h[?25l[1;54r[54;1H
[1;55r[54;21Hoptimizer.zero_grad()  [?25h[?25l[1;54r[1;1H[3M[1;55r[52;21Hscheduler.step()[54;17Hbsz = degraded.size([95m0[m)[54;31H[?25h[?25l[1;54r[54;1H
[1;55r[54;17Hepoch_loss += loss.item() * bsz [?25h[?25l[1;54r[54;1H
[1;55r[54;17Hepoch_ce += ce_loss.item() * bsz[54;12H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;17Hepoch_stft += stft_loss.item() * bsz[54;17Hepoch_wf += wf_loss.item() * bsz[54;27H[?25h[?25l[1;54r[54;1H
[1;55r[54;17Hepoch_count += bsz[54;17H[?25h[?25l[1;54r[1;1H[3M[1;55r[53;13H[93mexcept[m [38;5;121mRuntimeError[m [93mas[m e:[54;17H[96m# Detect OOM[22C[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17Hoom = ([95m"out of memory"[m [93min[m [1m[96mstr[m(e).lower()) [93mor[m ([95m"cuda out of memory"[m [93min[m [1m[96mstr[m(e).lower())[54;12H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[93mif[m [93mnot[m oom:[54;20H[?25h[?25l[1;54r[1;1H[3M[1;55r[52;21H[93mraise[m[54;17H[96m# free what we can locally[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17Hlogging.warning(f[95m"OOM at epoch {epoch} batch {batch_idx}: {e}"[m)[54;23H[?25h[?25l[1;54r[54;1H
[1;55r[54;17Htorch.cuda.empty_cache()   [?25h[?25l[1;54r[1;1H[2M[1;55r[54;17H[96m# signal local OOM (1) or success (0)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17Hlocal_oom = torch.tensor([[95m1[m], device=device, dtype=torch.int32)[54;35H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;17H[96m# reduce across ranks to see if any rank OOMed[54;8H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;17H[93mif[m is_ddp:[54;21Hglobal_oom = local_oom.clone()[54;20H[?25h[?25l[1;54r[54;1H
[1;55r[54;21Hdist.all_reduce(global_oom, op=dist.ReduceOp.SUM)[54;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;16H[?25h[?25l     any_oom = [1m[96mint[m(global_oom.item()) > [95m0[54;21H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17H[93melse[m:    [?25h[?25l[1;54r[1;1H[3M[1;55r[52;21Hany_oom = [1m[96mTrue[m[54;17H[93mif[m any_oom:[33C[?25h[?25l[1;54r[54;1H
[1;55r[54;21H[96m# rank 0 decides the new batch size (halved)[54;28H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;21H[93mif[m is_ddp:[54;25H[93mif[m rank == [95m0[m:[15C[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hnew_bs = [1m[96mmax[m([95m1[m, args.per_step_batch_size // [95m2[m)[54;41H[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hdecide = torch.tensor([new_bs], device=device, dtype=torch.int32)[54;10H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[93melse[m:[13C[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hdecide = torch.tensor([[95m0[m], device=device, dtype=torch.int32)[54;17H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hdist.broadcast(decide, src=[95m0[m)[54;26H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hnew_bs = [1m[96mint[m(decide.item())[54;11H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;21H[93melse[m:[54;25Hnew_bs = [1m[96mmax[m([95m1[m, args.per_step_batch_size // [95m2[m) [?25h[?25l[1;54r[1;1H[2M[1;55r[54;21H[93mif[m new_bs < args.per_step_batch_size:[54;7H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hlogging.warning(f[95m"Synchronized decision: redu[?25h[?25lcing per_step_batch_size {args.per_step_batch_size} -> {new_bs}[?25h[?25l"[m)  [?25h[?25l[1;54r[1;1H[2M[1;55r[53;25Hargs.per_step_batch_size = new_bs[54;18H[?25h[?25l[7C[96m# recreate loader in next epoch loop[54;15H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hrestart_epoch = [1m[96mTrue[54;29H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25H[93mbreak[m    [?25h[?25l[1;54r[1;1H[2M[1;55r[53;21H[93melse[m:[54;25H[96m# already at 1 and still OOM -> abort training[54;24H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hlogging.error([95m"OOM at per_step_batch_size==1 on all ranks; ca[?25h[?25lnnot recover. Aborting."[m)   [?25h[?25l[1;54r[1;1H[3M[1;55r[52;25H[93mraise[m e[54;9H[93mif[m restart_epoch:[15C[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[96m# continue to next epoch iteration which will rebuild loader and retry same epoch[54;10H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;13H[93mcontinue[m     [?25h[?25l[1;54r[1;1H[3M[1;55r[53;9H[96m# Aggregate epoch stats across ranks[m[54;9H[93mif[m is_ddp:[31C[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hstats = torch.tensor([epoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count], device=device)     [?25h[?25l[1;54r[54;1H
[1;55r[54;13Hdist.all_reduce(stats, op=dist.ReduceOp.SUM)[54;12H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hepoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count = [sta[?25h[?25lts[i].item() [93mfor[m i [93min[m [1m[96mrange[m([95m5[m)][54;31H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;9Havg_loss = epoch_loss / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[54;22H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;9Havg_ce = epoch_ce / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[54;17H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;9Havg_stft = epoch_stft / epoch_count i[?25h[?25l[93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[54;27H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;9Havg_wf = epoch_wf / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[54;14H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[54;9H[96m# validation[m    [?25h[?25l[1;54r[1;1H[2M[1;55r[53;9Hval_metrics = [1m[96mNone[m[54;9H[93mif[m val_loader [93mis[m [93mnot[m [1m[96mNone[m:[15C[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hval_metrics = validate_one_epoch(val_loader, model, device, encodec_model, n_codebooks=args.n_code[?25h[?25lbooks, lambda_waveform=args.lambda_waveform, lambda_stft=args.[?25h[?25llambda_stft, is_ddp=is_ddp)[54;12H[?25h[?25l[1;54r[1;1H[3M[1;55r[53;9H[93mif[m rank == [95m0[m:[54;13Hlogger.info(f[95m"Epoch {epoch+1}: train loss={avg_loss:.6f} ce={[?25h[?25lavg_ce:.6f} stft={avg_stft:.6f} wf={avg_wf:.6f} | val: {val_met[?25h[?25lrics}"[m)[54;56H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hos.makedirs(args.checkpoint_dir, exist_ok=[1m[96mTrue[m)[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hckpt_path = os.path.join(args.checkpoint_dir, f[95m"lcm_epoch{epoch+1}.pt"[m)[54;13H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;13Htorch.save({[54;17H[95m"epoch"[m: epoch+[95m1[m,[8C[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"model_state_dict"[m: model.module.state_dict() [93mif[m is_ddp [93melse[m model.state_dict(),[54;8H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"optimizer_state_dict"[m: optimizer.state_dict(),[54;7H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"scheduler_state_dict"[m: scheduler.state_dict(),     [?25h[?25l[1;54r[54;1H
[1;55r[54;13H}, ckpt_path)[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hwandb.log({[10C[?25h[?25l[1;54r[1;1H[2M[1;55r[53;17H[95m"epoch"[m: epoch+[95m1[m,[54;17H[95m"train_loss"[m: avg_loss,[54;25H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;17H[95m"train_ce"[m: avg_ce,[54;17H[95m"train_stft"[m: avg_stft,[54;15H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;17H[95m"train_wf"[m: avg_wf,[54;17H**({f[95m"val_{k}"[m: v [93mfor[m k, v [93min[m (val_metrics [93mor[m {}).items()} )  [?25h[?25l[55;1H[K[1;54r[1;1H[3M[1;55r[52;13H})[54;5Hlogger.info[46m([m[95m"Training finished"[m[46m)[m[55;185H420,36[8CBot[54;36H[?25h[?25l[55;175H^[[54;36H[55;175H  [54;36H[55;175H^[[54;36H[55;175H  [54;36H[?25h[?25l[55;175H:[54;36H[55;175H[K[55;1H:[?25hwq[?25l[?2004l[>4;m"../lcm.py" 420L, 18708B written[23;2t[23;1t
[?1004l[?2004l[?1l>[?25h[>4;m[?1049l[23;0;0t[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$  x[K[Kvim ../lcm.py [12@exec_lcm_training3.sh[C[12P../lcm.py[C[Kvim ../lcm.py [K[K[K[K[K[K[Ktraing[King5.py 
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;55r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[55;1H"../training5.py" 103L, 3678B[2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[1;5His_ddp = world_size > [31m1[m[2;1H[K[3;1H    [34m# Device assignment[m[3;24H[K[4;5Hdevice = torch.device(f[31m"cuda:{local_rank}"[m [38;5;130mif[m torch.cuda.is_available() [38;5;130melse[m [31m"cpu"[m)
    torch.cuda.set_device(device)
    [36mprint[m(f[31m"[Rank {rank}/{world_size}] Using device: {device}"[m)[8;5H[34m# Initialize DDP if needed[m
    [38;5;130mif[m is_ddp:[10;9Hdist.init_process_group(backend=[31m"nccl"[m, init_method=[31m"env://"[m)[11;9H[36mprint[m(f[31m"[Rank {rank}] Process group initialized"[m)[13;5H[34m# ------------------------------
[m    [34m# Dataset loading
[m    [34m# ------------------------------[m
    dataset = LCMDistillDataset(args.csv_path)
    sampler = DistributedSampler(dataset) [38;5;130mif[m is_ddp [38;5;130melse[m [36mNone[m[19;5Hval_dataset = LCMDistillDataset(args.val_csv_path) [38;5;130mif[m args.val_csv_path [38;5;130melse[m [36mNone[m[21;5H[34m# Infer number of codebooks[m
    sample_data = torch.load(dataset.df.iloc[[31m0[m][[31m"filepath"[m])
    n_codebooks = sample_data[[31m"degraded"[m].shape[[31m1[m]
    [36mprint[m(f[31m"Detected {n_codebooks} codebooks from dataset sample"[m)
    args.n_codebooks = n_codebooks[27;5H[34m# ------------------------------
[m    [34m# Model initialization
[m    [34m# ------------------------------[m
    model = LCM_MCB([31;9Hvocab_size=[31m1024[m,[32;9Hn_codebooks=n_codebooks,[33;9Hd_model=args.d_model,[34;9Hn_heads=args.n_heads,[35;9Hnum_layers=args.num_layers
    ).to(device)[38;5H[34m# Wrap model with DDP if multiple GPUs[m
    [38;5;130mif[m is_ddp:[40;9Hmodel = torch.nn.parallel.DistributedDataParallel([41;13Hmodel, device_ids=[local_rank], output_device=local_rank[42;9H)[43;9H[36mprint[m(f[31m"[Rank {rank}] Model wrapped in DDP"[m)[45;5H[34m# ------------------------------
[m    [34m# Start training
[m    [34m# ------------------------------[m
    train([49;9Hdataset=dataset,[50;9Hmodel=model,[51;9Htrain_sampler=sampler,[52;9Hval_dataset=val_dataset,[53;9Hargs=args,[54;9Hdevice=device,[55;185H84,13[9C71%[49;13H[?25h[27m[23m[29m[m[H[2J[?25l[1;5His_ddp = world_size > [95m1[m[3;5H[96m# Device assignment[m
    device = torch.device(f[95m"cuda:{local_rank}"[m [93mif[m torch.cuda.is_available() [93melse[m [95m"cpu"[m)
    torch.cuda.set_device(device)
    [1m[96mprint[m(f[95m"[Rank {rank}/{world_size}] Using device: {device}"[m)[8;5H[96m# Initialize DDP if needed[m
    [93mif[m is_ddp:[10;9Hdist.init_process_group(backend=[95m"nccl"[m, init_method=[95m"env://"[m)[11;9H[1m[96mprint[m(f[95m"[Rank {rank}] Process group initialized"[m)[13;5H[96m# ------------------------------
[m    [96m# Dataset loading
[m    [96m# ------------------------------[m
    dataset = LCMDistillDataset(args.csv_path)
    sampler = DistributedSampler(dataset) [93mif[m is_ddp [93melse[m [1m[96mNone[m[19;5Hval_dataset = LCMDistillDataset(args.val_csv_path) [93mif[m args.val_csv_path [93melse[m [1m[96mNone[m[21;5H[96m# Infer number of codebooks[m
    sample_data = torch.load(dataset.df.iloc[[95m0[m][[95m"filepath"[m])
    n_codebooks = sample_data[[95m"degraded"[m].shape[[95m1[m]
    [1m[96mprint[m(f[95m"Detected {n_codebooks} codebooks from dataset sample"[m)
    args.n_codebooks = n_codebooks[27;5H[96m# ------------------------------
[m    [96m# Model initialization
[m    [96m# ------------------------------[m
    model = LCM_MCB([31;9Hvocab_size=[95m1024[m,[32;9Hn_codebooks=n_codebooks,[33;9Hd_model=args.d_model,[34;9Hn_heads=args.n_heads,[35;9Hnum_layers=args.num_layers
    ).to(device)[38;5H[96m# Wrap model with DDP if multiple GPUs[m
    [93mif[m is_ddp:[40;9Hmodel = torch.nn.parallel.DistributedDataParallel([41;13Hmodel, device_ids=[local_rank], output_device=local_rank[42;9H)[43;9H[1m[96mprint[m(f[95m"[Rank {rank}] Model wrapped in DDP"[m)[45;5H[96m# ------------------------------
[m    [96m# Start training
[m    [96m# ------------------------------[m
    train([49;9Hdataset=dataset,[50;9Hmodel=model,[51;9Htrain_sampler=sampler,[52;9Hval_dataset=val_dataset,[53;9Hargs=args,[54;9Hdevice=device,[55;185H84,13[9C71%"../training5.py" 103L, 3678B[49;13H[?25h[?25l[55;175H~@k[49;13H[55;175H   [49;13H[1;54r[54;1H
[1;55r[54;9Hrank=rank,[55;1H[K[55;185H85,13[9C73%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hlocal_rank=local_rank,[55;185H[K[55;185H86,13[9C75%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hworld_size=world_size,[55;185H[K[55;185H87,13[9C77%[49;13H[?25h[?25l[55;175H~@k[49;13H[55;175H   [49;13H[1;54r[54;1H
[1;55r[54;9His_ddp=is_ddp[55;185H[K[55;185H88,13[9C79%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H)[55;185H[K[55;185H89,13[9C81%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H90,13[9C83%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# Cleanup DDP[m[55;185H[K[55;185H91,13[9C85%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m is_ddp:[55;185H[K[55;185H92,13[9C87%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hdist.destroy_process_group()[55;185H[K[55;185H93,13[9C89%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[38;10H[46m([49;5H)[m[54;9H[1m[96mprint[m(f[95m"[Rank {rank}] Process group destroyed"[m)[55;185H[K[55;185H94,5[10C91%[49;5H[?25h[?25l[1;54r[54;1H
[1;55r[37;10H([48;5H)[55;185H[K[55;185H95,0-1[8C93%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[93mif[m __name__ == [95m"__main__"[m:[55;185H[K[55;185H96,13[9C95%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmain()[55;185H[K[55;185H97,13[9C97%[49;13H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H98,13[9CBot[49;13H[?25h[?25l[55;186H9[50;13H[?25h[?25l[55;185H100,0-1[51;1H[?25h[?25l[55;175H~@k[51;1H[55;175H   [52;13H[55;187H1,13 [52;13H[?25h[?25l[55;175H~@k[52;13H[55;175H   [51;1H[55;187H0,0-1[51;1H[?25h[?25l[55;175H~@k[51;1H[55;175H   [52;13H[55;187H1,13 [52;13H[?25h[?25l[53;9H[46m()[m[55;187H2,10[53;10H[?25h[?25l()[55;187H3,0-1[54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H^[[54;1H[55;175H  [54;1H[55;175H^[[54;1H[55;175H  [54;1H[?25h[?25l[55;175H:[54;1H[55;175H[K[55;1H:[?25hq[?25l[?2004l[>4;m[23;2t[23;1t[55;1H[K[55;1H[?1004l[?2004l[?1l>[?25h[>4;m[?1049l[23;0;0t[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ clear
[?2004l[H[2J[3J[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ clearvim ../training5.py [C[C[C[C[1P[1P[1P[1P[1@c[1@a[1@t[1@ 
[?2004l#!/usr/bin/env python3
import os
import argparse
import torch
import torch.distributed as dist
from lcm import train, collate_fn, LCM_MCB
from dataset import LCMDistillDataset
from torch.utils.data import DistributedSampler

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--csv_path", type=str, required=True)
    parser.add_argument("--val_csv_path", type=str, default=None)
    parser.add_argument("--d_model", type=int, default=256)
    parser.add_argument("--n_heads", type=int, default=8)
    parser.add_argument("--num_layers", type=int, default=8)
    parser.add_argument("--batch_size", type=int, default=2, dest="per_step_batch_size")
    parser.add_argument("--val_batch_size", type=int, default=2)
    parser.add_argument("--epochs", type=int, default=1500)
    parser.add_argument("--lr", type=float, default=1e-4)
    parser.add_argument("--checkpoint_dir", type=str, default="/datasets/onailana/checkpoints3")
    parser.add_argument("--lambda_waveform", type=float, default=0.5)
    parser.add_argument("--lambda_stft", type=float, default=0.5)
    parser.add_argument("--wandb_project", type=str, default="lcm-training")
    parser.add_argument("--log_grads", action="store_true")
    parser.add_argument("--resume", type=int, choices=[0,1], default=0)
    parser.add_argument("--weight_decay", type=float, default=0.0)
    args = parser.parse_args()

    # ------------------------------
    # DDP setup
    # ------------------------------
    local_rank = int(os.environ.get("LOCAL_RANK", 0))
    rank = int(os.environ.get("RANK", local_rank))
    world_size = int(os.environ.get("WORLD_SIZE", 1))
    is_ddp = world_size > 1

    # Device assignment
    device = torch.device(f"cuda:{local_rank}" if torch.cuda.is_available() else "cpu")
    torch.cuda.set_device(device)
    print(f"[Rank {rank}/{world_size}] Using device: {device}")

    # Initialize DDP if needed
    if is_ddp:
        dist.init_process_group(backend="nccl", init_method="env://")
        print(f"[Rank {rank}] Process group initialized")

    # ------------------------------
    # Dataset loading
    # ------------------------------
    dataset = LCMDistillDataset(args.csv_path)
    sampler = DistributedSampler(dataset) if is_ddp else None

    val_dataset = LCMDistillDataset(args.val_csv_path) if args.val_csv_path else None

    # Infer number of codebooks
    sample_data = torch.load(dataset.df.iloc[0]["filepath"])
    n_codebooks = sample_data["degraded"].shape[1]
    print(f"Detected {n_codebooks} codebooks from dataset sample")
    args.n_codebooks = n_codebooks

    # ------------------------------
    # Model initialization
    # ------------------------------
    model = LCM_MCB(
        vocab_size=1024,
        n_codebooks=n_codebooks,
        d_model=args.d_model,
        n_heads=args.n_heads,
        num_layers=args.num_layers
    ).to(device)

    # Wrap model with DDP if multiple GPUs
    if is_ddp:
        model = torch.nn.parallel.DistributedDataParallel(
            model, device_ids=[local_rank], output_device=local_rank
        )
        print(f"[Rank {rank}] Model wrapped in DDP")

    # ------------------------------
    # Start training
    # ------------------------------
    train(
        dataset=dataset,
        model=model,
        train_sampler=sampler,
        val_dataset=val_dataset,
        args=args,
        device=device,
        rank=rank,
        local_rank=local_rank,
        world_size=world_size,
        is_ddp=is_ddp
    )

    # Cleanup DDP
    if is_ddp:
        dist.destroy_process_group()
        print(f"[Rank {rank}] Process group destroyed")

if __name__ == "__main__":
    main()

[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ cat ../training5.py lear[Kvim ../training5.py 
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;55r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[55;1H"../training5.py" 103L, 3678B[2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[1;5H[34m# ------------------------------[m
    dataset = LCMDistillDataset(args.csv_path)[2;47H[K[3;1H    sampler = DistributedSampler(dataset) [38;5;130mif[m is_ddp [38;5;130melse[m [36mNone[m[3;62H[K[5;5Hval_dataset = LCMDistillDataset(args.val_csv_path) [38;5;130mif[m args.val_csv_path [38;5;130melse[m [36mNone[m[7;5H[34m# Infer number of codebooks[m
    sample_data = torch.load(dataset.df.iloc[[31m0[m][[31m"filepath"[m])
    n_codebooks = sample_data[[31m"degraded"[m].shape[[31m1[m]
    [36mprint[m(f[31m"Detected {n_codebooks} codebooks from dataset sample"[m)
    args.n_codebooks = n_codebooks[13;5H[34m# ------------------------------
[m    [34m# Model initialization
[m    [34m# ------------------------------[m
    model = LCM_MCB([17;9Hvocab_size=[31m1024[m,[18;9Hn_codebooks=n_codebooks,[19;9Hd_model=args.d_model,[20;9Hn_heads=args.n_heads,[21;9Hnum_layers=args.num_layers
    ).to(device)[24;5H[34m# Wrap model with DDP if multiple GPUs[m
    [38;5;130mif[m is_ddp:[26;9Hmodel = torch.nn.parallel.DistributedDataParallel([27;13Hmodel, device_ids=[local_rank], output_device=local_rank[28;9H)[29;9H[36mprint[m(f[31m"[Rank {rank}] Model wrapped in DDP"[m)[31;5H[34m# ------------------------------
[m    [34m# Start training
[m    [34m# ------------------------------[m
    train([35;9Hdataset=dataset,[36;9Hmodel=model,[37;9Htrain_sampler=sampler,[38;9Hval_dataset=val_dataset,[39;9Hargs=args,[40;9Hdevice=device,[41;9Hrank=rank,[42;9Hlocal_rank=local_rank,[43;9Hworld_size=world_size,[44;9His_ddp=is_ddp
    )[47;5H[34m# Cleanup DDP[m
    [38;5;130mif[m is_ddp:[49;9Hdist.destroy_process_group()[50;9H[36mprint[m(f[31m"[Rank {rank}] Process group destroyed"[m)

[38;5;130mif[m __name__ == [31m"__main__"[m:
    main()[55;185H103,0-1[7CBot[54;1H[?25h[27m[23m[29m[m[H[2J[?25l[1;5H[96m# ------------------------------[m
    dataset = LCMDistillDataset(args.csv_path)
    sampler = DistributedSampler(dataset) [93mif[m is_ddp [93melse[m [1m[96mNone[m[5;5Hval_dataset = LCMDistillDataset(args.val_csv_path) [93mif[m args.val_csv_path [93melse[m [1m[96mNone[m[7;5H[96m# Infer number of codebooks[m
    sample_data = torch.load(dataset.df.iloc[[95m0[m][[95m"filepath"[m])
    n_codebooks = sample_data[[95m"degraded"[m].shape[[95m1[m]
    [1m[96mprint[m(f[95m"Detected {n_codebooks} codebooks from dataset sample"[m)
    args.n_codebooks = n_codebooks[13;5H[96m# ------------------------------
[m    [96m# Model initialization
[m    [96m# ------------------------------[m
    model = LCM_MCB([17;9Hvocab_size=[95m1024[m,[18;9Hn_codebooks=n_codebooks,[19;9Hd_model=args.d_model,[20;9Hn_heads=args.n_heads,[21;9Hnum_layers=args.num_layers
    ).to(device)[24;5H[96m# Wrap model with DDP if multiple GPUs[m
    [93mif[m is_ddp:[26;9Hmodel = torch.nn.parallel.DistributedDataParallel([27;13Hmodel, device_ids=[local_rank], output_device=local_rank[28;9H)[29;9H[1m[96mprint[m(f[95m"[Rank {rank}] Model wrapped in DDP"[m)[31;5H[96m# ------------------------------
[m    [96m# Start training
[m    [96m# ------------------------------[m
    train([35;9Hdataset=dataset,[36;9Hmodel=model,[37;9Htrain_sampler=sampler,[38;9Hval_dataset=val_dataset,[39;9Hargs=args,[40;9Hdevice=device,[41;9Hrank=rank,[42;9Hlocal_rank=local_rank,[43;9Hworld_size=world_size,[44;9His_ddp=is_ddp
    )[47;5H[96m# Cleanup DDP[m
    [93mif[m is_ddp:[49;9Hdist.destroy_process_group()[50;9H[1m[96mprint[m(f[95m"[Rank {rank}] Process group destroyed"[m)

[93mif[m __name__ == [95m"__main__"[m:
    main()[55;185H103,0-1[7CBot"../training5.py" 103L, 3678B[54;1H[?25h[?25l[55;175HV[54;1H[55;175H1[54;1H
[1m-- VISUAL LINE --[m[55;19H[K[55;175H1[54;1H[55;185H103,0-1[7CBot[54;1H[?25h[?25l[55;175Hg[54;1H[?25h[?25l[55;175H1[54;1H[55;176Hgg[54;1H[55;176H03[1;1H[1;54r[1;1H[49L[1;55r[1;1H[96m#[m[96m[48;5;242m!/usr/bin/env python3[m[48;5;242m [m
[38;5;81m[48;5;242mimport[m[48;5;242m os [m
[38;5;81m[48;5;242mimport[m[48;5;242m argparse [m
[38;5;81m[48;5;242mimport[m[48;5;242m torch [m
[38;5;81m[48;5;242mimport[m[48;5;242m torch.distributed [m[93m[48;5;242mas[m[48;5;242m dist [m
[38;5;81m[48;5;242mfrom[m[48;5;242m lcm [m[38;5;81m[48;5;242mimport[m[48;5;242m train, collate_fn, LCM_MCB [m
[38;5;81m[48;5;242mfrom[m[48;5;242m dataset [m[38;5;81m[48;5;242mimport[m[48;5;242m LCMDistillDataset [m
[38;5;81m[48;5;242mfrom[m[48;5;242m torch.utils.data [m[38;5;81m[48;5;242mimport[m[48;5;242m DistributedSampler 
 [m
[93m[48;5;242mdef[m[48;5;242m [m[1m[96m[48;5;242mmain[m[48;5;242m(): 
    parser = argparse.ArgumentParser() 
    parser.add_argument([m[95m[48;5;242m"--csv_path"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mstr[m[48;5;242m, required=[m[1m[96m[48;5;242mTrue[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--val_csv_path"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mstr[m[48;5;242m, default=[m[1m[96m[48;5;242mNone[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--d_model"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mint[m[48;5;242m, default=[m[95m[48;5;242m256[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--n_heads"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mint[m[48;5;242m, default=[m[95m[48;5;242m8[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--num_layers"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mint[m[48;5;242m, default=[m[95m[48;5;242m8[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--batch_size"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mint[m[48;5;242m, default=[m[95m[48;5;242m2[m[48;5;242m, dest=[m[95m[48;5;242m"per_step_batch_size"[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--val_batch_size"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mint[m[48;5;242m, default=[m[95m[48;5;242m2[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--epochs"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mint[m[48;5;242m, default=[m[95m[48;5;242m1500[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--lr"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mfloat[m[48;5;242m, default=[m[95m[48;5;242m1e-4[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--checkpoint_dir"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mstr[m[48;5;242m, default=[m[95m[48;5;242m"/datasets/onailana/checkpoints3"[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--lambda_waveform"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mfloat[m[48;5;242m, default=[m[95m[48;5;242m0.5[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--lambda_stft"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mfloat[m[48;5;242m, default=[m[95m[48;5;242m0.5[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--wandb_project"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mstr[m[48;5;242m, default=[m[95m[48;5;242m"lcm-training"[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--log_grads"[m[48;5;242m, action=[m[95m[48;5;242m"store_true"[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--resume"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mint[m[48;5;242m, choices=[[m[95m[48;5;242m0[m[48;5;242m,[m[95m[48;5;242m1[m[48;5;242m], default=[m[95m[48;5;242m0[m[48;5;242m) 
    parser.add_argument([m[95m[48;5;242m"--weight_decay"[m[48;5;242m, [m[1m[96m[48;5;242mtype[m[48;5;242m=[m[1m[96m[48;5;242mfloat[m[48;5;242m, default=[m[95m[48;5;242m0.0[m[48;5;242m) 
    args = parser.parse_args() 
 
    [m[96m[48;5;242m# ------------------------------[m[48;5;242m 
    [m[96m[48;5;242m# DDP setup[m[48;5;242m 
    [m[96m[48;5;242m# ------------------------------[m[48;5;242m 
    local_rank = [m[1m[96m[48;5;242mint[m[48;5;242m(os.environ.get([m[95m[48;5;242m"LOCAL_RANK"[m[48;5;242m, [m[95m[48;5;242m0[m[48;5;242m)) 
    rank = [m[1m[96m[48;5;242mint[m[48;5;242m(os.environ.get([m[95m[48;5;242m"RANK"[m[48;5;242m, local_rank)) 
    world_size = [m[1m[96m[48;5;242mint[m[48;5;242m(os.environ.get([m[95m[48;5;242m"WORLD_SIZE"[m[48;5;242m, [m[95m[48;5;242m1[m[48;5;242m)) 
    is_ddp = world_size > [m[95m[48;5;242m1[m[48;5;242m 
 
    [m[96m[48;5;242m# Device assignment[m[48;5;242m 
    device = torch.device(f[m[95m[48;5;242m"cuda:{local_rank}"[m[48;5;242m [m[93m[48;5;242mif[m[48;5;242m torch.cuda.is_available() [m[93m[48;5;242melse[m[48;5;242m [m[95m[48;5;242m"cpu"[m[48;5;242m) 
    torch.cuda.set_device(device) 
    [m[1m[96m[48;5;242mprint[m[48;5;242m(f[m[95m[48;5;242m"[Rank {rank}/{world_size}] Using device: {device}"[m[48;5;242m) 
 
    [m[96m[48;5;242m# Initialize DDP if needed[m[48;5;242m 
    [m[93m[48;5;242mif[m[48;5;242m is_ddp: 
        dist.init_process_group(backend=[m[95m[48;5;242m"nccl"[m[48;5;242m, init_method=[m[95m[48;5;242m"env://"[m[48;5;242m) 
        [m[1m[96m[48;5;242mprint[m[48;5;242m(f[m[95m[48;5;242m"[Rank {rank}] Process group initialized"[m[48;5;242m) 
 
    [m[96m[48;5;242m# ------------------------------[m[48;5;242m 
    [m[96m[48;5;242m# Dataset loading[m[48;5;242m 
    [m[96m[48;5;242m# ------------------------------[m[48;5;242m 
    dataset = LCMDistillDataset(args.csv_path) 
    sampler = DistributedSampler(dataset) [m[93m[48;5;242mif[m[48;5;242m is_ddp [m[93m[48;5;242melse[m[48;5;242m [m[1m[96m[48;5;242mNone[m[48;5;242m 
 
    val_dataset = LCMDistillDataset(args.val_csv_path) [m[93m[48;5;242mif[m[48;5;242m args.val_csv_path [m[93m[48;5;242melse[m[48;5;242m [m[1m[96m[48;5;242mNone[m[48;5;242m [m[55;175H[K[55;175H103[1;1H[55;185H1,1[11CTop[1;1H[?25h[?25l[55;175Hd  [1;1H[55;175H [1;1H[1;1H[K[2;1H[94m~                                                                                                                                                                                                         [3;1H~                                                                                                                                                                                                         [4;1H~                                                                                                                                                                                                         [5;1H~                                                                                                                                                                                                         [6;1H~                                                                                                                                                                                                         [7;1H~                                                                                                                                                                                                         [8;1H~                                                                                                                                                                                                         [9;1H~                                                                                                                                                                                                         [10;1H~                                                                                                                                                                                                         [11;1H~                                                                                                                                                                                                         [12;1H~                                                                                                                                                                                                         [13;1H~                                                                                                                                                                                                         [14;1H~                                                                                                                                                                                                         [15;1H~                                                                                                                                                                                                         [16;1H~                                                                                                                                                                                                         [17;1H~                                                                                                                                                                                                         [18;1H~                                                                                                                                                                                                         [19;1H~                                                                                                                                                                                                         [20;1H~                                                                                                                                                                                                         [21;1H~                                                                                                                                                                                                         [22;1H~                                                                                                                                                                                                         [23;1H~                                                                                                                                                                                                         [24;1H~                                                                                                                                                                                                         [25;1H~                                                                                                                                                                                                         [26;1H~                                                                                                                                                                                                         [27;1H~                                                                                                                                                                                                         [28;1H~                                                                                                                                                                                                         [29;1H~                                                                                                                                                                                                         [30;1H~                                                                                                                                                                                                         [31;1H~                                                                                                                                                                                                         [32;1H~                                                                                                                                                                                                         [33;1H~                                                                                                                                                                                                         [34;1H~                                                                                                                                                                                                         [35;1H~                                                                                                                                                                                                         [36;1H~                                                                                                                                                                                                         [37;1H~                                                                                                                                                                                                         [38;1H~                                                                                                                                                                                                         [39;1H~                                                                                                                                                                                                         [40;1H~                                                                                                                                                                                                         [41;1H~                                                                                                                                                                                                         [42;1H~                                                                                                                                                                                                         [43;1H~                                                                                                                                                                                                         [44;1H~                                                                                                                                                                                                         [45;1H~                                                                                                                                                                                                         [46;1H~                                                                                                                                                                                                         [47;1H~                                                                                                                                                                                                         [48;1H~                                                                                                                                                                                                         [49;1H~                                                                                                                                                                                                         [50;1H~                                                                                                                                                                                                         [51;1H~                                                                                                                                                                                                         [52;1H~                                                                                                                                                                                                         [53;1H~                                                                                                                                                                                                         [54;1H~                                                                                                                                                                                                         [m[55;1H[K[55;185H0,0-1[9CAll--No lines in buffer--[55;185H[K[55;185H0,0-1[9CAll[1;1H[?25h[?25l[55;1H[1m-- INSERT --[m[55;13H[K[55;185H0,1[11CAll[1;1H[96m#!/usr/bin/env python3[m
[38;5;81mimport[m os[2;10H[K[3;1H[38;5;81mimport[m argparse[3;16H[K[4;1H[38;5;81mimport[m torch[4;13H[K[5;1Him[5;3H[K[5;3H[?25h[?25l[38;5;81mimport[m torch.distributed [93mas[m dist
[38;5;81mfrom[m torch.utils.data [38;5;81mimport[m Distrib[6;37H[K[6;37H[?25h[?25lutedSampler
[38;5;81mfrom[m lcm [38;5;81mimport[m train, LCM_MCB[7;31H[K[8;1H[38;5;81mfrom[m dataset [38;5;81mimport[m LCM[8;24H[K[8;24H[?25h[?25lDistillDataset[9;1H[K[10;1H[93mdef[m [1m[96mmain[m():[10;12H[K[11;1H    parser = argparse.ArgumentParser([11;38H[K[11;38H[?25h[?25l)
    parser.add_argument([95m"--csv_path"[m, [1m[96mtype[m=[1m[96mstr[m, required=[1m[96mTrue[m)[12;63H[K[12;63H[?25h[?25l
    parser.add_argument([95m"--val_csv_path"[m, [1m[96mtype[m=[1m[96mstr[m, default=Non[13;64H[K[13;64H[?25h[?25l[1m[96mNone[m)
    parser.add_argument([95m"--d_model"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m256[m)[14;60H[K[15;1H [15;2H[K[15;2H[?25h[?25l   parser.add_argument([95m"--n_heads"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m8[m)
    pa[16;7H[K[16;7H[?25h[?25lrser.add_argument([95m"--num_layers"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m8[m)
    pars[17;9H[K[17;9H[?25h[?25ler.add_argument([95m"--batch_size"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m2[m)
    parser[18;11H[K[18;11H[?25h[?25l.add_argument([95m"--val_batch_size"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m2[m)
    pars[19;9H[K[19;9H[?25h[?25ler.add_argument([95m"--epochs"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m1500[m)
    parser.[20;12H[K[20;12H[?25h[?25ladd_argument([95m"--lr"[m, [1m[96mtype[m=[1m[96mfloat[m, default=[95m1e-4[m)
    parser.add_a[21;17H[K[21;17H[?25h[?25lrgument([95m"--checkpoint_dir"[m, [1m[96mtype[m=[1m[96mstr[m, default=[95m"/datasets/onaila[?25h[?25lna/checkpoints3"[m)
    parser.add_argument([95m"--lambda_waveform"[m, [22;46H[K[22;46H[?25h[?25l[1m[96mtype[m=[1m[96mfloat[m, default=[95m0.5[m)
    parser.add_argument([95m"--lambda_stft[m[23;39H[K[23;39H[?25h[?25l[95m"[m, [1m[96mtype[m=[1m[96mfloat[m, default=[95m0.5[m)
    parser.add_argument([95m"--wandb_pr[m[24;36H[K[24;36H[?25h[?25l[95moject"[m, [1m[96mtype[m=[1m[96mstr[m, default=[95m"lcm-training"[m)
    parser.add_argume[25;22H[K[25;22H[?25h[?25lnt([95m"--log_grads"[m, action=[95m"store_true"[m)
    parser.add_argument([26;25H[K[26;25H[?25h[?25l[95m"--resume"[m, [1m[96mtype[m=[1m[96mint[m, choices=[[95m0[m, [95m1[m], default=[95m0[m)
    parser.add[27;15H[K[27;15H[?25h[?25l_argument([95m"--weight_decay"[m, [1m[96mtype[m=[1m[96mfloat[m, default=[95m0.0[m)
    args =[28;11H[K[28;11H[?25h[?25l parser.parse_args()[29;1H[K[30;1H    [96m# ------------------------------[m[30;37H[K[31;1H    [31;5H[K[31;5H[?25h[?25l[96m# Distributed Setup[m
    [96m# ------------------------------[m[32;37H[K[33;1H    lo[33;7H[K[33;7H[?25h[?25lcal_rank = [1m[96mint[m(os.environ.get([95m"LOCAL_RANK"[m, [95m0[m))
    rank = [1m[96mint[m([34;16H[K[34;16H[?25h[?25los.environ.get([95m"RANK"[m, [95m0[m))
    world_size = [1m[96mint[m(os.environ.get([35;37H[K[35;37H[?25h[?25l[95m"WORLD_SIZE"[m, [95m1[m))
    is_ddp = world_size > [95m1[m[36;28H[K[37;1H[K[38;1H    torch.cuda.s[38;17H[K[38;17H[?25h[?25let_device(local_rank)
    device = torch.device(f[95m"cuda:{local_r[m[39;42H[K[39;42H[?25h[?25l[95mank}"[m [93mif[m torch.cuda.is_available() [93melse[m [95m"cpu"[m)[40;1H[K[41;1H    [93mif[m is_ddp:[41;15H[K[42;1H[K[42;1H[?25h[?25l[8Cdist.init_process_group(backend=[95m"nccl"[m, init_method=[95m"en[?25h[?25lv://"[m)
        torch.distributed.barrier()[43;36H[K[44;1H        [93mif[m rank == [95m0[m[44;21H[K[44;21H[?25h[?25l:
            [1m[96mprint[m(f[95m"[DDP] Initialized with {world_size} proce[m[45;62H[K[45;62H[?25h[?25l[95msses"[m)[46;1H[K[47;1H    [96m# ------------------------------[m[47;37H[K[48;1H    [96m# Dataset Load[m[48;19H[K[48;19H[?25h[?25l[96ming[m
    [96m# ------------------------------[m[49;37H[K[50;1H    dataset = LCMDisti[50;23H[K[50;23H[?25h[?25lllDataset(args.csv_path)
    sampler = DistributedSampler(datas[51;39H[K[51;39H[?25h[?25let, num_replicas=world_size, rank=rank, shuffle=[1m[96mTrue[m) [93mif[m is_ddp[?25h[?25l [93melse[m [1m[96mNone[m[52;1H[K[53;1H    val_dataset = LCMDistillDataset(args.val_csv_pa[53;52H[K[53;52H[?25h[?25lth) [93mif[m args.val_csv_path [93melse[m [1m[96mNone[m[54;1H[K[1;54r[54;1H
[1;55r[54;5H[96m# Infer number of codeb[m[55;11H[1m(paste) --[m[55;185H[K[54;28H[?25h[?25l[96mooks from one sample[?25h[?25l[1;54r[m[54;1H
[1;55r[54;5Hfirst_path = dataset.df.iloc[[95m0[m][[95m"filepath"[m][10C[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hsample_data = torch.load(first_path, map_location=[95m"cpu"[m)[54;9H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;5Hn_codebooks = sample_data[[95m"degraded"[m].shape[[95m1[m]
    args.n_codebooks = n_codebooks[54;19H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;5H[93mif[m rank == [95m0[m:[54;9H[1m[96mprint[m(f[95m"Detected {n_codebooks} codebooks from dataset sample"[m)[54;10H[?25h[?25l[1;54r[1;1H[2M[1;55r[54;5H[96m# ------------------------------[54;19H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;5H[96m# Model Init
[m    [96m# ------------------------------[54;24H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;5Hmodel = LCM_MCB([54;9Hvocab_size=[95m1024[m,    [?25h[?25l[1;54r[1;1H[2M[1;55r[53;9Hn_codebooks=n_codebooks,[54;9Hd_model=args.d_model,  [?25h[?25l[1;54r[1;1H[2M[1;55r[53;9Hn_heads=args.n_heads,[54;9Hnum_layers=args.num_layers[54;27H[?25h[?25l[1;54r[1;1H[4M[1;55r[51;5H).to(device)[53;5H[93mif[m is_ddp:[54;9Hmodel = torch.nn.parallel.DistributedDataParallel([54;12H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;13Hmodel,[54;13Hdevice_ids=[local_rank], [?25h[?25l[1;54r[54;1H
[1;55r[54;13Houtput_device=local_rank,[54;12H[?25h[?25l[1;54r[1;1H[3M[1;55r[52;13Hfind_unused_parameters=[1m[96mFalse[m[53;9H)[54;9H[93mif[m rank == [95m0[m:[31C[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[1m[96mprint[m([95m"[DDP] Model wrapped successfully"[m)  [?25h[?25l[1;54r[1;1H[4M[1;55r[52;5H[96m# ------------------------------
[m    [96m# Start Training
[m    [96m# ------------------------------[54;18H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;5Htrain([54;9Hdataset=dataset, [?25h[?25l[1;54r[1;1H[3M[1;55r[52;9Hval_dataset=val_dataset,[53;9Hmodel=model,[54;9Htrain_sampler=sampler,[54;15H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;9Hargs=args,[54;9Hdevice=device,    [?25h[?25l[1;54r[1;1H[3M[1;55r[52;9Hrank=rank,[53;9Hlocal_rank=local_rank,[54;9Hworld_size=world_size,[54;7H[?25h[?25l[1;54r[1;1H[4M[1;55r[51;9His_ddp=is_ddp,
    )[54;5H[96m# ------------------------------[54;19H[?25h[?25l[1;54r[m[1;1H[2M[1;55r[53;5H[96m# Cleanup
[m    [96m# ------------------------------[54;7H[?25h[?25l[1;54r[m[1;1H[3M[1;55r[52;5H[93mif[m is_ddp:[53;9Hdist.barrier()[54;9Hdist.destroy_process_group()[54;11H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;9H[93mif[m rank == [95m0[m:[54;13H[1m[96mprint[m([95m"[DDP] Cleanup complete"[m) [?25h[?25l[1;54r[1;1H[3M[1;55r[53;1H[93mif[m __name__ == [95m"__main__"[m:
    torch.multiprocessing.set_start_method([95m"spawn"[m, force=[1m[96mTrue[m)[?25h[?25l[55;1H[K[1;54r[1;1H[2M[1;55r[53;5Hmain()[55;185H112,0-1[7CBot[54;1H[?25h[?25l[55;175H^[[54;1H[55;175H  [54;1H[55;175H^[[54;1H[55;175H  [54;1H[?25h[?25l[55;175H:[54;1H[55;175H[K[55;1H:[?25hwq[?25l[?2004l[>4;m"../training5.py" 112L, 3931B written[23;2t[23;1t
[?1004l[?2004l[?1l>[?25h[>4;m[?1049l[23;0;0t[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ cd [K[K[Kvim tr[K[Kexec_lcm_training.sh 
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;55r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[55;1H"exec_lcm_training.sh" 29L, 730B[2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[1;1H[34m#!/bin/bash
#SBATCH --job-name=Latent-Training-v2[m[2;38H[K[3;1H[34m#SBATCH --output=/home-mscluster/onailana/ASR-LCM-Research/training1.log[m[3;73H[K[4;1H[34m#SBATCH --partition=bigbatch
#SBATCH --nodes=1[m


[38;5;130msource[m ~/.bashrc
[38;5;130mecho[m[31m [m[38;5;130m"[m[31mVirt env active[m[38;5;130m"[m
conda activate env
[38;5;130mecho[m[31m [m[38;5;130m"[m[31mTraining LCM Model[m[38;5;130m"[m


torchrun  ~/ASR-LCM-Research/training3.py [35m--csv_path[m /datasets/onailana/codes/code_data.csv [38;5;130m\[m
  [35m--val_csv_path[m  /datasets/onailana/test_codes/test_code_data.csv [38;5;130m\[m
  [35m--val_batch_size[m [31m2[m [38;5;130m\[m
  [35m--d_model[m [31m256[m [38;5;130m\[m
  [35m--n_heads[m [31m4[m [38;5;130m\[m
  [35m--num_layers[m [31m8[m [38;5;130m\[m
  [35m--batch_size[m [31m2[m [38;5;130m\[m
  [35m--effective_batch_size[m [31m2[m [38;5;130m\[m
  [35m--max_batch_size[m [31m2[m [38;5;130m\[m
  [35m--epochs[m [31m1500[m [38;5;130m\[m
  [35m--lr[m 1e-4 [38;5;130m\[m
  [35m--checkpoint_dir[m /datasets/onailana/checkpoints1 [38;5;130m\[m
  [35m--save_every[m [31m1[m [38;5;130m\[m
  [35m--log_level[m INFO [38;5;130m\[m
  [35m--warmup_steps[m [31m500[m [38;5;130m\[m
  [35m--resume[m [31m1[m
[94m~                                                                                                                                                                                                         [31;1H~                                                                                                                                                                                                         [32;1H~                                                                                                                                                                                                         [33;1H~                                                                                                                                                                                                         [34;1H~                                                                                                                                                                                                         [35;1H~                                                                                                                                                                                                         [36;1H~                                                                                                                                                                                                         [37;1H~                                                                                                                                                                                                         [38;1H~                                                                                                                                                                                                         [39;1H~                                                                                                                                                                                                         [40;1H~                                                                                                                                                                                                         [41;1H~                                                                                                                                                                                                         [42;1H~                                                                                                                                                                                                         [43;1H~                                                                                                                                                                                                         [44;1H~                                                                                                                                                                                                         [45;1H~                                                                                                                                                                                                         [46;1H~                                                                                                                                                                                                         [47;1H~                                                                                                                                                                                                         [48;1H~                                                                                                                                                                                                         [49;1H~                                                                                                                                                                                                         [50;1H~                                                                                                                                                                                                         [51;1H~                                                                                                                                                                                                         [52;1H~                                                                                                                                                                                                         [53;1H~                                                                                                                                                                                                         [54;1H~                                                                                                                                                                                                         [m[55;185H14,37[9CAll[14;37H[?25h[27m[23m[29m[m[H[2J[?25l[1;1H[96m#!/bin/bash
#SBATCH --job-name=Latent-Training-v2
#SBATCH --output=/home-mscluster/onailana/ASR-LCM-Research/training1.log
#SBATCH --partition=bigbatch
#SBATCH --nodes=1[m


[93msource[m ~/.bashrc
[93mecho[m[95m [m[93m"[m[95mVirt env active[m[93m"[m
conda activate env
[93mecho[m[95m [m[93m"[m[95mTraining LCM Model[m[93m"[m


torchrun  ~/ASR-LCM-Research/training3.py [38;5;224m--csv_path[m /datasets/onailana/codes/code_data.csv [93m\[m
  [38;5;224m--val_csv_path[m  /datasets/onailana/test_codes/test_code_data.csv [93m\[m
  [38;5;224m--val_batch_size[m [95m2[m [93m\[m
  [38;5;224m--d_model[m [95m256[m [93m\[m
  [38;5;224m--n_heads[m [95m4[m [93m\[m
  [38;5;224m--num_layers[m [95m8[m [93m\[m
  [38;5;224m--batch_size[m [95m2[m [93m\[m
  [38;5;224m--effective_batch_size[m [95m2[m [93m\[m
  [38;5;224m--max_batch_size[m [95m2[m [93m\[m
  [38;5;224m--epochs[m [95m1500[m [93m\[m
  [38;5;224m--lr[m 1e-4 [93m\[m
  [38;5;224m--checkpoint_dir[m /datasets/onailana/checkpoints1 [93m\[m
  [38;5;224m--save_every[m [95m1[m [93m\[m
  [38;5;224m--log_level[m INFO [93m\[m
  [38;5;224m--warmup_steps[m [95m500[m [93m\[m
  [38;5;224m--resume[m [95m1[m
[94m~                                                                                                                                                                                                         [31;1H~                                                                                                                                                                                                         [32;1H~                                                                                                                                                                                                         [33;1H~                                                                                                                                                                                                         [34;1H~                                                                                                                                                                                                         [35;1H~                                                                                                                                                                                                         [36;1H~                                                                                                                                                                                                         [37;1H~                                                                                                                                                                                                         [38;1H~                                                                                                                                                                                                         [39;1H~                                                                                                                                                                                                         [40;1H~                                                                                                                                                                                                         [41;1H~                                                                                                                                                                                                         [42;1H~                                                                                                                                                                                                         [43;1H~                                                                                                                                                                                                         [44;1H~                                                                                                                                                                                                         [45;1H~                                                                                                                                                                                                         [46;1H~                                                                                                                                                                                                         [47;1H~                                                                                                                                                                                                         [48;1H~                                                                                                                                                                                                         [49;1H~                                                                                                                                                                                                         [50;1H~                                                                                                                                                                                                         [51;1H~                                                                                                                                                                                                         [52;1H~                                                                                                                                                                                                         [53;1H~                                                                                                                                                                                                         [54;1H~                                                                                                                                                                                                         [m[55;185H14,37[9CAll"exec_lcm_training.sh" 29L, 730B[14;37H[?25h[?25l[55;175HG[14;37H[55;175H [29;3H[55;185H29,3 [29;3H[?25h[?25l[55;175HV[29;3H[55;175H1[29;3H[48;5;242m  [m[1C[38;5;224m[48;5;242m-resume[m[48;5;242m [m[95m[48;5;242m1[m[48;5;242m [m[55;1H[1m-- VISUAL LINE --[m[55;18H[K[55;175H1[29;3H[55;185H29,3[10CAll[29;3H[?25h[?25l[55;175Hg[29;3H[?25h[?25l[55;175H1[29;3H[55;176Hg[29;3H[55;177H^[[29;3H[55;176H   [29;3H[55;176Hg^[[29;3H[55;177H  [29;3H[55;177H^[[29;3H[55;176H   [29;3H[?25h[?25l[55;175H:[29;3H[55;175H [29;1H[55;1H[K[55;1H:'<,'>[?25hq[?25l[97m[41mE16: Invalid range[m[29;1H  [1C[38;5;224m-resume[m [95m1[m[29;13H[K[55;185H29,1[10CAll[29;1H[?25h[?25l[55;175H:[29;1H[55;1H[K[55;1H:[?25hq[?25l[?2004l[>4;m[23;2t[23;1t[55;1H[K[55;1H[?1004l[?2004l[?1l>[?25h[>4;m[?1049l[23;0;0t[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ clear
[?2004l[H[2J[3J[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ calt exc[Kec_lcm_training3.sh 
[?2004lCommand 'calt' not found, did you mean:
  command 'calc' from deb calc (2.12.7.2-4)
  command 'halt' from deb systemd-sysv (249.11-0ubuntu3.17)
  command 'halt' from deb finit-sysv (4.2-1)
  command 'halt' from deb molly-guard (0.7.2)
  command 'cat' from deb coreutils (8.32-4.1ubuntu1.2)
  command 'kalt' from deb fortunes-de (0.34-1)
  command 'cal' from deb ncal (12.1.7+nmu3ubuntu2)
  command 'salt' from deb salt-master (3004.1+dfsg-2)
Try: apt install <deb name>
[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ calt exec_lcm_training3.sh [C[C[C[1P
[?2004l#!/bin/bash
#SBATCH --job-name=Latent-Training-Final
#SBATCH --output=/home-mscluster/onailana/ASR-LCM-Research/training_final.log
#SBATCH --partition=biggpu
#SBATCH --nodes=1

# ------------------------------
# Environment
# ------------------------------
source ~/.bashrc
echo "Activating virtual environment..."
conda activate env

echo "Starting LCM training with DDP"

export NCCL_BLOCKING_WAIT=1
export NCCL_ASYNC_ERROR_HANDLING=1
export TORCH_DISTRIBUTED_DEBUG=DETAIL
export PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:128

# ------------------------------
# Run training
# ------------------------------
torchrun --nproc_per_node=2 ~/ASR-LCM-Research/training5.py \
    --csv_path /datasets/onailana/codes/code_data.csv \
    --val_csv_path /datasets/onailana/test_codes/test_code_data.csv \
    --d_model 256 \
    --n_heads 8 \
    --num_layers 6 \
    --batch_size 2 \
    --val_batch_size 2 \
    --epochs 1500 \
    --lr 1e-4 \
    --checkpoint_dir /datasets/onailana/checkpoints3 \
    --lambda_waveform 0.5 \
    --lambda_stft 0.5 \
    --wandb_project "lcm-distill" \
    --resume 1 \
    --log_grads

[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ cat exec_lcm_training3.sh [1@l[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[Clear[Kvim exec_lcm_training.sh [5P../training5.py[Ccat[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[Clear[Kvim ../training5.py [6Plcm[C[C[C[C[12@exec_lcm_training3.sh[C
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;55r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[55;1H"exec_lcm_training3.sh" 40L, 1116B[2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[1;1H[34m#!/bin/bash
#SBATCH --job-name=Latent-Training-Final[m[2;41H[K[3;1H[34m#SBATCH --output=/home-mscluster/onailana/ASR-LCM-Research/training_final.log[m[3;78H[K[4;1H[34m#SBATCH --partition=biggpu
#SBATCH --nodes=1

# ------------------------------
# Environment
# ------------------------------[m
[38;5;130msource[m ~/.bashrc
[38;5;130mecho[m[31m [m[38;5;130m"[m[31mActivating virtual environment...[m[38;5;130m"[m
conda activate env

[38;5;130mecho[m[31m [m[38;5;130m"[m[31mStarting LCM training with DDP[m[38;5;130m"

export[m [36mNCCL_BLOCKING_WAIT[m=[31m1[m
[38;5;130mexport[m [36mNCCL_ASYNC_ERROR_HANDLING[m=[31m1[m
[38;5;130mexport[m [36mTORCH_DISTRIBUTED_DEBUG[m=DETAIL
[38;5;130mexport[m [36mPYTORCH_CUDA_ALLOC_CONF[m=max_split_size_mb:128

[34m# ------------------------------
# Run training
# ------------------------------[m
torchrun [35m--nproc_per_node[m[38;5;130m=[m[31m2[m ~/ASR-LCM-Research/training5.py [38;5;130m\[m
    [35m--csv_path[m /datasets/onailana/codes/code_data.csv [38;5;130m\[m
    [35m--val_csv_path[m /datasets/onailana/test_codes/test_code_data.csv [38;5;130m\[m
    [35m--d_model[m [31m256[m [38;5;130m\[m
    [35m--n_heads[m [31m8[m [38;5;130m\[m
    [35m--num_layers[m [31m6[m [38;5;130m\[m
    [35m--batch_size[m [31m2[m [38;5;130m\[m
    [35m--val_batch_size[m [31m2[m [38;5;130m\[m
    [35m--epochs[m [31m1500[m [38;5;130m\[m
    [35m--lr[m 1e-4 [38;5;130m\[m
    [35m--checkpoint_dir[m /datasets/onailana/checkpoints3 [38;5;130m\[m
    [35m--lambda_waveform[m [31m0[m.[31m5[m [38;5;130m\[m
    [35m--lambda_stft[m [31m0[m.[31m5[m [38;5;130m\[m
    [35m--wandb_project[m [38;5;130m"[m[31mlcm-distill[m[38;5;130m"[m [38;5;130m\[m
    [35m--resume[m [31m1[m [38;5;130m\[m
    [35m--log_grads[m

[94m~                                                                                                                                                                                                         [42;1H~                                                                                                                                                                                                         [43;1H~                                                                                                                                                                                                         [44;1H~                                                                                                                                                                                                         [45;1H~                                                                                                                                                                                                         [46;1H~                                                                                                                                                                                                         [47;1H~                                                                                                                                                                                                         [48;1H~                                                                                                                                                                                                         [49;1H~                                                                                                                                                                                                         [50;1H~                                                                                                                                                                                                         [51;1H~                                                                                                                                                                                                         [52;1H~                                                                                                                                                                                                         [53;1H~                                                                                                                                                                                                         [54;1H~                                                                                                                                                                                                         [m[55;185H20,0-1[8CAll[20;1H[?25h[27m[23m[29m[m[H[2J[?25l[1;1H[96m#!/bin/bash
#SBATCH --job-name=Latent-Training-Final
#SBATCH --output=/home-mscluster/onailana/ASR-LCM-Research/training_final.log
#SBATCH --partition=biggpu
#SBATCH --nodes=1

# ------------------------------
# Environment
# ------------------------------[m
[93msource[m ~/.bashrc
[93mecho[m[95m [m[93m"[m[95mActivating virtual environment...[m[93m"[m
conda activate env

[93mecho[m[95m [m[93m"[m[95mStarting LCM training with DDP[m[93m"

export[m [1m[96mNCCL_BLOCKING_WAIT[m=[95m1[m
[93mexport[m [1m[96mNCCL_ASYNC_ERROR_HANDLING[m=[95m1[m
[93mexport[m [1m[96mTORCH_DISTRIBUTED_DEBUG[m=DETAIL
[93mexport[m [1m[96mPYTORCH_CUDA_ALLOC_CONF[m=max_split_size_mb:128

[96m# ------------------------------
# Run training
# ------------------------------[m
torchrun [38;5;224m--nproc_per_node[m[93m=[m[95m2[m ~/ASR-LCM-Research/training5.py [93m\[m
    [38;5;224m--csv_path[m /datasets/onailana/codes/code_data.csv [93m\[m
    [38;5;224m--val_csv_path[m /datasets/onailana/test_codes/test_code_data.csv [93m\[m
    [38;5;224m--d_model[m [95m256[m [93m\[m
    [38;5;224m--n_heads[m [95m8[m [93m\[m
    [38;5;224m--num_layers[m [95m6[m [93m\[m
    [38;5;224m--batch_size[m [95m2[m [93m\[m
    [38;5;224m--val_batch_size[m [95m2[m [93m\[m
    [38;5;224m--epochs[m [95m1500[m [93m\[m
    [38;5;224m--lr[m 1e-4 [93m\[m
    [38;5;224m--checkpoint_dir[m /datasets/onailana/checkpoints3 [93m\[m
    [38;5;224m--lambda_waveform[m [95m0[m.[95m5[m [93m\[m
    [38;5;224m--lambda_stft[m [95m0[m.[95m5[m [93m\[m
    [38;5;224m--wandb_project[m [93m"[m[95mlcm-distill[m[93m"[m [93m\[m
    [38;5;224m--resume[m [95m1[m [93m\[m
    [38;5;224m--log_grads[m

[94m~                                                                                                                                                                                                         [42;1H~                                                                                                                                                                                                         [43;1H~                                                                                                                                                                                                         [44;1H~                                                                                                                                                                                                         [45;1H~                                                                                                                                                                                                         [46;1H~                                                                                                                                                                                                         [47;1H~                                                                                                                                                                                                         [48;1H~                                                                                                                                                                                                         [49;1H~                                                                                                                                                                                                         [50;1H~                                                                                                                                                                                                         [51;1H~                                                                                                                                                                                                         [52;1H~                                                                                                                                                                                                         [53;1H~                                                                                                                                                                                                         [54;1H~                                                                                                                                                                                                         [m[55;185H20,0-1[8CAll"exec_lcm_training3.sh" 40L, 1116B[20;1H[?25h[?25l[55;175HG[20;1H[55;175H [40;1H[55;185H4[40;1H[?25h[?25l[55;175HV[40;1H[55;175H1[40;1H[55;1H[1m-- VISUAL LINE --[m[55;18H[K[55;175H1[40;1H[55;185H40,0-1[8CAll[40;1H[?25h[?25l[55;175Hg[40;1H[?25h[?25l[55;175H1[40;1H[55;176Hgg[40;1H[55;175H40 [1;1H[1C[96m[48;5;242m!/bin/bash[m[48;5;242m [m
[96m[48;5;242m#SBATCH --job-name=Latent-Training-Final[m[48;5;242m [m
[96m[48;5;242m#SBATCH --output=/home-mscluster/onailana/ASR-LCM-Research/training_final.log[m[48;5;242m [m
[96m[48;5;242m#SBATCH --partition=biggpu[m[48;5;242m [m
[96m[48;5;242m#SBATCH --nodes=1[m[48;5;242m 
 [m
[96m[48;5;242m# ------------------------------[m[48;5;242m [m
[96m[48;5;242m# Environment[m[48;5;242m [m
[96m[48;5;242m# ------------------------------[m[48;5;242m [m
[93m[48;5;242msource[m[48;5;242m ~/.bashrc [m
[93m[48;5;242mecho[m[95m[48;5;242m [m[93m[48;5;242m"[m[95m[48;5;242mActivating virtual environment...[m[93m[48;5;242m"[m[48;5;242m 
conda activate env 
 [m
[93m[48;5;242mecho[m[95m[48;5;242m [m[93m[48;5;242m"[m[95m[48;5;242mStarting LCM training with DDP[m[93m[48;5;242m"[m[48;5;242m 
 [m
[93m[48;5;242mexport[m[48;5;242m [m[1m[96m[48;5;242mNCCL_BLOCKING_WAIT[m[48;5;242m=[m[95m[48;5;242m1[m[48;5;242m [m
[93m[48;5;242mexport[m[48;5;242m [m[1m[96m[48;5;242mNCCL_ASYNC_ERROR_HANDLING[m[48;5;242m=[m[95m[48;5;242m1[m[48;5;242m [m
[93m[48;5;242mexport[m[48;5;242m [m[1m[96m[48;5;242mTORCH_DISTRIBUTED_DEBUG[m[48;5;242m=DETAIL [m
[93m[48;5;242mexport[m[48;5;242m [m[1m[96m[48;5;242mPYTORCH_CUDA_ALLOC_CONF[m[48;5;242m=max_split_size_mb:128 
 [m
[96m[48;5;242m# ------------------------------[m[48;5;242m [m
[96m[48;5;242m# Run training[m[48;5;242m [m
[96m[48;5;242m# ------------------------------[m[48;5;242m 
torchrun [m[38;5;224m[48;5;242m--nproc_per_node[m[93m[48;5;242m=[m[95m[48;5;242m2[m[48;5;242m ~/ASR-LCM-Research/training5.py [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--csv_path[m[48;5;242m /datasets/onailana/codes/code_data.csv [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--val_csv_path[m[48;5;242m /datasets/onailana/test_codes/test_code_data.csv [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--d_model[m[48;5;242m [m[95m[48;5;242m256[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--n_heads[m[48;5;242m [m[95m[48;5;242m8[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--num_layers[m[48;5;242m [m[95m[48;5;242m6[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--batch_size[m[48;5;242m [m[95m[48;5;242m2[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--val_batch_size[m[48;5;242m [m[95m[48;5;242m2[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--epochs[m[48;5;242m [m[95m[48;5;242m1500[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--lr[m[48;5;242m 1e-4 [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--checkpoint_dir[m[48;5;242m /datasets/onailana/checkpoints3 [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--lambda_waveform[m[48;5;242m [m[95m[48;5;242m0[m[48;5;242m.[m[95m[48;5;242m5[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--lambda_stft[m[48;5;242m [m[95m[48;5;242m0[m[48;5;242m.[m[95m[48;5;242m5[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--wandb_project[m[48;5;242m [m[93m[48;5;242m"[m[95m[48;5;242mlcm-distill[m[93m[48;5;242m"[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--resume[m[48;5;242m [m[95m[48;5;242m1[m[48;5;242m [m[93m[48;5;242m\[m[48;5;242m 
    [m[38;5;224m[48;5;242m--log_grads[m[48;5;242m 
 [m[55;185H1,1   [1;1H[?25h[?25l[55;175Hd [1;1H[55;175H [1;1H[1;1H[K[2;1H[94m~                                                                                                                                                                                                         [3;1H~                                                                                                                                                                                                         [4;1H~                                                                                                                                                                                                         [5;1H~                                                                                                                                                                                                         [6;1H~                                                                                                                                                                                                         [7;1H~                                                                                                                                                                                                         [8;1H~                                                                                                                                                                                                         [9;1H~                                                                                                                                                                                                         [10;1H~                                                                                                                                                                                                         [11;1H~                                                                                                                                                                                                         [12;1H~                                                                                                                                                                                                         [13;1H~                                                                                                                                                                                                         [14;1H~                                                                                                                                                                                                         [15;1H~                                                                                                                                                                                                         [16;1H~                                                                                                                                                                                                         [17;1H~                                                                                                                                                                                                         [18;1H~                                                                                                                                                                                                         [19;1H~                                                                                                                                                                                                         [20;1H~                                                                                                                                                                                                         [21;1H~                                                                                                                                                                                                         [22;1H~                                                                                                                                                                                                         [23;1H~                                                                                                                                                                                                         [24;1H~                                                                                                                                                                                                         [25;1H~                                                                                                                                                                                                         [26;1H~                                                                                                                                                                                                         [27;1H~                                                                                                                                                                                                         [28;1H~                                                                                                                                                                                                         [29;1H~                                                                                                                                                                                                         [30;1H~                                                                                                                                                                                                         [31;1H~                                                                                                                                                                                                         [32;1H~                                                                                                                                                                                                         [33;1H~                                                                                                                                                                                                         [34;1H~                                                                                                                                                                                                         [35;1H~                                                                                                                                                                                                         [36;1H~                                                                                                                                                                                                         [37;1H~                                                                                                                                                                                                         [38;1H~                                                                                                                                                                                                         [39;1H~                                                                                                                                                                                                         [40;1H~                                                                                                                                                                                                         [m[55;1H[K[55;185H0,0-1[9CAll--No lines in buffer--[55;185H[K[55;185H0,0-1[9CAll[1;1H[?25h[?25l[55;1H[1m-- INSERT --[m[55;13H[K[55;185H0,1[11CAll[1;1H[96m#!/bin/bash
#SBATCH --job-name=Latent-Training-Final[m[2;41H[K[3;1H[96m#SBATCH --[m[3;11H[K[3;11H[?25h[?25l[96moutput=/home-mscluster/onailana/ASR-LCM-Research/training_final.log[?25h[?25l
#SBATCH --partition=biggpu[m[4;27H[K[5;1H[96m#SBATCH --nodes=1[m[5;18H[K[6;1H[96m#SBATCH --ntasks-per[m[6;21H[K[6;21H[?25h[?25l[96m-node=2          # one task per GPU
#SBATCH --gpus-per-node=2    [m[7;30H[K[7;30H[?25h[?25l[96m        # request both GPUs
#SBATCH --time=48:00:00             [m[8;37H[K[8;37H[?25h[?25l[96m # just in case; prevents job kill
#SBATCH --mem=0              [m[9;30H[K[9;30H[?25h[?25l[96m        # use all available memory[m[10;1H[K[11;1H[96m# --------------------------[m[11;29H[K[11;29H[?25h[?25l[96m----
# Environment setup[m[12;20H[K[13;1H[96m# ------------------------------[m[13;33H[K[14;1Hsourc[14;6H[K[14;6H[?25h[?25l[93msource[m ~/.bashrc
[93mecho[m[95m [m[93m"[m[95mActivating virtual environment...[m[93m"[m[15;41H[K[16;1Hconda acti[16;11H[K[16;11H[?25h[?25lvate env[17;1H[K[18;1H[93mecho[m[95m [m[93m"[m[95mStarting Latent Consistency Model training (DDP[m[18;54H[K[18;54H[?25h[?25l[95m mode)[m[93m"[m[19;1H[K[20;1H[96m# ------------------------------[m[20;33H[K[21;1H[96m# NCCL + Torch Distri[m[21;22H[K[21;22H[?25h[?25l[96mbuted config
# ------------------------------[m[22;33H[K[23;1H[93mexport[m NCCL_DEBUG[23;18H[K[23;18H[?25h[?25l[23;8H[1m[96mNCCL_DEBUG[m=INFO
[93mexport[m [1m[96mNCCL_BLOCKING_WAIT[m=[95m1[m[24;28H[K[25;1H[93mexport[m NCCL_ASYNC_ERROR_HANDL[25;30H[K[25;30H[?25h[?25l[25;8H[1m[96mNCCL_ASYNC_ERROR_HANDLING[m=[95m1[m
[93mexport[m [1m[96mTORCH_DISTRIBUTED_DEBUG[m=DETAIL[26;38H[K[27;1H[93mexport[m PYTHONFAULTH[27;20H[K[27;20H[?25h[?25l[27;8H[1m[96mPYTHONFAULTHANDLER[m=[95m1[m
[93mexport[m [1m[96mOMP_NUM_THREADS[m=[95m8[m[28;25H[K[29;1H[93mexport[m PYTORCH_CUDA_ALLOC_CON[29;30H[K[29;30H[?25h[?25l[29;8H[1m[96mPYTORCH_CUDA_ALLOC_CONF[m=max_split_size_mb:128[30;1H[K[31;1H[96m# ------------------------------[m[31;33H[K[32;1H[96m#[m[32;2H[K[32;2H[?25h[?25l[96m Sanity echo
# ------------------------------[m[33;33H[K[34;1H[93mecho[m[95m [m[93m"[m[95mJob Node: [m[38;5;81m$([m[38;5;224mh[m[34;20H[K[34;20H[?25h[?25l[38;5;224mostname[m[38;5;81m)[m[93m"
echo[m[95m [m[93m"[m[95mGPUs available: [m[38;5;81m$CUDA_VISIBLE_DEVICES[m[93m"[m[35;45H[K[36;1Hnvidia-sm[36;10H[K[36;10H[?25h[?25li[37;1H[K[38;1H[96m# ------------------------------[m[38;33H[K[39;1H[96m# Run distributed training[m[39;27H[K[40;1H[96m#[m[40;2H[K[40;2H[?25h[?25l[96m ------------------------------[m
torchrun [38;5;224m--standalone[m [38;5;224m--nproc_p[m[41;32H[K[41;32H[?25h[?25l[38;5;224mer_node[m[93m=[m[95m2[m ~/ASR-LCM-Research/training5.py [93m\[m
    [38;5;224m--csv_path[m /dat[42;20H[K[42;20H[?25h[?25lasets/onailana/codes/code_data.csv [93m\[m
    [38;5;224m--val_csv_path[m /datase[43;27H[K[43;27H[?25h[?25lts/onailana/test_codes/test_code_data.csv [93m\[m
    [38;5;224m--d_model[m [95m256[m [93m\[m[44;20H[K[44;20H[?25h[?25l
    [38;5;224m--n_heads[m [95m8[m [93m\[m[45;18H[K[46;1H    [38;5;224m--num_layers[m [95m6[m [93m\[m[46;21H[K[47;1H    [38;5;224m--batch_size[m [95m2[m [93m\[m[47;21H[K[48;1H  [48;3H[K[48;3H[?25h[?25l  [38;5;224m--val_batch_size[m [95m2[m [93m\[m
    [38;5;224m--epochs[m [95m1500[m [93m\[m[49;20H[K[50;1H    [38;5;224m--lr[m 1e-4 [93m\[m[50;16H[K[51;1H    [51;5H[K[51;5H[?25h[?25l[38;5;224m--checkpoint_dir[m /datasets/onailana/checkpoints3 [93m\[m
    [38;5;224m--lambda[m[52;13H[K[52;13H[?25h[?25l[38;5;224m_waveform[m [95m0[m.[95m5[m [93m\[m
    [38;5;224m--lambda_stft[m [95m0[m.[95m5[m [93m\[m[53;24H[K[54;1H    [38;5;224m--wandb_project[m [93m"[m[95mlc[m[54;24H[K[54;24H[?25h[?25l[95mm-distill[m[93m"[m [93m\[54;17H[?25h[?25l[1;54r[m[1;1H[4M[1;55r[51;5H[38;5;224m--resume[m [95m1[m [93m\[m
    [38;5;224m--log_grads[m

[96m# ------------------------------[m[55;11H[1m(paste) --[m[55;185H[K[54;28H[?25h[?25l[55;1H[K[1;54r[1;1H[4M[1;55r[51;1H[96m# Post-job cleanup
# ------------------------------[m
[93mecho[m[95m [m[93m"[m[95mTraining complete at [m[38;5;81m$([m[38;5;224mdate[m[38;5;81m)[m[93m"[m[55;185H62,0-1[8CBot[54;1H[?25h[?25l[55;175Hg[54;1H[?25h[?25l[55;175H [54;1H[55;175Hgg[54;1H[55;175H  [1;1H[1;54r[1;1H[8L[1;55r[1;1H[96m#!/bin/bash
#SBATCH --job-name=Latent-Training-Final
#SBATCH --output=/home-mscluster/onailana/ASR-LCM-Research/training_final.log
#SBATCH --partition=biggpu
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=2          # one task per GPU
#SBATCH --gpus-per-node=2            # request both GPUs
#SBATCH --time=48:00:00              # just in case; prevents job kill[m[55;185H[K[55;185H1,1[11CTop[1;1H[?25h[?25l[55;175H~@k[1;1H[55;175H   [2;1H[55;185H2[2;1H[?25h[?25l[55;175H~@k[2;1H[55;175H   [3;1H[55;185H3[3;1H[?25h[?25l[55;175H~@k[3;1H[55;175H   [4;1H[55;185H4[4;1H[?25h[?25l[55;175H~@k[4;1H[55;175H   [5;1H[55;185H5[5;1H[?25h[?25l[55;175H~@k[5;1H[55;175H   [6;1H[55;185H6[6;1H[?25h[?25l[55;175Hd[6;1H[?25h[?25l[55;176Hd[6;1H[55;175H  [6;1H[6;54r[54;1H
[1;55r[54;5H[38;5;224m--resume[m [95m1[m [93m\[m[55;185H[K[55;185H6,1[11CTop[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [7;1H[55;185H7[7;1H[?25h[?25l[55;175H~@k[7;1H[55;175H   [6;1H[55;185H6[6;1H[?25h[?25l[55;175Hd[6;1H[?25h[?25l[55;176Hd[6;1H[55;175H  [6;1H[6;54r[54;1H
[1;55r[54;5H[38;5;224m--log_grads[m[55;185H[K[55;185H6,1[11CTop[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [7;1H[55;185H7[7;1H[?25h[?25l[55;175H~@k[7;1H[55;175H   [8;1H[55;185H8,0-1[8;1H[?25h[?25l[55;175H~@k[8;1H[55;175H   [7;1H[55;185H7,1  [7;1H[?25h[?25l[55;175H^[[7;1H[55;175H  [7;1H[55;175H^[[7;1H[55;175H  [7;1H[?25h[?25l[55;175H:[7;1H[55;175H[K[55;1H:[?25hwq[?25l[?2004l[>4;m"exec_lcm_training3.sh" 60L, 1769B written[23;2t[23;1t
[?1004l[?2004l[?1l>[?25h[>4;m[?1049l[23;0;0t[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ sb[K[Ksbatch exec_lcm_training
[?2004lsbatch: error: Unable to open file exec_lcm_training
[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ sbatch exec_lcm_training.[K3.sh 
[?2004lSubmitted batch job 163420
[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ sbatch exec_lcm_training3.sh [Kvim exec_lcm_training3.sh cat[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[1@l[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[Clear[Kvim exec_lcm_training.sh [5P../training5.py[Ccat[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[Clear[Kvim ../training5.py [6Plcm[C[C[C[C[12@exec_lcm_training3.sh[C[16Pcd scriptsat lcm.py [6Plearvim lcm3.py [1P[C[C[C[C[1@3[C[C[C[C[1P[C[C[C[Ccd ASR-LCM-Research/lear[Ktmux a-a[Kail -n 30 -f ../training_final.log [7Psbatch exec_lcm_training3.sh[C[15Pcancel 1634102[8Pqueuecancel 1634120batch exec_lcm_training3.sh [7@tail -n 30 -f ../training_final.log[C
[?2004lActivating virtual environment...
Starting Latent Consistency Model training (DDP mode)
Job Node: mscluster106.ms.wits.ac.za
GPUs available: 
Thu Oct 16 07:10:01 2025       
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 565.57.01              Driver Version: 565.57.01      CUDA Version: 12.7     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  Quadro RTX 8000                Off |   00000000:17:00.0 Off |                  Off |
| 34%   53C    P5             39W /  260W |       4MiB /  49152MiB |      0%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+
|   1  Quadro RTX 8000                Off |   00000000:73:00.0 Off |                  Off |
| 33%   56C    P8             27W /  260W |       4MiB /  49152MiB |      0%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+
                                                                                         
+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|  No running processes found                                                             |
+-----------------------------------------------------------------------------------------+
[2025-10-16 07:10:10,455] torch.distributed.run: [WARNING] master_addr is only used for static rdzv_backend and when rdzv_endpoint is not specified.
mscluster106:3312360:3312360 [0] NCCL INFO Bootstrap : Using enp0s31f6:10.100.14.106<0>
mscluster106:3312360:3312360 [0] NCCL INFO NET/Plugin : Plugin load (libnccl-net.so) returned 2 : libnccl-net.so: cannot open shared object file: No such file or directory
mscluster106:3312360:3312360 [0] NCCL INFO NET/Plugin : No plugin found, using internal implementation
mscluster106:3312360:3312360 [0] NCCL INFO cudaDriverVersion 12070
NCCL version 2.18.1+cuda12.1
mscluster106:3312361:3312361 [1] NCCL INFO cudaDriverVersion 12070
mscluster106:3312361:3312361 [1] NCCL INFO Bootstrap : Using enp0s31f6:10.100.14.106<0>
mscluster106:3312361:3312361 [1] NCCL INFO NET/Plugin : Plugin load (libnccl-net.so) returned 2 : libnccl-net.so: cannot open shared object file: No such file or directory
mscluster106:3312361:3312361 [1] NCCL INFO NET/Plugin : No plugin found, using internal implementation
mscluster106:3312361:3312413 [1] NCCL INFO NET/IB : No device found.
mscluster106:3312360:3312412 [0] NCCL INFO NET/IB : No device found.
mscluster106:3312361:3312413 [1] NCCL INFO NET/Socket : Using [0]enp0s31f6:10.100.14.106<0>
mscluster106:3312360:3312412 [0] NCCL INFO NET/Socket : Using [0]enp0s31f6:10.100.14.106<0>
mscluster106:3312361:3312413 [1] NCCL INFO Using network Socket
mscluster106:3312360:3312412 [0] NCCL INFO Using network Socket
mscluster106:3312360:3312412 [0] NCCL INFO Setting affinity for GPU 0 to 0fffff,ff000000,0fffffff
mscluster106:3312361:3312413 [1] NCCL INFO Setting affinity for GPU 1 to 0fffff,ff000000,0fffffff
mscluster106:3312360:3312412 [0] NCCL INFO Channel 00/04 :    0   1
mscluster106:3312361:3312413 [1] NCCL INFO Trees [0] -1/-1/-1->1->0 [1] 0/-1/-1->1->-1 [2] -1/-1/-1->1->0 [3] 0/-1/-1->1->-1
mscluster106:3312360:3312412 [0] NCCL INFO Channel 01/04 :    0   1
mscluster106:3312361:3312413 [1] NCCL INFO P2P Chunksize set to 524288
mscluster106:3312360:3312412 [0] NCCL INFO Channel 02/04 :    0   1
mscluster106:3312360:3312412 [0] NCCL INFO Channel 03/04 :    0   1
mscluster106:3312360:3312412 [0] NCCL INFO Trees [0] 1/-1/-1->0->-1 [1] -1/-1/-1->0->1 [2] 1/-1/-1->0->-1 [3] -1/-1/-1->0->1
mscluster106:3312360:3312412 [0] NCCL INFO P2P Chunksize set to 524288
mscluster106:3312360:3312412 [0] NCCL INFO Channel 00/0 : 0[17000] -> 1[73000] via P2P/IPC
mscluster106:3312361:3312413 [1] NCCL INFO Channel 00/0 : 1[73000] -> 0[17000] via P2P/IPC
mscluster106:3312360:3312412 [0] NCCL INFO Channel 01/0 : 0[17000] -> 1[73000] via P2P/IPC
mscluster106:3312361:3312413 [1] NCCL INFO Channel 01/0 : 1[73000] -> 0[17000] via P2P/IPC
mscluster106:3312360:3312412 [0] NCCL INFO Channel 02/0 : 0[17000] -> 1[73000] via P2P/IPC
mscluster106:3312361:3312413 [1] NCCL INFO Channel 02/0 : 1[73000] -> 0[17000] via P2P/IPC
mscluster106:3312360:3312412 [0] NCCL INFO Channel 03/0 : 0[17000] -> 1[73000] via P2P/IPC
mscluster106:3312361:3312413 [1] NCCL INFO Channel 03/0 : 1[73000] -> 0[17000] via P2P/IPC
mscluster106:3312360:3312412 [0] NCCL INFO Connected all rings
mscluster106:3312361:3312413 [1] NCCL INFO Connected all rings
mscluster106:3312360:3312412 [0] NCCL INFO Connected all trees
mscluster106:3312361:3312413 [1] NCCL INFO Connected all trees
mscluster106:3312361:3312413 [1] NCCL INFO threadThresholds 8/8/64 | 16/8/64 | 512 | 512
mscluster106:3312361:3312413 [1] NCCL INFO 4 coll channels, 0 nvls channels, 4 p2p channels, 4 p2p channels per peer
mscluster106:3312360:3312412 [0] NCCL INFO threadThresholds 8/8/64 | 16/8/64 | 512 | 512
mscluster106:3312360:3312412 [0] NCCL INFO 4 coll channels, 0 nvls channels, 4 p2p channels, 4 p2p channels per peer
mscluster106:3312360:3312412 [0] NCCL INFO comm 0x9260fb0 rank 0 nranks 2 cudaDev 0 busId 17000 commId 0xad444054de835e6b - Init COMPLETE
mscluster106:3312361:3312413 [1] NCCL INFO comm 0x93e2ac0 rank 1 nranks 2 cudaDev 1 busId 73000 commId 0xad444054de835e6b - Init COMPLETE
[DDP] Initialized with 2 processes
Detected 32 codebooks from dataset sample
[DDP] Model wrapped successfully
2025-10-16 07:10:23 | INFO | Logging to /datasets/onailana/checkpoints3/train_20251016_071023_rank1.log (rank 1)
2025-10-16 07:10:23 | INFO | Logging to /datasets/onailana/checkpoints3/train_20251016_071023_rank0.log (rank 0)
2025-10-16 07:10:23 | ERROR | Uncaught exception on rank 1
Traceback (most recent call last):
  File "/home-mscluster/onailana/ASR-LCM-Research/training5.py", line 111, in <module>
    main()
  File "/home-mscluster/onailana/ASR-LCM-Research/training5.py", line 87, in main
    train(
  File "/home-mscluster/onailana/ASR-LCM-Research/lcm.py", line 232, in train
    train_loader = make_train_loader()
  File "/home-mscluster/onailana/ASR-LCM-Research/lcm.py", line 230, in make_train_loader
    return DataLoader(dataset, batch_size=args.per_step_batch_size, sampler=train_sampler, collate_fn=collate_fn)
AttributeError: 'Namespace' object has no attribute 'per_step_batch_size'
2025-10-16 07:10:23 | ERROR | Uncaught exception on rank 0
Traceback (most recent call last):
  File "/home-mscluster/onailana/ASR-LCM-Research/training5.py", line 111, in <module>
    main()
  File "/home-mscluster/onailana/ASR-LCM-Research/training5.py", line 87, in main
    train(
  File "/home-mscluster/onailana/ASR-LCM-Research/lcm.py", line 232, in train
    train_loader = make_train_loader()
  File "/home-mscluster/onailana/ASR-LCM-Research/lcm.py", line 230, in make_train_loader
    return DataLoader(dataset, batch_size=args.per_step_batch_size, sampler=train_sampler, collate_fn=collate_fn)
AttributeError: 'Namespace' object has no attribute 'per_step_batch_size'
mscluster106:3312360:3312415 [0] NCCL INFO [Service thread] Connection closed by localRank 0
mscluster106:3312361:3312414 [1] NCCL INFO [Service thread] Connection closed by localRank 1
mscluster106:3312360:3312360 [0] NCCL INFO comm 0x9260fb0 rank 0 nranks 2 cudaDev 0 busId 17000 - Abort COMPLETE
mscluster106:3312361:3312361 [1] NCCL INFO comm 0x93e2ac0 rank 1 nranks 2 cudaDev 1 busId 73000 - Abort COMPLETE
[2025-10-16 07:10:25,729] torch.distributed.elastic.multiprocessing.api: [ERROR] failed (exitcode: 1) local_rank: 0 (pid: 3312360) of binary: /home-mscluster/onailana/miniconda3/envs/env/bin/python3.9
Traceback (most recent call last):
  File "/home-mscluster/onailana/miniconda3/envs/env/bin/torchrun", line 7, in <module>
    sys.exit(main())
  File "/home-mscluster/onailana/miniconda3/envs/env/lib/python3.9/site-packages/torch/distributed/elastic/multiprocessing/errors/__init__.py", line 346, in wrapper
    return f(*args, **kwargs)
  File "/home-mscluster/onailana/miniconda3/envs/env/lib/python3.9/site-packages/torch/distributed/run.py", line 806, in main
    run(args)
  File "/home-mscluster/onailana/miniconda3/envs/env/lib/python3.9/site-packages/torch/distributed/run.py", line 797, in run
    elastic_launch(
  File "/home-mscluster/onailana/miniconda3/envs/env/lib/python3.9/site-packages/torch/distributed/launcher/api.py", line 134, in __call__
    return launch_agent(self._config, self._entrypoint, list(args))
  File "/home-mscluster/onailana/miniconda3/envs/env/lib/python3.9/site-packages/torch/distributed/launcher/api.py", line 264, in launch_agent
    raise ChildFailedError(
torch.distributed.elastic.multiprocessing.errors.ChildFailedError: 
============================================================
/home-mscluster/onailana/ASR-LCM-Research/training5.py FAILED
------------------------------------------------------------
Failures:
[1]:
  time      : 2025-10-16_07:10:25
  host      : mscluster106.ms.wits.ac.za
  rank      : 1 (local_rank: 1)
  exitcode  : 1 (pid: 3312361)
  error_file: <N/A>
  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html
------------------------------------------------------------
Root Cause (first observed failure):
[0]:
  time      : 2025-10-16_07:10:25
  host      : mscluster106.ms.wits.ac.za
  rank      : 0 (local_rank: 0)
  exitcode  : 1 (pid: 3312360)
  error_file: <N/A>
  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html
============================================================
Training complete at Thu Oct 16 07:10:26 AM SAST 2025
^C
[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ tail -n 30 -f ../training_final.log [Kvk[Kim ../ltr[K[K[Ktraai[K[Kining5.py 
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;55r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[55;1H"../training5.py" 112L, 3931B[2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[1;5Hargs.n_codebooks = n_codebooks
    [38;5;130mif[m rank == [31m0[m:[2;18H[K[3;1H        [36mprint[m(f[31m"Detected {n_codebooks} codebooks from dataset sample"[m)[3;71H[K[5;5H[34m# ------------------------------
[m    [34m# Model Init
[m    [34m# ------------------------------[m
    model = LCM_MCB([9;9Hvocab_size=[31m1024[m,[10;9Hn_codebooks=n_codebooks,[11;9Hd_model=args.d_model,[12;9Hn_heads=args.n_heads,[13;9Hnum_layers=args.num_layers
    ).to(device)[16;5H[38;5;130mif[m is_ddp:[17;9Hmodel = torch.nn.parallel.DistributedDataParallel([18;13Hmodel,[19;13Hdevice_ids=[local_rank],[20;13Houtput_device=local_rank,[21;13Hfind_unused_parameters=[36mFalse[m[22;9H)[23;9H[38;5;130mif[m rank == [31m0[m:[24;13H[36mprint[m([31m"[DDP] Model wrapped successfully"[m)[26;5H[34m# ------------------------------
[m    [34m# Start Training
[m    [34m# ------------------------------[m
    train([30;9Hdataset=dataset,[31;9Hval_dataset=val_dataset,[32;9Hmodel=model,[33;9Htrain_sampler=sampler,[34;9Hargs=args,[35;9Hdevice=device,[36;9Hrank=rank,[37;9Hlocal_rank=local_rank,[38;9Hworld_size=world_size,[39;9His_ddp=is_ddp,
    )[42;5H[34m# ------------------------------
[m    [34m# Cleanup
[m    [34m# ------------------------------[m
    [38;5;130mif[m is_ddp:[46;9Hdist.barrier()[47;9Hdist.destroy_process_group()[48;9H[38;5;130mif[m rank == [31m0[m:[49;13H[36mprint[m([31m"[DDP] Cleanup complete"[m)

[38;5;130mif[m __name__ == [31m"__main__"[m:
    torch.multiprocessing.set_start_method([31m"spawn"[m, force=[36mTrue[m)
    main()[55;185H112,0-1[7CBot[54;1H[?25h[27m[23m[29m[m[H[2J[?25l[1;5Hargs.n_codebooks = n_codebooks
    [93mif[m rank == [95m0[m:[3;9H[1m[96mprint[m(f[95m"Detected {n_codebooks} codebooks from dataset sample"[m)[5;5H[96m# ------------------------------
[m    [96m# Model Init
[m    [96m# ------------------------------[m
    model = LCM_MCB([9;9Hvocab_size=[95m1024[m,[10;9Hn_codebooks=n_codebooks,[11;9Hd_model=args.d_model,[12;9Hn_heads=args.n_heads,[13;9Hnum_layers=args.num_layers
    ).to(device)[16;5H[93mif[m is_ddp:[17;9Hmodel = torch.nn.parallel.DistributedDataParallel([18;13Hmodel,[19;13Hdevice_ids=[local_rank],[20;13Houtput_device=local_rank,[21;13Hfind_unused_parameters=[1m[96mFalse[m[22;9H)[23;9H[93mif[m rank == [95m0[m:[24;13H[1m[96mprint[m([95m"[DDP] Model wrapped successfully"[m)[26;5H[96m# ------------------------------
[m    [96m# Start Training
[m    [96m# ------------------------------[m
    train([30;9Hdataset=dataset,[31;9Hval_dataset=val_dataset,[32;9Hmodel=model,[33;9Htrain_sampler=sampler,[34;9Hargs=args,[35;9Hdevice=device,[36;9Hrank=rank,[37;9Hlocal_rank=local_rank,[38;9Hworld_size=world_size,[39;9His_ddp=is_ddp,
    )[42;5H[96m# ------------------------------
[m    [96m# Cleanup
[m    [96m# ------------------------------[m
    [93mif[m is_ddp:[46;9Hdist.barrier()[47;9Hdist.destroy_process_group()[48;9H[93mif[m rank == [95m0[m:[49;13H[1m[96mprint[m([95m"[DDP] Cleanup complete"[m)

[93mif[m __name__ == [95m"__main__"[m:
    torch.multiprocessing.set_start_method([95m"spawn"[m, force=[1m[96mTrue[m)
    main()[55;185H112,0-1[7CBot"../training5.py" 112L, 3931B[54;1H[?25h[?25l[55;175Hg[54;1H[?25h[?25l[55;175H [54;1H[55;175Hgg[54;1H[55;175H  [1;1H[27m[23m[29m[m[H[2J[1;1H[96m#!/usr/bin/env python3[m
[38;5;81mimport[m os
[38;5;81mimport[m argparse
[38;5;81mimport[m torch
[38;5;81mimport[m torch.distributed [93mas[m dist
[38;5;81mfrom[m torch.utils.data [38;5;81mimport[m DistributedSampler
[38;5;81mfrom[m lcm [38;5;81mimport[m train, LCM_MCB
[38;5;81mfrom[m dataset [38;5;81mimport[m LCMDistillDataset

[93mdef[m [1m[96mmain[m():
    parser = argparse.ArgumentParser()
    parser.add_argument([95m"--csv_path"[m, [1m[96mtype[m=[1m[96mstr[m, required=[1m[96mTrue[m)
    parser.add_argument([95m"--val_csv_path"[m, [1m[96mtype[m=[1m[96mstr[m, default=[1m[96mNone[m)
    parser.add_argument([95m"--d_model"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m256[m)
    parser.add_argument([95m"--n_heads"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m8[m)
    parser.add_argument([95m"--num_layers"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m8[m)
    parser.add_argument([95m"--batch_size"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m2[m)
    parser.add_argument([95m"--val_batch_size"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m2[m)
    parser.add_argument([95m"--epochs"[m, [1m[96mtype[m=[1m[96mint[m, default=[95m1500[m)
    parser.add_argument([95m"--lr"[m, [1m[96mtype[m=[1m[96mfloat[m, default=[95m1e-4[m)
    parser.add_argument([95m"--checkpoint_dir"[m, [1m[96mtype[m=[1m[96mstr[m, default=[95m"/datasets/onailana/checkpoints3"[m)
    parser.add_argument([95m"--lambda_waveform"[m, [1m[96mtype[m=[1m[96mfloat[m, default=[95m0.5[m)
    parser.add_argument([95m"--lambda_stft"[m, [1m[96mtype[m=[1m[96mfloat[m, default=[95m0.5[m)
    parser.add_argument([95m"--wandb_project"[m, [1m[96mtype[m=[1m[96mstr[m, default=[95m"lcm-training"[m)
    parser.add_argument([95m"--log_grads"[m, action=[95m"store_true"[m)
    parser.add_argument([95m"--resume"[m, [1m[96mtype[m=[1m[96mint[m, choices=[[95m0[m, [95m1[m], default=[95m0[m)
    parser.add_argument([95m"--weight_decay"[m, [1m[96mtype[m=[1m[96mfloat[m, default=[95m0.0[m)
    args = parser.parse_args()[30;5H[96m# ------------------------------
[m    [96m# Distributed Setup
[m    [96m# ------------------------------[m
    local_rank = [1m[96mint[m(os.environ.get([95m"LOCAL_RANK"[m, [95m0[m))
    rank = [1m[96mint[m(os.environ.get([95m"RANK"[m, [95m0[m))
    world_size = [1m[96mint[m(os.environ.get([95m"WORLD_SIZE"[m, [95m1[m))
    is_ddp = world_size > [95m1[m[38;5Htorch.cuda.set_device(local_rank)
    device = torch.device(f[95m"cuda:{local_rank}"[m [93mif[m torch.cuda.is_available() [93melse[m [95m"cpu"[m)[41;5H[93mif[m is_ddp:[42;9Hdist.init_process_group(backend=[95m"nccl"[m, init_method=[95m"env://"[m)[43;9Htorch.distributed.barrier()[44;9H[93mif[m rank == [95m0[m:[45;13H[1m[96mprint[m(f[95m"[DDP] Initialized with {world_size} processes"[m)[47;5H[96m# ------------------------------
[m    [96m# Dataset Loading
[m    [96m# ------------------------------[m
    dataset = LCMDistillDataset(args.csv_path)
    sampler = DistributedSampler(dataset, num_replicas=world_size, rank=rank, shuffle=[1m[96mTrue[m) [93mif[m is_ddp [93melse[m [1m[96mNone[m[53;5Hval_dataset = LCMDistillDataset(args.val_csv_path) [93mif[m args.val_csv_path [93melse[m [1m[96mNone[m[55;185H1,1[11CTop[1;1H[?25h[?25l[55;175H~@k[1;1H[55;175H   [1;1H[?25h[?25l[55;175H~@k[1;1H[55;175H   [2;1H[55;185H2[2;1H[?25h[?25l[55;175H~@k[2;1H[55;175H   [3;1H[55;185H3[3;1H[?25h[?25l[55;175H~@k[3;1H[55;175H   [4;1H[55;185H4[4;1H[?25h[?25l[55;175H~@k[4;1H[55;175H   [5;1H[55;185H5[5;1H[?25h[?25l[55;175H~@k[5;1H[55;175H   [6;1H[55;185H6[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [7;1H[55;185H7[7;1H[?25h[?25l[55;175H~@k[7;1H[55;175H   [8;1H[55;185H8[8;1H[?25h[?25l[55;175H~@k[8;1H[55;175H   [9;1H[55;185H9,0-1[9;1H[?25h[?25l[55;175H~@k[9;1H[55;175H   [10;1H[55;185H10,1 [10;1H[?25h[?25l[55;175H~@k[10;1H[55;175H   [11;1H[55;186H1[11;1H[?25h[?25l[55;175H~@k[11;1H[55;175H   [12;1H[55;186H2[12;1H[?25h[?25l[55;175H~@k[12;1H[55;175H   [13;1H[55;186H3[13;1H[?25h[?25l[55;175H~@k[13;1H[55;175H   [14;1H[55;186H4[14;1H[?25h[?25l[55;175H~@k[14;1H[55;175H   [15;1H[55;186H5[15;1H[?25h[?25l[55;186H6[16;1H[?25h[?25l[55;186H7[17;1H[?25h[?25l[55;186H8[18;1H[?25h[?25l[55;175H~@k[18;1H[55;175H   [19;1H[55;186H9[19;1H[?25h[?25l[55;185H20[20;1H[?25h[?25l[55;186H1[21;1H[?25h[?25l[55;175H~@k[21;1H[55;175H   [22;1H[55;186H2[22;1H[?25h[?25l[55;186H3[23;1H[?25h[?25l[55;186H4[24;1H[?25h[?25l[55;175H~@k[24;1H[55;175H   [25;1H[55;186H5[25;1H[?25h[?25l[55;186H6[26;1H[?25h[?25l[55;186H7[27;1H[?25h[?25l[55;186H8[28;1H[?25h[?25l[55;186H9,0-1[29;1H[?25h[?25l[55;185H30,1  [30;1H[?25h[?25l[55;186H1[31;1H[?25h[?25l[55;186H2[32;1H[?25h[?25l[55;186H3[33;1H[?25h[?25l[55;186H4[34;1H[?25h[?25l[55;186H5[35;1H[?25h[?25l[55;186H6[36;1H[?25h[?25l[55;186H7,0-1[37;1H[?25h[?25l[55;186H8,1  [38;1H[?25h[?25l[55;186H9[39;1H[?25h[?25l[55;185H40,0-1[40;1H[?25h[?25l[55;186H1,1  [41;1H[?25h[?25l[55;186H2[42;1H[?25h[?25l[55;175H~@k[42;1H[55;175H   [43;1H[55;186H3[43;1H[?25h[?25l[55;186H4[44;1H[?25h[?25l[55;186H5[45;1H[?25h[?25l[55;186H6,0-1[46;1H[?25h[?25l[55;186H7,1  [47;1H[?25h[?25l[55;186H8[48;1H[?25h[?25l[55;186H9[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# Infer number of codebooks from one sample[m[55;185H[K[55;185H50,1[11C1%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hfirst_path = dataset.df.iloc[[95m0[m][[95m"filepath"[m][55;185H[K[55;185H51,1[11C3%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hsample_data = torch.load(first_path, map_location=[95m"cpu"[m)[55;185H[K[55;185H52,0-1[9C5%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hn_codebooks = sample_data[[95m"degraded"[m].shape[[95m1[m][55;185H[K[55;185H53,1[11C6%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hargs.n_codebooks = n_codebooks[55;185H[K[55;185H54,0-1[9C8%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m rank == [95m0[m:[55;185H[K[55;185H55,1[10C10%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[1m[96mprint[m(f[95m"Detected {n_codebooks} codebooks from dataset sample"[m)[55;185H[K[55;185H56,1[10C12%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H57,1[10C13%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[96m# ------------------------------[m[55;185H[K[55;185H58,1[10C15%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# Model Init[m[55;185H[K[55;185H59,1[10C17%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# ------------------------------[m[55;185H[K[55;185H60,1[10C18%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmodel = LCM_MCB([55;185H[K[55;185H61,1[10C20%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hvocab_size=[95m1024[m,[55;185H[K[55;185H62,0-1[8C22%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hn_codebooks=n_codebooks,[55;185H[K[55;185H63,1[10C24%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hd_model=args.d_model,[55;185H[K[55;185H64,1[10C25%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hn_heads=args.n_heads,[55;185H[K[55;185H65,1[10C27%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hnum_layers=args.num_layers[55;185H[K[55;185H66,1[10C29%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H).to(device)[55;185H[K[55;185H67,1[10C31%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H68,1[10C32%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m is_ddp:[55;185H[K[55;185H69,1[10C34%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hmodel = torch.nn.parallel.DistributedDataParallel([55;185H[K[55;185H70,1[10C36%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hmodel,[55;185H[K[55;185H71,1[10C37%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hdevice_ids=[local_rank],[55;185H[K[55;185H72,1[10C39%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Houtput_device=local_rank,[55;185H[K[55;185H73,0-1[8C41%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hfind_unused_parameters=[1m[96mFalse[m[55;185H[K[55;185H74,1[10C43%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H)[55;185H[K[55;185H75,1[10C44%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mif[m rank == [95m0[m:[55;185H[K[55;185H76,1[10C46%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[1m[96mprint[m([95m"[DDP] Model wrapped successfully"[m)[55;185H[K[55;185H77,1[10C48%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H78,1[10C50%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[96m# ------------------------------[m[55;185H[K[55;185H79,1[10C51%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# Start Training[m[55;185H[K[55;185H80,1[10C53%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# ------------------------------[m[55;185H[K[55;185H81,1[10C55%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Htrain([55;185H[K[55;185H82,1[10C56%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hdataset=dataset,[55;185H[K[55;185H83,0-1[8C58%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hval_dataset=val_dataset,[55;185H[K[55;185H84,1[10C60%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hmodel=model,[55;185H[K[55;185H85,1[10C62%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Htrain_sampler=sampler,[55;185H[K[55;185H86,1[10C63%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hargs=args,[55;185H[K[55;185H87,1[10C65%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hdevice=device,[55;185H[K[55;185H88,1[10C67%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hrank=rank,[55;185H[K[55;185H89,1[10C68%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hlocal_rank=local_rank,[55;185H[K[55;185H90,1[10C70%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hworld_size=world_size,[55;185H[K[55;185H91,1[10C72%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9His_ddp=is_ddp,[55;185H[K[55;185H92,1[10C74%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H)[55;185H[K[55;185H93,1[10C75%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H94,1[10C77%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# ------------------------------[m[55;185H[K[55;185H95,1[10C79%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# Cleanup[m[55;185H[K[55;185H96,1[10C81%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# ------------------------------[m[55;185H[K[55;185H97,1[10C82%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m is_ddp:[55;185H[K[55;185H98,1[10C84%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hdist.barrier()[55;185H[K[55;185H99,0-1[8C86%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hdist.destroy_process_group()[55;185H[K[55;185H100,1[9C87%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mif[m rank == [95m0[m:[55;185H[K[55;185H101,1[9C89%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[1m[96mprint[m([95m"[DDP] Cleanup complete"[m)[55;185H[K[55;185H102,1[9C91%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H103,1[9C93%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[93mif[m __name__ == [95m"__main__"[m:[55;185H[K[55;185H104,1[9C94%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Htorch.multiprocessing.set_start_method([95m"spawn"[m, force=[1m[96mTrue[m)[55;185H[K[55;185H105,1[9C96%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmain()[55;185H[K[55;185H106,1[9C98%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H107,1[9CBot[49;1H[?25h[?25l[55;187H8,0-1[50;1H[?25h[?25l[55;187H9,1  [51;1H[?25h[?25l[55;186H10[52;1H[?25h[?25l[55;187H1[53;1H[?25h[?25l[55;187H2,0-1[54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H~@k[54;1H[55;175H   [54;1H[?25h[?25l[55;175H^[[54;1H[55;175H  [54;1H[55;175H^[[54;1H[55;175H  [54;1H[?25h[?25l[55;175H:[54;1H[55;175H[K[55;1H:[?25hq[?25l[?2004l[>4;m[23;2t[23;1t[55;1H[K[55;1H[?1004l[?2004l[?1l>[?25h[>4;m[?1049l[23;0;0t[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ vim.[K ../lmc[K[Kcm2.[K[K.py 
[?2004l[?1049h[22;0;0t[>4;2m[?1h=[?2004h[?1004h[1;55r[?12h[?12l[22;2t[22;1t[27m[23m[29m[m[H[2J[?25l[55;1H"../lcm.py" 420L, 18708B[2;1Hâ–½[6n[2;1H  [3;1HPzz\[0%m[6n[3;1H           [1;1H[>c]10;?]11;?[1;21H[38;5;130melse[m:
                        new_bs = [36mmax[m([31m1[m, args.per_step_batch_size // [31m2[m)[2;71H[K[3;1H[K[4;21H[38;5;130mif[m new_bs < args.per_step_batch_size:[5;25Hlogging.warning(f[31m"Synchronized decision: reducing per_step_batch_size {args.per_step_batch_size} -> {new_bs}"[m)[6;25Hargs.per_step_batch_size = new_bs[7;25H[34m# recreate loader in next epoch loop[m[8;25Hrestart_epoch = [36mTrue[m[9;25H[38;5;130mbreak[10;21Helse[m:[11;25H[34m# already at 1 and still OOM -> abort training[m[12;25Hlogging.error([31m"OOM at per_step_batch_size==1 on all ranks; cannot recover. Aborting."[m)[13;25H[38;5;130mraise[m e[15;9H[38;5;130mif[m restart_epoch:[16;13H[34m# continue to next epoch iteration which will rebuild loader and retry same epoch[m[17;13H[38;5;130mcontinue[m[19;9H[34m# Aggregate epoch stats across ranks[m[20;9H[38;5;130mif[m is_ddp:[21;13Hstats = torch.tensor([epoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count], device=device)[22;13Hdist.all_reduce(stats, op=dist.ReduceOp.SUM)[23;13Hepoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count = [stats[i].item() [38;5;130mfor[m i [38;5;130min[m [36mrange[m([31m5[m)][25;9Havg_loss = epoch_loss / epoch_count [38;5;130mif[m epoch_count > [31m0[m [38;5;130melse[m [31m0.0[m[26;9Havg_ce = epoch_ce / epoch_count [38;5;130mif[m epoch_count > [31m0[m [38;5;130melse[m [31m0.0[m[27;9Havg_stft = epoch_stft / epoch_count [38;5;130mif[m epoch_count > [31m0[m [38;5;130melse[m [31m0.0[m[28;9Havg_wf = epoch_wf / epoch_count [38;5;130mif[m epoch_count > [31m0[m [38;5;130melse[m [31m0.0[m[30;9H[34m# validation[m[31;9Hval_metrics = [36mNone[m[32;9H[38;5;130mif[m val_loader [38;5;130mis[m [38;5;130mnot[m [36mNone[m:[33;13Hval_metrics = validate_one_epoch(val_loader, model, device, encodec_model, n_codebooks=args.n_codebooks, lambda_waveform=args.lambda_waveform, lambda_stft=args.lambda_stft, is_ddp=is_ddp)[35;9H[38;5;130mif[m rank == [31m0[m:[36;13Hlogger.info(f[31m"Epoch {epoch+1}: train loss={avg_loss:.6f} ce={avg_ce:.6f} stft={avg_stft:.6f} wf={avg_wf:.6f} | val: {val_metrics}"[m)[37;13Hos.makedirs(args.checkpoint_dir, exist_ok=[36mTrue[m)[38;13Hckpt_path = os.path.join(args.checkpoint_dir, f[31m"lcm_epoch{epoch+1}.pt"[m)[39;13Htorch.save({[40;17H[31m"epoch"[m: epoch+[31m1[m,[41;17H[31m"model_state_dict"[m: model.module.state_dict() [38;5;130mif[m is_ddp [38;5;130melse[m model.state_dict(),[42;17H[31m"optimizer_state_dict"[m: optimizer.state_dict(),[43;17H[31m"scheduler_state_dict"[m: scheduler.state_dict(),[44;13H}, ckpt_path)[45;13Hwandb.log({[46;17H[31m"epoch"[m: epoch+[31m1[m,[47;17H[31m"train_loss"[m: avg_loss,[48;17H[31m"train_ce"[m: avg_ce,[49;17H[31m"train_stft"[m: avg_stft,[50;17H[31m"train_wf"[m: avg_wf,[51;17H**({f[31m"val_{k}"[m: v [38;5;130mfor[m k, v [38;5;130min[m (val_metrics [38;5;130mor[m {}).items()} )[52;13H})[54;5Hlogger.info[106m([m[31m"Training finished"[m[106m)[m[55;185H420,36[8CBot[54;36H[?25h[27m[23m[29m[m[H[2J[?25l[1;21H[93melse[m:[2;25Hnew_bs = [1m[96mmax[m([95m1[m, args.per_step_batch_size // [95m2[m)[4;21H[93mif[m new_bs < args.per_step_batch_size:[5;25Hlogging.warning(f[95m"Synchronized decision: reducing per_step_batch_size {args.per_step_batch_size} -> {new_bs}"[m)[6;25Hargs.per_step_batch_size = new_bs[7;25H[96m# recreate loader in next epoch loop[m[8;25Hrestart_epoch = [1m[96mTrue[m[9;25H[93mbreak[10;21Helse[m:[11;25H[96m# already at 1 and still OOM -> abort training[m[12;25Hlogging.error([95m"OOM at per_step_batch_size==1 on all ranks; cannot recover. Aborting."[m)[13;25H[93mraise[m e[15;9H[93mif[m restart_epoch:[16;13H[96m# continue to next epoch iteration which will rebuild loader and retry same epoch[m[17;13H[93mcontinue[m[19;9H[96m# Aggregate epoch stats across ranks[m[20;9H[93mif[m is_ddp:[21;13Hstats = torch.tensor([epoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count], device=device)[22;13Hdist.all_reduce(stats, op=dist.ReduceOp.SUM)[23;13Hepoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count = [stats[i].item() [93mfor[m i [93min[m [1m[96mrange[m([95m5[m)][25;9Havg_loss = epoch_loss / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[m[26;9Havg_ce = epoch_ce / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[m[27;9Havg_stft = epoch_stft / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[m[28;9Havg_wf = epoch_wf / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[m[30;9H[96m# validation[m[31;9Hval_metrics = [1m[96mNone[m[32;9H[93mif[m val_loader [93mis[m [93mnot[m [1m[96mNone[m:[33;13Hval_metrics = validate_one_epoch(val_loader, model, device, encodec_model, n_codebooks=args.n_codebooks, lambda_waveform=args.lambda_waveform, lambda_stft=args.lambda_stft, is_ddp=is_ddp)[35;9H[93mif[m rank == [95m0[m:[36;13Hlogger.info(f[95m"Epoch {epoch+1}: train loss={avg_loss:.6f} ce={avg_ce:.6f} stft={avg_stft:.6f} wf={avg_wf:.6f} | val: {val_metrics}"[m)[37;13Hos.makedirs(args.checkpoint_dir, exist_ok=[1m[96mTrue[m)[38;13Hckpt_path = os.path.join(args.checkpoint_dir, f[95m"lcm_epoch{epoch+1}.pt"[m)[39;13Htorch.save({[40;17H[95m"epoch"[m: epoch+[95m1[m,[41;17H[95m"model_state_dict"[m: model.module.state_dict() [93mif[m is_ddp [93melse[m model.state_dict(),[42;17H[95m"optimizer_state_dict"[m: optimizer.state_dict(),[43;17H[95m"scheduler_state_dict"[m: scheduler.state_dict(),[44;13H}, ckpt_path)[45;13Hwandb.log({[46;17H[95m"epoch"[m: epoch+[95m1[m,[47;17H[95m"train_loss"[m: avg_loss,[48;17H[95m"train_ce"[m: avg_ce,[49;17H[95m"train_stft"[m: avg_stft,[50;17H[95m"train_wf"[m: avg_wf,[51;17H**({f[95m"val_{k}"[m: v [93mfor[m k, v [93min[m (val_metrics [93mor[m {}).items()} )[52;13H})[54;5Hlogger.info[46m([m[95m"Training finished"[m[46m)[m[55;185H420,36[8CBot"../lcm.py" 420L, 18708B[54;36H[?25h[?25l[54;16H([19C)[55;186H19,0-1[53;1H[?25h[?25l[55;175H~@k[53;1H[55;175H   [52;1H[55;187H8,1  [52;1H[?25h[?25l[55;187H7[51;1H[?25h[?25l[55;187H6[50;1H[?25h[?25l[55;187H5[49;1H[?25h[?25l[55;187H4[48;1H[?25h[?25l[55;187H3[47;1H[?25h[?25l[55;187H2[46;1H[?25h[?25l[55;187H1[45;1H[?25h[?25l[55;187H0[44;1H[?25h[?25l[55;186H09[43;1H[?25h[?25l[55;187H8[42;1H[?25h[?25l[55;175H~@k[42;1H[55;175H   [41;1H[55;187H7[41;1H[?25h[?25l[55;187H6[40;1H[?25h[?25l[55;187H5[39;1H[?25h[?25l[55;187H4[38;1H[?25h[?25l[55;187H3[37;1H[?25h[?25l[55;187H2[36;1H[?25h[?25l[55;187H1[35;1H[?25h[?25l[55;187H0,0-1[34;1H[?25h[?25l[55;175H~@k[34;1H[55;175H   [33;1H[55;185H399,1  [33;1H[?25h[?25l[55;187H8[32;1H[?25h[?25l[55;187H7[31;1H[?25h[?25l[55;187H6[30;1H[?25h[?25l[55;187H5,0-1[29;1H[?25h[?25l[55;187H4,1  [28;1H[?25h[?25l[55;187H3[27;1H[?25h[?25l[55;175H~@k[27;1H[55;175H   [26;1H[55;187H2[26;1H[?25h[?25l[55;187H1[25;1H[?25h[?25l[55;187H0,0-1[24;1H[?25h[?25l[55;186H89,1  [23;1H[?25h[?25l[55;187H8[22;1H[?25h[?25l[55;187H7[21;1H[?25h[?25l[55;187H6[20;1H[?25h[?25l[55;175H~@k[20;1H[55;175H   [19;1H[55;187H5[19;1H[?25h[?25l[55;187H4,0-1[18;1H[?25h[?25l[55;187H3,1  [17;1H[?25h[?25l[55;187H2[16;1H[?25h[?25l[55;187H1[15;1H[?25h[?25l[55;187H0,0-1[14;1H[?25h[?25l[55;186H79,1  [13;1H[?25h[?25l[55;175H~@k[13;1H[55;175H   [12;1H[55;187H8[12;1H[?25h[?25l[55;187H7[11;1H[?25h[?25l[55;187H6[10;1H[?25h[?25l[55;187H5[9;1H[?25h[?25l[55;187H4[8;1H[?25h[?25l[55;187H3[7;1H[?25h[?25l[55;187H2[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hnew_bs = [1m[96mint[m(decide.item())[55;1H[K[55;185H371,1[9C99%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hdist.broadcast(decide, src=[95m0[m)[55;185H[K[55;185H370,1[9C99%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;29Hdecide = torch.tensor([[95m0[m], device=device, dtype=torch.int32)[55;185H[K[55;185H369,0-1[7C99%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25H[93melse[m:[55;185H[K[55;185H368,1[9C98%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;29Hdecide = torch.tensor([new_bs], device=device, dtype=torch.int32)[55;185H[K[55;185H367,1[9C98%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;29Hnew_bs = [1m[96mmax[m([95m1[m, args.per_step_batch_size // [95m2[m)[55;185H[K[55;185H366,1[9C98%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25H[93mif[m rank == [95m0[m:[55;185H[K[55;185H365,1[9C98%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21H[93mif[m is_ddp:[55;185H[K[55;185H364,1[9C97%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21H[96m# rank 0 decides the new batch size (halved)[m[55;185H[K[55;185H363,1[9C97%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[93mif[m any_oom:[55;185H[K[55;185H362,1[9C97%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H361,1[9C96%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21Hany_oom = [1m[96mTrue[m[55;185H[K[55;185H360,1[9C96%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[93melse[m:[55;185H[K[55;185H359,1[9C96%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21Hany_oom = [1m[96mint[m(global_oom.item()) > [95m0[m[55;185H[K[55;185H358,1[9C96%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21Hdist.all_reduce(global_oom, op=dist.ReduceOp.SUM)[55;185H[K[55;185H357,1[9C95%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21Hglobal_oom = local_oom.clone()[55;185H[K[55;185H356,0-1[7C95%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[93mif[m is_ddp:[55;185H[K[55;185H355,1[9C95%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[96m# reduce across ranks to see if any rank OOMed[m[55;185H[K[55;185H354,1[9C95%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H353,1[9C94%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hlocal_oom = torch.tensor([[95m1[m], device=device, dtype=torch.int32)[55;185H[K[55;185H352,1[9C94%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[96m# signal local OOM (1) or success (0)[m[55;185H[K[55;185H351,1[9C94%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H350,1[9C93%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Htorch.cuda.empty_cache()[55;185H[K[55;185H349,1[9C93%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hlogging.warning(f[95m"OOM at epoch {epoch} batch {batch_idx}: {e}"[m)[55;185H[K[55;185H348,0-1[7C93%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[96m# free what we can locally[m[55;185H[K[55;185H347,1[9C93%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H346,1[9C92%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21H[93mraise[m[55;185H[K[55;185H345,0-1[7C92%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[93mif[m [93mnot[m oom:[55;185H[K[55;185H344,1[9C92%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hoom = ([95m"out of memory"[m [93min[m [1m[96mstr[m(e).lower()) [93mor[m ([95m"cuda out of memory"[m [93min[m [1m[96mstr[m(e).lower())[55;185H[K[55;185H343,1[9C92%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[96m# Detect OOM[m[55;185H[K[55;185H342,1[9C91%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;13H[93mexcept[m [38;5;121mRuntimeError[m [93mas[m e:[55;185H[K[55;185H341,0-1[7C91%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H340,1[9C91%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hepoch_count += bsz[55;185H[K[55;185H339,1[9C90%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hepoch_wf += wf_loss.item() * bsz[55;185H[K[55;185H338,1[9C90%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hepoch_stft += stft_loss.item() * bsz[55;185H[K[55;185H337,1[9C90%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hepoch_ce += ce_loss.item() * bsz[55;185H[K[55;185H336,1[9C90%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;17Hepoch_loss += loss.item() * bsz[55;185H[K[55;185H335,0-1[7C89%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;17Hbsz = degraded.size([95m0[m)[55;185H[K[55;185H334,1[9C89%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H333,1[9C89%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21Hscheduler.step()[55;185H[K[55;185H332,1[9C89%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21Hoptimizer.zero_grad()[55;185H[K[55;185H331,1[9C88%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21Hscaler.update()[55;185H[K[55;185H330,1[9C88%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21Hscaler.step(optimizer)[55;185H[K[55;185H329,1[9C88%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[93mif[m ((batch_idx + [95m1[m) % accum_steps == [95m0[m) [93mor[m is_last_step:[55;185H[K[55;185H328,0-1[7C87%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17His_last_step = (batch_idx + [95m1[m == [1m[96mlen[m(train_loader))[55;185H[K[55;185H327,1[9C87%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17H[96m# Step when accumulation boundary reached[m[55;185H[K[55;185H326,1[9C87%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H325,1[9C87%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21Hscaler.scale(loss_scaled).backward()[55;185H[K[55;185H324,1[9C86%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H323,1[9C86%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hloss_scaled = loss / accum_steps[55;185H[K[55;185H322,1[9C86%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hloss = ce_loss + args.lambda_waveform * wf_loss + args.lambda_stft * stft_loss[55;185H[K[55;185H321,1[9C86%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25H[96m# combine losses but scale CE for accumulation[m[55;185H[K[55;185H320,0-1[7C85%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H319,1[9C85%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hwf_loss = wf_fn(pred_wav, teacher_wav).detach()[55;185H[K[55;185H318,0-1[7C85%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hstft_loss = stft_fn(pred_wav, teacher_wav).detach()[55;185H[K[55;185H317,1[9C84%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25H[96m# compute audio losses (detached from autograd)[m[55;185H[K[55;185H316,1[9C84%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H315,1[9C84%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;29Hteacher_wav = encodec_model.decode([(teacher_codes, [1m[96mNone[m)])[55;185H[K[55;185H314,0-1[7C84%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;29Hpred_wav = encodec_model.decode([(pred_tokens, [1m[96mNone[m)])[55;185H[K[55;185H313,1[9C83%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25H[93mwith[m torch.no_grad():[55;185H[K[55;185H312,1[9C83%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hteacher_codes = teacher.transpose([95m1[m,[95m2[m)[55;185H[K[55;185H311,1[9C83%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hpred_tokens = torch.argmax(logits, dim=[95m2[m).transpose([95m1[m,[95m2[m)[55;185H[K[55;185H310,0-1[7C83%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25H[96m# decode under no_grad()[m[55;185H[K[55;185H309,1[9C82%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H308,1[9C82%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hce_loss = ce_loss / [1m[96mfloat[m(n_codebooks)[55;185H[K[55;185H307,1[9C82%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;29Hce_loss += F.cross_entropy(logits[..., i].transpose([95m1[m,[95m2[m), teacher[..., i], reduction=[95m'mean'[m)[55;185H[K[55;185H306,1[9C81%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25H[93mfor[m i [93min[m [1m[96mrange[m(n_codebooks):[55;185H[K[55;185H305,1[9C81%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hce_loss = [95m0.0[m[55;185H[K[55;185H304,1[9C81%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;25Hlogits = model(degraded, attention_mask=mask)  [96m# [B, S, vocab, n_codebooks][m[55;185H[K[55;185H303,0-1[7C81%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;21H[93mwith[m torch.cuda.amp.autocast():[55;185H[K[55;185H302,1[9C80%[6;1H[?25h[?25l[55;175H^[[6;1H[55;175H  [6;1H[1;54r[1;1H[L[1;55r[1;17H[93mwith[m ddp_ctx():[55;185H[K[55;185H301,1[9C80%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13H[93mtry[m:[55;185H[K[55;185H300,1[9C80%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H299,1[9C80%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hddp_ctx = model.no_sync [93mif[m use_no_sync [93melse[m nullcontext[55;185H[K[55;185H298,1[9C79%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Huse_no_sync = is_ddp [93mand[m ((batch_idx + [95m1[m) % accum_steps != [95m0[m)[55;185H[K[55;185H297,1[9C79%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13H[96m# choose no_sync context for DDP when not stepping this iter[m[55;185H[K[55;185H296,1[9C79%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H295,1[9C78%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hdegraded, teacher, mask = degraded.to(device), teacher.to(device), mask.to(device)[55;185H[K[55;185H294,0-1[7C78%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mfor[m batch_idx, (degraded, teacher, mask) [93min[m [1m[96menumerate[m(train_loader):[55;185H[K[55;185H293,1[9C78%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;9H[96m# iterate with index to enable no_sync decisions[m[55;185H[K[55;185H292,1[9C78%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hoptimizer.zero_grad()[55;185H[K[55;185H291,1[9C77%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H290,0-1[7C77%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hrestart_epoch = [1m[96mFalse[m[55;185H[K[55;185H289,1[9C77%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hepoch_loss = epoch_ce = epoch_stft = epoch_wf = epoch_count = [95m0.0[m[55;185H[K[55;185H288,1[9C77%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H287,1[9C76%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Htrain_loader = make_train_loader()[55;185H[K[55;185H286,1[9C76%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[96m# Create fresh loader in case it was recreated after OOM[m[55;185H[K[55;185H285,0-1[7C76%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H284,1[9C75%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hmodel.train()[55;185H[K[55;185H283,1[9C75%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Htrain_sampler.set_epoch(epoch) [93mif[m train_sampler [93mis[m [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m[55;185H[K[55;185H282,0-1[7C75%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mif[m is_ddp:[55;185H[K[55;185H281,1[9C75%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mfor[m epoch [93min[m [1m[96mrange[m(start_epoch, args.epochs):[55;185H[K[55;185H280,1[9C74%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H279,0-1[7C74%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hlogger.info(f[95m"Starting training: epochs={args.epochs}, per_step_batch_size={args.per_step_batch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[55;185H[K[55;185H278,1[9C74%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H277,1[9C74%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Haccum_steps = [1m[96mint[m([1m[96mgetattr[m(args, [95m"accum_steps"[m, [95m4[m))[55;185H[K[55;185H276,1[9C73%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hscaler = torch.cuda.amp.GradScaler()[55;185H[K[55;185H275,1[9C73%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H274,0-1[7C73%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hwandb.watch(model, log=[95m"gradients"[m [93mif[m [1m[96mgetattr[m(args, [95m"log_grads"[m, [1m[96mFalse[m) [93melse[m [1m[96mNone[m)[55;185H[K[55;185H273,1[9C72%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hwandb.init(project=[1m[96mgetattr[m(args, [95m"wandb_project"[m, [95m"lcm-training"[m), config=[1m[96mvars[m(args), resume=[95m"allow"[m [93mif[m [1m[96mgetattr[m(args, [95m"resume"[m, [1m[96mFalse[m) [93melse[m [1m[96mNone[m)[55;185H[K[55;185H272,0-1[7C72%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mif[m rank == [95m0[m:[55;185H[K[55;185H271,1[9C72%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H270,1[9C72%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hlogger.info([95m"No checkpoint found; starting fresh"[m)[55;185H[K[55;185H269,0-1[7C71%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93melse[m:[55;185H[K[55;185H268,1[9C71%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hstart_epoch = loaded.get([95m"epoch"[m, [95m0[m)[55;185H[K[55;185H267,1[9C71%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hscheduler.load_state_dict(loaded[[95m"scheduler_state_dict"[m])[55;185H[K[55;185H266,1[9C71%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13H[93mif[m [95m"scheduler_state_dict"[m [93min[m loaded:[55;185H[K[55;185H265,0-1[7C70%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hoptimizer.load_state_dict(loaded[[95m"optimizer_state_dict"[m])[55;185H[K[55;185H264,1[9C70%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13H[93mif[m [95m"optimizer_state_dict"[m [93min[m loaded:[55;185H[K[55;185H263,1[9C70%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hloaded = load_checkpoint_compatible(model, ckpt, device, ddp=is_ddp)[55;185H[K[55;185H262,1[9C69%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hlogger.info(f[95m"Resuming from {ckpt}"[m)[55;185H[K[55;185H261,1[9C69%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mif[m ckpt:[55;185H[K[55;185H260,1[9C69%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hckpt = latest_checkpoint(args.checkpoint_dir)[55;185H[K[55;185H259,1[9C69%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mif[m [1m[96mgetattr[m(args, [95m"resume"[m, [1m[96mFalse[m):[55;185H[K[55;185H258,1[9C68%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hstart_epoch = [95m0[m[55;185H[K[55;185H257,1[9C68%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[96m# resume[m[55;185H[K[55;185H256,1[9C68%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H255,1[9C68%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hwf_fn = WaveformL1Loss()[55;185H[K[55;185H254,1[9C67%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hstft_fn = MultiResolutionSTFTLoss()[55;185H[K[55;185H253,1[9C67%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H252,1[9C67%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hencodec_model.eval()[55;185H[K[55;185H251,1[9C66%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hencodec_model = EncodecModel.encodec_model_24khz().to(device)[55;185H[K[55;185H250,0-1[7C66%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H249,1[9C66%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hscheduler = torch.optim.lr_scheduler.LambdaLR(optimizer, lr_lambda)[55;185H[K[55;185H248,1[9C66%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mreturn[m [1m[96mmax[m([95m0.0[m, [1m[96mfloat[m(total_steps - step) / [1m[96mfloat[m([1m[96mmax[m([95m1[m, total_steps - warmup_steps)))[55;185H[K[55;185H247,0-1[7C65%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Htotal_steps = args.epochs * [1m[96mmax[m([95m1[m, [1m[96mlen[m(train_loader))[55;185H[K[55;185H246,1[9C65%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13H[93mreturn[m [1m[96mfloat[m(step + [95m1[m) / [1m[96mfloat[m([1m[96mmax[m([95m1[m, warmup_steps))[55;185H[K[55;185H245,1[9C65%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mif[m step < warmup_steps:[55;185H[K[55;185H244,0-1[7C65%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mdef[m [1m[96mlr_lambda[m(step):[55;185H[K[55;185H243,1[9C64%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hwarmup_steps = [1m[96mgetattr[m(args, [95m"warmup_steps"[m, [95m500[m)[55;185H[K[55;185H242,1[9C64%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[96m# lambda scheduler: warmup then linear decay[m[55;185H[K[55;185H241,1[9C64%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hoptimizer = torch.optim.AdamW(model.parameters(), lr=args.lr, weight_decay=[1m[96mgetattr[m(args, [95m"weight_decay"[m, [95m0.0[m))[55;185H[K[55;185H240,1[9C63%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H239,1[9C63%[6;1H[?25h[?25l[1;54r[1;1H[2L[1;55r[1;5Hval_loader = DataLoader(val_dataset, batch_size=args.val_batch_size, sampler=DistributedSampler(val_dataset) [93mif[m is_ddp [93mand[m val_dataset [93mis[m [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m, collate_fn=collate_fn) [93mif[m val_dataset [93miss[m[2;1H [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m[55;185H[K[55;185H238,1[9C63%[7;1H[?25h[?25l[55;187H7[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Htrain_loader = make_train_loader()[55;185H[K[55;185H236,1[9C62%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H235,1[9C62%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mreturn[m DataLoader(dataset, batch_size=args.per_step_batch_size, sampler=train_sampler, collate_fn=collate_fn)[55;185H[K[55;185H234,0-1[7C62%[6;1H[?25h[?25l[1;54r[1;1H[2L[1;55r[1;5H[96m# helper to build train loader (recreated if batch size changes)[m
    [93mdef[m [1m[96mmake_train_loader[m():[55;185H[K[55;185H233,1[9C61%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H232,1[9C61%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hargs.accum_steps = [95m4[m[55;185H[K[55;185H231,0-1[7C61%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mif[m [93mnot[m [1m[96mhasattr[m(args, [95m"accum_steps"[m):[55;185H[K[55;185H230,1[9C61%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hn_codebooks = args.n_codebooks[55;185H[K[55;185H229,1[9C60%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H228,1[9C60%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hinstall_except_hook(rank)[55;185H[K[55;185H227,0-1[7C60%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hlogger = setup_logging(args.checkpoint_dir, rank=rank)[55;185H[K[55;185H226,1[9C59%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mdef[m [1m[96mtrain[m(dataset, model, train_sampler, val_dataset, args, device, rank, local_rank, world_size, is_ddp):[55;185H[K[55;185H225,1[9C59%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H224,1[9C59%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# Training (with synchronized OOM handling + AMP + accumulation)[m[55;185H[K[55;185H223,0-1[7C59%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H222,1[9C58%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H221,1[9C58%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mreturn[m {[95m"loss"[m: total/count, [95m"ce"[m: total_ce/count, [95m"stft"[m: total_stft/count, [95m"waveform"[m: total_wf/count}[55;185H[K[55;185H220,1[9C58%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mreturn[m [1m[96mNone[m[55;185H[K[55;185H219,1[9C58%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mif[m count == [95m0[m:[55;185H[K[55;185H218,1[9C57%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hmodel.train()[55;185H[K[55;185H217,1[9C57%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H216,0-1[7C57%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Htotal, total_ce, total_stft, total_wf, count = [t[i].item() [93mfor[m i [93min[m [1m[96mrange[m([95m5[m)][55;185H[K[55;185H215,1[9C56%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hdist.all_reduce(t, op=dist.ReduceOp.SUM)[55;185H[K[55;185H214,1[9C56%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Ht = torch.tensor([total, total_ce, total_stft, total_wf, count], device=device)[55;185H[K[55;185H213,1[9C56%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mif[m is_ddp:[55;185H[K[55;185H212,1[9C56%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H211,0-1[7C55%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hcount += bsz[55;185H[K[55;185H210,1[9C55%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Htotal_wf += wf_l.item() * bsz[55;185H[K[55;185H209,1[9C55%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Htotal_stft += stft_l.item() * bsz[55;185H[K[55;185H208,1[9C55%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Htotal_ce += ce.item() * bsz[55;185H[K[55;185H207,1[9C54%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Htotal += loss.item() * bsz[55;185H[K[55;185H206,0-1[7C54%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hbsz = degraded.size([95m0[m)[55;185H[K[55;185H205,1[9C54%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H204,1[9C53%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hloss = ce + lambda_waveform * wf_l + lambda_stft * stft_l[55;185H[K[55;185H203,1[9C53%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hwf_l = wf_fn(pred_wav, tgt_wav)[55;185H[K[55;185H202,1[9C53%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hstft_l = mrstft(pred_wav, tgt_wav)[55;185H[K[55;185H201,1[9C53%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H200,1[9C52%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Htgt_wav = encodec_model.decode([(teacher_codes, [1m[96mNone[m)])[55;185H[K[55;185H199,0-1[7C52%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hpred_wav = encodec_model.decode([(pred_tokens, [1m[96mNone[m)])[55;185H[K[55;185H198,1[9C52%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hteacher_codes = teacher.transpose([95m1[m,[95m2[m)[55;185H[K[55;185H197,1[9C52%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hpred_tokens = torch.argmax(logits, dim=[95m2[m).transpose([95m1[m,[95m2[m)[55;185H[K[55;185H196,1[9C51%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H195,0-1[7C51%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hce = ce / n_codebooks[55;185H[K[55;185H194,1[9C51%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;17Hce += F.cross_entropy(logits[..., i].transpose([95m1[m,[95m2[m), teacher[..., i], reduction=[95m'mean'[m)[55;185H[K[55;185H193,1[9C50%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13H[93mfor[m i [93min[m [1m[96mrange[m(n_codebooks):[55;185H[K[55;185H192,1[9C50%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hce = [95m0.0[m[55;185H[K[55;185H191,1[9C50%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H190,0-1[7C50%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hlogits = model(degraded, attention_mask=mask)[55;185H[K[55;185H189,1[9C49%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hdegraded, teacher, mask = degraded.to(device), teacher.to(device), mask.to(device)[55;185H[K[55;185H188,1[9C49%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mfor[m degraded, teacher, mask [93min[m val_loader:[55;185H[K[55;185H187,1[9C49%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mwith[m torch.no_grad():[55;185H[K[55;185H186,1[9C49%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[54;1H[94m@@@                                                                                                                                                                                                       [m[55;185H[K[55;185H185,0-1[7C48%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Htotal = total_ce = total_stft = total_wf = count = [95m0.0[m[55;185H[K[55;185H184,1[9C48%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hwf_fn = WaveformL1Loss()[55;185H[K[55;185H183,1[9C48%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hmrstft = MultiResolutionSTFTLoss()[55;185H[K[55;185H182,1[9C48%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hmodel.eval()[55;185H[K[55;185H181,1[9C47%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mdef[m [1m[96mvalidate_one_epoch[m(val_loader, model, device, encodec_model, n_codebooks, lambda_waveform, lambda_stft, is_ddp):[55;185H[K[55;185H180,0-1[7C47%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H179,1[9C47%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# Validation[m[55;185H[K[55;185H178,1[9C46%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H177,1[9C46%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H176,1[9C46%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mreturn[m checkpoint[55;185H[K[55;185H175,1[9C46%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hmodel.load_state_dict(new_state, strict=[1m[96mTrue[m)[55;185H[K[55;185H174,1[9C45%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hnew_state[k] = v[55;185H[K[55;185H173,1[9C45%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93melse[m:[55;185H[K[55;185H172,1[9C45%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hnew_state[[95m"module."[m + k] = v[55;185H[K[55;185H171,0-1[7C45%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93melif[m [93mnot[m k.startswith([95m"module."[m) [93mand[m ddp:[55;185H[K[55;185H170,1[9C44%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hnew_state[k[[1m[96mlen[m([95m"module."[m):]] = v[55;185H[K[55;185H169,1[9C44%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mif[m k.startswith([95m"module."[m) [93mand[m [93mnot[m ddp:[55;185H[K[55;185H168,1[9C44%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mfor[m k, v [93min[m state_dict.items():[55;185H[K[55;185H167,1[9C43%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hnew_state = {}[55;185H[K[55;185H166,1[9C43%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mraise[m [38;5;121mKeyError[m([95m"No model weights found in checkpoint"[m)[55;185H[K[55;185H165,1[9C43%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mif[m state_dict [93mis[m [1m[96mNone[m:[55;185H[K[55;185H164,1[9C43%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hstate_dict = checkpoint.get([95m"model_state_dict"[m) [93mor[m checkpoint.get([95m"state_dict"[m) [93mor[m checkpoint.get([95m"model"[m)[55;185H[K[55;185H163,1[9C42%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hcheckpoint = torch.load(ckpt_path, map_location=device)[55;185H[K[55;185H162,1[9C42%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mdef[m [1m[96mload_checkpoint_compatible[m(model, ckpt_path, device, ddp):[55;185H[K[55;185H161,1[9C42%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H160,1[9C42%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mreturn[m [1m[96mmax[m(ckpts, key=os.path.getmtime) [93mif[m ckpts [93melse[m [1m[96mNone[m[55;185H[K[55;185H159,1[9C41%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hckpts = [os.path.join(checkpoint_dir, f) [93mfor[m f [93min[m os.listdir(checkpoint_dir) [93mif[m f.endswith([95m".pt"[m)][55;185H[K[55;185H158,1[9C41%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mdef[m [1m[96mlatest_checkpoint[m(checkpoint_dir):[55;185H[K[55;185H157,1[9C41%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H156,1[9C40%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# Checkpoint utils[m[55;185H[K[55;185H155,0-1[7C40%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H154,1[9C40%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H153,1[9C40%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mreturn[m self.l1(x, y)[55;185H[K[55;185H152,1[9C39%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mdef[m [1m[96mforward[m(self, x, y):[55;185H[K[55;185H151,1[9C39%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hself.l1 = nn.L1Loss()[55;185H[K[55;185H150,1[9C39%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[1m[96msuper[m().__init__()[55;185H[K[55;185H149,1[9C39%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mdef[m [1m[96m__init__[m(self):[55;185H[K[55;185H148,0-1[7C38%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mclass[m [1m[96mWaveformL1Loss[m(nn.Module):[55;185H[K[55;185H147,1[9C38%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H146,1[9C38%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mreturn[m loss / [1m[96mlen[m(self.fft_sizes)[55;185H[K[55;185H145,1[9C37%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hloss += sc_loss + mag_loss[55;185H[K[55;185H144,1[9C37%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hmag_loss = F.l1_loss(torch.log1p(mag_x), torch.log1p(mag_y))[55;185H[K[55;185H143,1[9C37%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hsc_loss = torch.norm(mag_y - mag_x, p=[95m'fro'[m) / (torch.norm(mag_y, p=[95m'fro'[m) + [95m1e-8[m)[55;185H[K[55;185H142,1[9C37%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hmag_y = torch.abs(Y)[55;185H[K[55;185H141,0-1[7C36%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hmag_x = torch.abs(X)[55;185H[K[55;185H140,1[9C36%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13HY = torch.stft(y, n_fft=n_fft, hop_length=hop, win_length=win, window=win_tensor, return_complex=[1m[96mTrue[m)[55;185H[K[55;185H139,1[9C36%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13HX = torch.stft(x, n_fft=n_fft, hop_length=hop, win_length=win, window=win_tensor, return_complex=[1m[96mTrue[m)[55;185H[K[55;185H138,1[9C36%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hwin_tensor = torch.hann_window(win, device=device)[55;185H[K[55;185H137,1[9C35%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mfor[m n_fft, hop, win [93min[m [1m[96mzip[m(self.fft_sizes, self.hop_sizes, self.win_lengths):[55;185H[K[55;185H136,1[9C35%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hloss = [95m0.0[m[55;185H[K[55;185H135,1[9C35%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hdevice = x.device[55;185H[K[55;185H134,1[9C34%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hy = y.squeeze([95m1[m) [93mif[m y.dim() == [95m3[m [93melse[m y[55;185H[K[55;185H133,1[9C34%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hx = x.squeeze([95m1[m) [93mif[m x.dim() == [95m3[m [93melse[m x[55;185H[K[55;185H132,1[9C34%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mdef[m [1m[96mforward[m(self, x, y):[55;185H[K[55;185H131,1[9C34%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H130,1[9C33%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hself.win_lengths = win_lengths[55;185H[K[55;185H129,1[9C33%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hself.hop_sizes = hop_sizes[55;185H[K[55;185H128,1[9C33%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hself.fft_sizes = fft_sizes[55;185H[K[55;185H127,1[9C33%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[1m[96msuper[m().__init__()[55;185H[K[55;185H126,1[9C32%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mdef[m [1m[96m__init__[m(self, fft_sizes=[[95m512[m, [95m1024[m, [95m2048[m], hop_sizes=[[95m128[m, [95m256[m, [95m512[m], win_lengths=[[95m512[m, [95m1024[m, [95m2048[m]):[55;185H[K[55;185H125,0-1[7C32%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mclass[m [1m[96mMultiResolutionSTFTLoss[m(nn.Module):[55;185H[K[55;185H124,1[9C32%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H123,1[9C31%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# Losses[m[55;185H[K[55;185H122,1[9C31%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H121,1[9C31%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H120,1[9C31%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mreturn[m torch.stack(logits_list, dim=-[95m1[m)  [96m# [B, S, vocab, n_codebooks][m[55;185H[K[55;185H119,1[9C30%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hlogits_list.append(self.output_heads[i](x_trans))[55;185H[K[55;185H118,1[9C30%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hx_trans = self.transformer(x_emb, src_key_padding_mask=src_key_padding_mask)[55;185H[K[55;185H117,1[9C30%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hsrc_key_padding_mask = (attention_mask[:, i, :] == [95m0[m) [93mif[m attention_mask [93mis[m [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m[55;185H[K[55;185H116,1[9C30%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hx_emb = self.embedding(tokens)   [96m# [B, S, D][m[55;185H[K[55;185H115,0-1[7C29%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Htokens = x[..., i][15C[96m# [B, S][m[55;185H[K[55;185H114,1[9C29%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mfor[m i [93min[m [1m[96mrange[m(self.n_codebooks):[55;185H[K[55;185H113,1[9C29%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;9Hlogits_list = [][55;185H[K[55;185H112,1[9C28%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [7;1H[55;187H3[7;1H[?25h[?25l[55;175H~@k[7;1H[55;175H   [8;1H[55;187H4[8;1H[?25h[?25l[55;175H~@k[8;1H[55;175H   [9;1H[55;187H5,0-1[9;1H[?25h[?25l[55;175H~@k[9;1H[55;175H   [10;1H[55;187H6,1  [10;1H[?25h[?25l[55;175H~@k[10;1H[55;175H   [11;1H[55;187H7[11;1H[?25h[?25l[55;187H8[12;1H[?25h[?25l[55;175H~@k[12;1H[55;175H   [13;1H[55;187H9[13;1H[?25h[?25l[55;175H~@k[13;1H[55;175H   [14;1H[55;186H20[14;1H[?25h[?25l[55;175H~@k[14;1H[55;175H   [15;1H[55;187H1[15;1H[?25h[?25l[55;175H~@k[15;1H[55;175H   [16;1H[55;187H2[16;1H[?25h[?25l[55;175H~@k[16;1H[55;175H   [17;1H[55;187H3[17;1H[?25h[?25l[55;175H~@k[17;1H[55;175H   [18;1H[55;187H4[18;1H[?25h[?25l[55;175H~@k[18;1H[55;175H   [17;1H[55;187H3[17;1H[?25h[?25l[55;175H~@k[17;1H[55;175H   [16;1H[55;187H2[16;1H[?25h[?25l[55;187H1[15;1H[?25h[?25l[55;175H~@k[15;1H[55;175H   [14;1H[55;187H0[14;1H[?25h[?25l[55;186H19[13;1H[?25h[?25l[55;175H~@k[13;1H[55;175H   [12;1H[55;187H8[12;1H[?25h[?25l[55;187H7[11;1H[?25h[?25l[55;187H6[10;1H[?25h[?25l[55;175H~@k[10;1H[55;175H   [9;1H[55;187H5,0-1[9;1H[?25h[?25l[55;187H4,1  [8;1H[?25h[?25l[55;187H3[7;1H[?25h[?25l[55;187H2[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;5H[93mdef[m [1m[96mforward[m(self, x, attention_mask=[1m[96mNone[m):[55;185H[K[55;185H111,1[9C28%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H110,1[9C28%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hself.output_heads = nn.ModuleList([nn.Linear(d_model, vocab_size) [93mfor[m _ [93min[m [1m[96mrange[m(n_codebooks)])[55;185H[K[55;185H109,1[9C28%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hself.transformer = nn.TransformerEncoder(encoder_layer, num_layers=num_layers)[55;185H[K[55;185H108,1[9C27%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;9H)[55;185H[K[55;185H107,1[9C27%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hd_model=d_model, nhead=n_heads, dim_feedforward=[95m4[m*d_model, batch_first=[1m[96mTrue[m[55;185H[K[55;185H106,1[9C27%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hencoder_layer = nn.TransformerEncoderLayer([55;185H[K[55;185H105,0-1[7C27%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hself.embedding = nn.Embedding(vocab_size, d_model)[55;185H[K[55;185H104,1[9C26%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hself.n_codebooks = n_codebooks[55;185H[K[55;185H103,1[9C26%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;9H[1m[96msuper[m().__init__()[55;185H[K[55;185H102,1[9C26%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mdef[m [1m[96m__init__[m(self, vocab_size, n_codebooks, d_model=[95m256[m, n_heads=[95m4[m, num_layers=[95m4[m):[55;185H[K[55;185H101,1[9C25%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mclass[m [1m[96mLCM_MCB[m(nn.Module):[55;185H[K[55;185H100,1[9C25%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H99,1[10C25%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# Model[m[55;185H[K[55;185H98,1[10C25%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H97,1[10C24%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H96,1[10C24%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;5H[93mreturn[m degraded_padded, teacher_padded, mask_padded[55;185H[K[55;185H95,1[10C24%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hmask_padded = mask_padded.unsqueeze([95m1[m).expand(-[95m1[m, degraded_padded.shape[[95m2[m], -[95m1[m)[55;185H[K[55;185H94,1[10C24%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hmask_padded = pad_sequence(mask_list, batch_first=[1m[96mTrue[m, padding_value=[95m0[m)[55;185H[K[55;185H93,1[10C23%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hteacher_padded = pad_sequence(teacher_list, batch_first=[1m[96mTrue[m, padding_value=[95m0[m)[55;185H[K[55;185H92,1[10C23%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;5Hdegraded_padded = pad_sequence(degraded_list, batch_first=[1m[96mTrue[m, padding_value=[95m0[m)[55;185H[K[55;185H91,0-1[8C23%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hmask_list = [m.squeeze() [93mfor[m m [93min[m mask_list][55;185H[K[55;185H90,1[10C22%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;5Hteacher_list = [t.squeeze([95m0[m).transpose([95m0[m, [95m1[m) [93mfor[m t [93min[m teacher_list][55;185H[K[55;185H89,1[10C22%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hdegraded_list = [d.squeeze([95m0[m).transpose([95m0[m, [95m1[m) [93mfor[m d [93min[m degraded_list][55;185H[K[55;185H88,1[10C22%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hdegraded_list, teacher_list, mask_list = [1m[96mzip[m(*[(b[[95m0[m], b[[95m1[m], b[[95m2[m]) [93mfor[m b [93min[m batch])[55;185H[K[55;185H87,1[10C22%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mdef[m [1m[96mcollate_fn[m(batch):[55;185H[K[55;185H86,1[10C21%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H85,1[10C21%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# Collate[m[55;185H[K[55;185H84,1[10C21%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H83,1[10C21%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H82,1[10C20%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mreturn[m logger[55;185H[K[55;185H81,1[10C20%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;5Hlogger.info(f[95m"Logging to {logfile} (rank {rank})"[m)[55;185H[K[55;185H80,1[10C20%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hlogger = logging.getLogger([95m"lcm_train"[m)[55;185H[K[55;185H79,1[10C19%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H)[55;185H[K[55;185H78,1[10C19%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hhandlers=handlers[55;185H[K[55;185H77,0-1[8C19%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hdatefmt=[95m"%Y-%m-%d %H:%M:%S"[m,[55;185H[K[55;185H76,1[10C19%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[1m[96mformat[m=[95m"%(asctime)s | %(levelname)s | %(message)s"[m,[55;185H[K[55;185H75,1[10C18%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hlevel=log_level,[55;185H[K[55;185H74,1[10C18%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;5Hlogging.basicConfig([55;185H[K[55;185H73,1[10C18%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hhandlers = [logging.StreamHandler()] [93mif[m rank != [95m0[m [93melse[m [logging.FileHandler(logfile), logging.StreamHandler()][55;185H[K[55;185H72,1[10C18%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hlogfile = os.path.join(checkpoint_dir, f[95m"train_{timestamp}_rank{rank}.log"[m)[55;185H[K[55;185H71,1[10C17%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Htimestamp = datetime.now().strftime([95m"%Y%m%d_%H%M%S"[m)[55;185H[K[55;185H70,1[10C17%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hos.makedirs(checkpoint_dir, exist_ok=[1m[96mTrue[m)[55;185H[K[55;185H69,1[10C17%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mdef[m [1m[96msetup_logging[m(checkpoint_dir, rank=[95m0[m, log_level=logging.INFO):[55;185H[K[55;185H68,1[10C16%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H67,1[10C16%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# Logging[m[55;185H[K[55;185H66,1[10C16%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H65,1[10C16%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H64,1[10C15%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mreturn[m world_size, rank, local_rank, device, is_ddp[55;185H[K[55;185H63,1[10C15%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;9Hdist.init_process_group(backend=[95m"nccl"[m, init_method=[95m"env://"[m)[55;185H[K[55;185H62,1[10C15%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mif[m is_ddp [93mand[m [93mnot[m dist.is_initialized():[55;185H[K[55;185H61,1[10C15%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5His_ddp = world_size > [95m1[m[55;185H[K[55;185H60,1[10C14%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H59,0-1[8C14%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Htorch.cuda.set_device(device)[55;185H[K[55;185H58,1[10C14%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;5H[93mif[m torch.cuda.is_available():[55;185H[K[55;185H57,1[10C13%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hdevice = torch.device(f[95m"cuda:{local_rank}"[m [93mif[m torch.cuda.is_available() [93melse[m [95m"cpu"[m)[55;185H[K[55;185H56,1[10C13%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H55,1[10C13%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hworld_size = [1m[96mint[m(os.environ.get([95m"WORLD_SIZE"[m, [95m"1"[m))[55;185H[K[55;185H54,0-1[8C13%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hrank = [1m[96mint[m(os.environ.get([95m"RANK"[m, os.environ.get([95m"LOCAL_RANK"[m, [95m"0"[m)))[55;185H[K[55;185H53,1[10C12%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hlocal_rank = [1m[96mint[m(os.environ.get([95m"LOCAL_RANK"[m, [95m"0"[m))[55;185H[K[55;185H52,1[10C12%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mdef[m [1m[96mddp_setup_from_env[m():[55;185H[K[55;185H51,1[10C12%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H50,0-1[8C12%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5Hsys.excepthook = handle_exception[55;185H[K[55;185H49,1[10C11%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Htraceback.print_exception(exc_type, exc_value, exc_traceback, file=f)[55;185H[K[55;185H48,1[10C11%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;9H[93mwith[m [1m[96mopen[m(f[95m"traceback_rank{rank}.log"[m, [95m"w"[m) [93mas[m f:[55;185H[K[55;185H47,1[10C11%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9Hlogging.error(f[95m"Uncaught exception on rank {rank}"[m, exc_info=(exc_type, exc_value, exc_traceback))[55;185H[K[55;185H46,1[10C10%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13H[93mreturn[m[55;185H[K[55;185H45,0-1[8C10%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;13Hsys.__excepthook__(exc_type, exc_value, exc_traceback)[55;185H[K[55;185H44,1[10C10%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;9H[93mif[m [1m[96missubclass[m(exc_type, [38;5;121mKeyboardInterrupt[m):[55;185H[K[55;185H43,1[10C10%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;5H[93mdef[m [1m[96mhandle_exception[m(exc_type, exc_value, exc_traceback):[55;185H[K[55;185H42,1[11C9%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[93mdef[m [1m[96minstall_except_hook[m(rank):[55;185H[K[55;185H41,1[11C9%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H40,1[11C9%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# Utils: DDP init & exception hook[m[55;185H[K[55;185H39,1[11C9%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[96m# ---------------------------[m[55;185H[K[55;185H38,1[11C8%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H37,1[11C8%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;1H[38;5;81mfrom[m encodec [38;5;81mimport[m EncodecModel[55;185H[K[55;185H36,1[11C8%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m wandb[55;185H[K[55;185H35,1[11C7%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H34,1[11C7%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mfrom[m torch.utils.data.distributed [38;5;81mimport[m DistributedSampler[55;185H[K[55;185H33,1[11C7%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m torch.distributed [93mas[m dist[55;185H[K[55;185H32,0-1[9C7%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;1H[38;5;81mfrom[m torch.nn.utils.rnn [38;5;81mimport[m pad_sequence[55;185H[K[55;185H31,1[11C6%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mfrom[m torch.utils.data [38;5;81mimport[m DataLoader[55;185H[K[55;185H30,1[11C6%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m torch.nn.functional [93mas[m F[55;185H[K[55;185H29,0-1[9C6%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m torch.nn [93mas[m nn[55;185H[K[55;185H28,1[11C6%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m torch[55;185H[K[55;185H27,1[11C5%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[55;185H[K[55;185H26,1[11C5%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mfrom[m contextlib [38;5;81mimport[m nullcontext[55;185H[K[55;185H25,1[11C5%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m time[55;185H[K[55;185H24,1[11C4%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;1H[38;5;81mfrom[m datetime [38;5;81mimport[m datetime[55;185H[K[55;185H23,1[11C4%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m traceback[55;185H[K[55;185H22,1[11C4%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m logging[55;185H[K[55;185H21,0-1[9C4%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m argparse[55;185H[K[55;185H20,1[11C3%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m sys[55;185H[K[55;185H19,1[11C3%[6;1H[?25h[?25l[1;54r[1;1H[L[1;55r[1;1H[38;5;81mimport[m os[55;185H[K[55;185H18,1[11C3%[6;1H[?25h[?25l[55;175H~@k[6;1H[55;175H   [6;1H[1;54r[1;1H[L[1;55r[1;1H[95m"""[m[55;185H[K[55;185H17,1[11C3%[6;1H[?25h[?25l[55;186H8[7;1H[?25h[?25l[55;175H~@k[7;1H[55;175H   [8;1H[55;186H9[8;1H[?25h[?25l[55;185H20[9;1H[?25h[?25l[55;186H1,0-1[10;1H[?25h[?25l[55;175H~@k[10;1H[55;175H   [11;1H[55;186H2,1  [11;1H[?25h[?25l[55;186H3[12;1H[?25h[?25l[55;186H4[13;1H[?25h[?25l[55;175H~@k[13;1H[55;175H   [14;1H[55;186H5[14;1H[?25h[?25l[55;186H6[15;1H[?25h[?25l[55;186H7[16;1H[?25h[?25l[55;175H~@k[16;1H[55;175H   [17;1H[55;186H8[17;1H[?25h[?25l[55;186H9,0-1[18;1H[?25h[?25l[55;185H30,1  [19;1H[?25h[?25l[55;175H~@k[19;1H[55;175H   [20;1H[55;186H1[20;1H[?25h[?25l[55;186H2,0-1[21;1H[?25h[?25l[55;186H3,1  [22;1H[?25h[?25l[55;186H4[23;1H[?25h[?25l[55;186H5[24;1H[?25h[?25l[55;186H6[25;1H[?25h[?25l[55;175H~@k[25;1H[55;175H   [26;1H[55;186H7[26;1H[?25h[?25l[55;186H8[27;1H[?25h[?25l[55;186H9[28;1H[?25h[?25l[55;185H40[29;1H[?25h[?25l[55;186H1[30;1H[?25h[?25l[55;186H2[31;1H[?25h[?25l[55;186H3[32;1H[?25h[?25l[55;186H4[33;1H[?25h[?25l[55;186H5,0-1[34;1H[?25h[?25l[55;175H~@k[34;1H[55;175H   [35;1H[55;186H6,1  [35;1H[?25h[?25l[55;175H~@k[35;1H[55;175H   [36;1H[55;186H7[36;1H[?25h[?25l[55;186H8[37;1H[?25h[?25l[55;186H9[38;1H[?25h[?25l[55;185H50,0-1[39;1H[?25h[?25l[55;186H1,1  [40;1H[?25h[?25l[55;186H2[41;1H[?25h[?25l[55;175H~@k[41;1H[55;175H   [42;1H[55;186H3[42;1H[?25h[?25l[55;175H~@k[42;1H[55;175H   [43;1H[55;186H4,0-1[43;1H[?25h[?25l[55;186H5,1  [44;1H[?25h[?25l[55;186H6[45;1H[?25h[?25l[55;186H7[46;1H[?25h[?25l[55;175H~@k[46;1H[55;175H   [47;1H[55;186H8[47;1H[?25h[?25l[55;186H9,0-1[48;1H[?25h[?25l[55;185H60,1  [49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hlogfile = os.path.join(checkpoint_dir, f[95m"train_{timestamp}_rank{rank}.log"[m)[55;185H[K[55;185H61,1[11C3%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Hhandlers = [logging.StreamHandler()] [93mif[m rank != [95m0[m [93melse[m [logging.FileHandler(logfile), logging.StreamHandler()][55;185H[K[55;185H62,1[11C3%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hlogging.basicConfig([55;185H[K[55;185H63,1[11C3%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hlevel=log_level,[55;185H[K[55;185H64,1[11C4%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[1m[96mformat[m=[95m"%(asctime)s | %(levelname)s | %(message)s"[m,[55;185H[K[55;185H65,1[11C4%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hdatefmt=[95m"%Y-%m-%d %H:%M:%S"[m,[55;185H[K[55;185H66,1[11C4%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hhandlers=handlers[55;185H[K[55;185H67,1[11C4%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H)[55;185H[K[55;185H68,1[11C5%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hlogger = logging.getLogger([95m"lcm_train"[m)[55;185H[K[55;185H69,1[11C5%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hlogger.info(f[95m"Logging to {logfile} (rank {rank})"[m)[55;185H[K[55;185H70,1[11C5%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mreturn[m logger[55;185H[K[55;185H71,1[11C6%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H72,1[11C6%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H73,1[11C6%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# Collate[m[55;185H[K[55;185H74,1[11C6%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H75,1[11C7%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[93mdef[m [1m[96mcollate_fn[m(batch):[55;185H[K[55;185H76,1[11C7%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Hdegraded_list, teacher_list, mask_list = [1m[96mzip[m(*[(b[[95m0[m], b[[95m1[m], b[[95m2[m]) [93mfor[m b [93min[m batch])[55;185H[K[55;185H77,0-1[9C7%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hdegraded_list = [d.squeeze([95m0[m).transpose([95m0[m, [95m1[m) [93mfor[m d [93min[m degraded_list][55;185H[K[55;185H78,1[11C7%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hteacher_list = [t.squeeze([95m0[m).transpose([95m0[m, [95m1[m) [93mfor[m t [93min[m teacher_list][55;185H[K[55;185H79,1[11C8%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmask_list = [m.squeeze() [93mfor[m m [93min[m mask_list][55;185H[K[55;185H80,1[11C8%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hdegraded_padded = pad_sequence(degraded_list, batch_first=[1m[96mTrue[m, padding_value=[95m0[m)[55;185H[K[55;185H81,1[11C8%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hteacher_padded = pad_sequence(teacher_list, batch_first=[1m[96mTrue[m, padding_value=[95m0[m)[55;185H[K[55;185H82,1[11C9%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Hmask_padded = pad_sequence(mask_list, batch_first=[1m[96mTrue[m, padding_value=[95m0[m)[55;185H[K[55;185H83,1[11C9%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Hmask_padded = mask_padded.unsqueeze([95m1[m).expand(-[95m1[m, degraded_padded.shape[[95m2[m], -[95m1[m)[55;185H[K[55;185H84,1[11C9%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mreturn[m degraded_padded, teacher_padded, mask_padded[55;185H[K[55;185H85,1[11C9%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H86,1[10C10%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H87,1[10C10%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# Model[m[55;185H[K[55;185H88,1[10C10%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H89,1[10C10%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[93mclass[m [1m[96mLCM_MCB[m(nn.Module):[55;185H[K[55;185H90,1[10C11%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[93mdef[m [1m[96m__init__[m(self, vocab_size, n_codebooks, d_model=[95m256[m, n_heads=[95m4[m, num_layers=[95m4[m):[55;185H[K[55;185H91,0-1[8C11%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[1m[96msuper[m().__init__()[55;185H[K[55;185H92,1[10C11%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hself.n_codebooks = n_codebooks[55;185H[K[55;185H93,1[10C12%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hself.embedding = nn.Embedding(vocab_size, d_model)[55;185H[K[55;185H94,1[10C12%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hencoder_layer = nn.TransformerEncoderLayer([55;185H[K[55;185H95,1[10C12%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hd_model=d_model, nhead=n_heads, dim_feedforward=[95m4[m*d_model, batch_first=[1m[96mTrue[m[55;185H[K[55;185H96,1[10C12%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H)[55;185H[K[55;185H97,1[10C13%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hself.transformer = nn.TransformerEncoder(encoder_layer, num_layers=num_layers)[55;185H[K[55;185H98,1[10C13%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hself.output_heads = nn.ModuleList([nn.Linear(d_model, vocab_size) [93mfor[m _ [93min[m [1m[96mrange[m(n_codebooks)])[55;185H[K[55;185H99,1[10C13%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H100,1[9C13%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mdef[m [1m[96mforward[m(self, x, attention_mask=[1m[96mNone[m):[55;185H[K[55;185H101,1[9C14%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hlogits_list = [][55;185H[K[55;185H102,1[9C14%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mfor[m i [93min[m [1m[96mrange[m(self.n_codebooks):[55;185H[K[55;185H103,1[9C14%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Htokens = x[..., i][15C[96m# [B, S][m[55;185H[K[55;185H104,1[9C15%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hx_emb = self.embedding(tokens)   [96m# [B, S, D][m[55;185H[K[55;185H105,0-1[7C15%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hsrc_key_padding_mask = (attention_mask[:, i, :] == [95m0[m) [93mif[m attention_mask [93mis[m [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m[55;185H[K[55;185H106,1[9C15%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hx_trans = self.transformer(x_emb, src_key_padding_mask=src_key_padding_mask)[55;185H[K[55;185H107,1[9C15%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hlogits_list.append(self.output_heads[i](x_trans))[55;185H[K[55;185H108,1[9C16%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mreturn[m torch.stack(logits_list, dim=-[95m1[m)  [96m# [B, S, vocab, n_codebooks][m[55;185H[K[55;185H109,1[9C16%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H110,1[9C16%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H111,1[9C16%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# Losses[m[55;185H[K[55;185H112,1[9C17%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H113,1[9C17%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;1H[93mclass[m [1m[96mMultiResolutionSTFTLoss[m(nn.Module):[55;185H[K[55;185H114,1[9C17%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mdef[m [1m[96m__init__[m(self, fft_sizes=[[95m512[m, [95m1024[m, [95m2048[m], hop_sizes=[[95m128[m, [95m256[m, [95m512[m], win_lengths=[[95m512[m, [95m1024[m, [95m2048[m]):[55;185H[K[55;185H115,0-1[7C18%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[1m[96msuper[m().__init__()[55;185H[K[55;185H116,1[9C18%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hself.fft_sizes = fft_sizes[55;185H[K[55;185H117,1[9C18%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hself.hop_sizes = hop_sizes[55;185H[K[55;185H118,1[9C18%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hself.win_lengths = win_lengths[55;185H[K[55;185H119,1[9C19%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H120,1[9C19%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[93mdef[m [1m[96mforward[m(self, x, y):[55;185H[K[55;185H121,1[9C19%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hx = x.squeeze([95m1[m) [93mif[m x.dim() == [95m3[m [93melse[m x[55;185H[K[55;185H122,1[9C19%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hy = y.squeeze([95m1[m) [93mif[m y.dim() == [95m3[m [93melse[m y[55;185H[K[55;185H123,1[9C20%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hdevice = x.device[55;185H[K[55;185H124,1[9C20%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hloss = [95m0.0[m[55;185H[K[55;185H125,0-1[7C20%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mfor[m n_fft, hop, win [93min[m [1m[96mzip[m(self.fft_sizes, self.hop_sizes, self.win_lengths):[55;185H[K[55;185H126,1[9C21%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hwin_tensor = torch.hann_window(win, device=device)[55;185H[K[55;185H127,1[9C21%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13HX = torch.stft(x, n_fft=n_fft, hop_length=hop, win_length=win, window=win_tensor, return_complex=[1m[96mTrue[m)[55;185H[K[55;185H128,1[9C21%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13HY = torch.stft(y, n_fft=n_fft, hop_length=hop, win_length=win, window=win_tensor, return_complex=[1m[96mTrue[m)[55;185H[K[55;185H129,1[9C21%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hmag_x = torch.abs(X)[55;185H[K[55;185H130,1[9C22%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hmag_y = torch.abs(Y)[55;185H[K[55;185H131,1[9C22%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hsc_loss = torch.norm(mag_y - mag_x, p=[95m'fro'[m) / (torch.norm(mag_y, p=[95m'fro'[m) + [95m1e-8[m)[55;185H[K[55;185H132,1[9C22%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hmag_loss = F.l1_loss(torch.log1p(mag_x), torch.log1p(mag_y))[55;185H[K[55;185H133,1[9C22%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hloss += sc_loss + mag_loss[55;185H[K[55;185H134,1[9C23%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9H[93mreturn[m loss / [1m[96mlen[m(self.fft_sizes)[55;185H[K[55;185H135,1[9C23%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H136,1[9C23%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[93mclass[m [1m[96mWaveformL1Loss[m(nn.Module):[55;185H[K[55;185H137,1[9C24%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[93mdef[m [1m[96m__init__[m(self):[55;185H[K[55;185H138,1[9C24%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9H[1m[96msuper[m().__init__()[55;185H[K[55;185H139,1[9C24%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hself.l1 = nn.L1Loss()[55;185H[K[55;185H140,1[9C24%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[93mdef[m [1m[96mforward[m(self, x, y):[55;185H[K[55;185H141,0-1[7C25%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9H[93mreturn[m self.l1(x, y)[55;185H[K[55;185H142,1[9C25%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H143,1[9C25%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H144,1[9C25%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# Checkpoint utils[m[55;185H[K[55;185H145,1[9C26%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H146,1[9C26%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[93mdef[m [1m[96mlatest_checkpoint[m(checkpoint_dir):[55;185H[K[55;185H147,1[9C26%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hckpts = [os.path.join(checkpoint_dir, f) [93mfor[m f [93min[m os.listdir(checkpoint_dir) [93mif[m f.endswith([95m".pt"[m)][55;185H[K[55;185H148,0-1[7C27%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mreturn[m [1m[96mmax[m(ckpts, key=os.path.getmtime) [93mif[m ckpts [93melse[m [1m[96mNone[m[55;185H[K[55;185H149,1[9C27%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H150,1[9C27%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[93mdef[m [1m[96mload_checkpoint_compatible[m(model, ckpt_path, device, ddp):[55;185H[K[55;185H151,1[9C27%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hcheckpoint = torch.load(ckpt_path, map_location=device)[55;185H[K[55;185H152,1[9C28%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Hstate_dict = checkpoint.get([95m"model_state_dict"[m) [93mor[m checkpoint.get([95m"state_dict"[m) [93mor[m checkpoint.get([95m"model"[m)[55;185H[K[55;185H153,1[9C28%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m state_dict [93mis[m [1m[96mNone[m:[55;185H[K[55;185H154,1[9C28%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9H[93mraise[m [38;5;121mKeyError[m([95m"No model weights found in checkpoint"[m)[55;185H[K[55;185H155,0-1[7C28%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hnew_state = {}[55;185H[K[55;185H156,1[9C29%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[93mfor[m k, v [93min[m state_dict.items():[55;185H[K[55;185H157,1[9C29%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9H[93mif[m k.startswith([95m"module."[m) [93mand[m [93mnot[m ddp:[55;185H[K[55;185H158,1[9C29%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hnew_state[k[[1m[96mlen[m([95m"module."[m):]] = v[55;185H[K[55;185H159,1[9C30%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93melif[m [93mnot[m k.startswith([95m"module."[m) [93mand[m ddp:[55;185H[K[55;185H160,1[9C30%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hnew_state[[95m"module."[m + k] = v[55;185H[K[55;185H161,1[9C30%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9H[93melse[m:[55;185H[K[55;185H162,1[9C30%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hnew_state[k] = v[55;185H[K[55;185H163,1[9C31%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmodel.load_state_dict(new_state, strict=[1m[96mTrue[m)[55;185H[K[55;185H164,1[9C31%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[93mreturn[m checkpoint[55;185H[K[55;185H165,1[9C31%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H166,1[9C31%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H167,1[9C32%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# Validation[m[55;185H[K[55;185H168,1[9C32%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H169,1[9C32%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;1H[93mdef[m [1m[96mvalidate_one_epoch[m(val_loader, model, device, encodec_model, n_codebooks, lambda_waveform, lambda_stft, is_ddp):[55;185H[K[55;185H170,1[9C33%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Hmodel.eval()[55;185H[K[55;185H171,0-1[7C33%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmrstft = MultiResolutionSTFTLoss()[55;185H[K[55;185H172,1[9C33%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Hwf_fn = WaveformL1Loss()[55;185H[K[55;185H173,1[9C33%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Htotal = total_ce = total_stft = total_wf = count = [95m0.0[m[55;185H[K[55;185H174,1[9C34%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H175,1[9C34%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[93mwith[m torch.no_grad():[55;185H[K[55;185H176,1[9C34%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9H[93mfor[m degraded, teacher, mask [93min[m val_loader:[55;185H[K[55;185H177,1[9C34%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hdegraded, teacher, mask = degraded.to(device), teacher.to(device), mask.to(device)[55;185H[K[55;185H178,1[9C35%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hlogits = model(degraded, attention_mask=mask)[55;185H[K[55;185H179,1[9C35%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H180,0-1[7C35%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hce = [95m0.0[m[55;185H[K[55;185H181,1[9C36%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[93mfor[m i [93min[m [1m[96mrange[m(n_codebooks):[55;185H[K[55;185H182,1[9C36%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;17Hce += F.cross_entropy(logits[..., i].transpose([95m1[m,[95m2[m), teacher[..., i], reduction=[95m'mean'[m)[55;185H[K[55;185H183,1[9C36%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hce = ce / n_codebooks[55;185H[K[55;185H184,1[9C36%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H185,0-1[7C37%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hpred_tokens = torch.argmax(logits, dim=[95m2[m).transpose([95m1[m,[95m2[m)[55;185H[K[55;185H186,1[9C37%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hteacher_codes = teacher.transpose([95m1[m,[95m2[m)[55;185H[K[55;185H187,1[9C37%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hpred_wav = encodec_model.decode([(pred_tokens, [1m[96mNone[m)])[55;185H[K[55;185H188,1[9C37%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htgt_wav = encodec_model.decode([(teacher_codes, [1m[96mNone[m)])[55;185H[K[55;185H189,1[9C38%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H190,0-1[7C38%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hstft_l = mrstft(pred_wav, tgt_wav)[55;185H[K[55;185H191,1[9C38%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hwf_l = wf_fn(pred_wav, tgt_wav)[55;185H[K[55;185H192,1[9C39%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hloss = ce + lambda_waveform * wf_l + lambda_stft * stft_l[55;185H[K[55;185H193,1[9C39%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H194,1[9C39%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hbsz = degraded.size([95m0[m)[55;185H[K[55;185H195,0-1[7C39%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htotal += loss.item() * bsz[55;185H[K[55;185H196,1[9C40%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htotal_ce += ce.item() * bsz[55;185H[K[55;185H197,1[9C40%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htotal_stft += stft_l.item() * bsz[55;185H[K[55;185H198,1[9C40%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htotal_wf += wf_l.item() * bsz[55;185H[K[55;185H199,0-1[7C40%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hcount += bsz[55;185H[K[55;185H200,1[9C41%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H201,1[9C41%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m is_ddp:[55;185H[K[55;185H202,1[9C41%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Ht = torch.tensor([total, total_ce, total_stft, total_wf, count], device=device)[55;185H[K[55;185H203,1[9C42%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hdist.all_reduce(t, op=dist.ReduceOp.SUM)[55;185H[K[55;185H204,1[9C42%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Htotal, total_ce, total_stft, total_wf, count = [t[i].item() [93mfor[m i [93min[m [1m[96mrange[m([95m5[m)][55;185H[K[55;185H205,1[9C42%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H206,0-1[7C42%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hmodel.train()[55;185H[K[55;185H207,1[9C43%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m count == [95m0[m:[55;185H[K[55;185H208,1[9C43%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9H[93mreturn[m [1m[96mNone[m[55;185H[K[55;185H209,1[9C43%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mreturn[m {[95m"loss"[m: total/count, [95m"ce"[m: total_ce/count, [95m"stft"[m: total_stft/count, [95m"waveform"[m: total_wf/count}[55;185H[K[55;185H210,1[9C43%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H211,0-1[7C44%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H212,1[9C44%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[96m# Training (with synchronized OOM handling + AMP + accumulation)[m[55;185H[K[55;185H213,1[9C44%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;1H[96m# ---------------------------[m[55;185H[K[55;185H214,1[9C45%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;1H[93mdef[m [1m[96mtrain[m(dataset, model, train_sampler, val_dataset, args, device, rank, local_rank, world_size, is_ddp):[55;185H[K[55;185H215,1[9C45%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hlogger = setup_logging(args.checkpoint_dir, rank=rank)[55;185H[K[55;185H216,0-1[7C45%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hinstall_except_hook(rank)[55;185H[K[55;185H217,1[9C45%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H218,1[9C46%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hn_codebooks = args.n_codebooks[55;185H[K[55;185H219,1[9C46%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m [93mnot[m [1m[96mhasattr[m(args, [95m"accum_steps"[m):[55;185H[K[55;185H220,1[9C46%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hargs.accum_steps = [95m4[m[55;185H[K[55;185H221,1[9C46%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H222,1[9C47%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# helper to build train loader (recreated if batch size changes)[m[55;185H[K[55;185H223,0-1[7C47%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5H[93mdef[m [1m[96mmake_train_loader[m():[55;185H[K[55;185H224,1[9C47%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mreturn[m DataLoader(dataset, batch_size=args.per_step_batch_size, sampler=train_sampler, collate_fn=collate_fn)[55;185H[K[55;185H225,1[9C48%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H226,1[9C48%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Htrain_loader = make_train_loader()[55;185H[K[55;185H227,0-1[7C48%[49;1H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;5Hval_loader = DataLoader(val_dataset, batch_size=args.val_batch_size, sampler=DistributedSampler(val_dataset) [93mif[m is_ddp [93mand[m val_dataset [93mis[m [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m, collate_fn=collate_fn) [93mif[m val_dataset [93miss[m[54;1H [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m[55;185H[K[55;185H228,1[9C49%[48;1H[?25h[?25l[55;187H9[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H230,1[9C49%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hoptimizer = torch.optim.AdamW(model.parameters(), lr=args.lr, weight_decay=[1m[96mgetattr[m(args, [95m"weight_decay"[m, [95m0.0[m))[55;185H[K[55;185H231,0-1[7C49%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# lambda scheduler: warmup then linear decay[m[55;185H[K[55;185H232,1[9C49%[49;1H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;5Hwarmup_steps = [1m[96mgetattr[m(args, [95m"warmup_steps"[m, [95m500[m)
    [93mdef[m [1m[96mlr_lambda[m(step):[55;185H[K[55;185H233,1[9C50%[48;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mif[m step < warmup_steps:[55;185H[K[55;185H234,0-1[7C50%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[93mreturn[m [1m[96mfloat[m(step + [95m1[m) / [1m[96mfloat[m([1m[96mmax[m([95m1[m, warmup_steps))[55;185H[K[55;185H235,1[9C50%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Htotal_steps = args.epochs * [1m[96mmax[m([95m1[m, [1m[96mlen[m(train_loader))[55;185H[K[55;185H236,1[9C51%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mreturn[m [1m[96mmax[m([95m0.0[m, [1m[96mfloat[m(total_steps - step) / [1m[96mfloat[m([1m[96mmax[m([95m1[m, total_steps - warmup_steps)))[55;185H[K[55;185H237,1[9C51%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hscheduler = torch.optim.lr_scheduler.LambdaLR(optimizer, lr_lambda)[55;185H[K[55;185H238,1[9C51%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[55;185H[K[55;185H239,1[9C52%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hencodec_model = EncodecModel.encodec_model_24khz().to(device)[55;185H[K[55;185H240,1[9C52%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hencodec_model.eval()[55;185H[K[55;185H241,1[9C52%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H242,1[9C52%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Hstft_fn = MultiResolutionSTFTLoss()[55;185H[K[55;185H243,1[9C53%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hwf_fn = WaveformL1Loss()[55;185H[K[55;185H244,0-1[7C53%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H245,1[9C53%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[96m# resume[m[55;185H[K[55;185H246,1[9C53%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;5Hstart_epoch = [95m0[m[55;185H[K[55;185H247,0-1[7C54%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m [1m[96mgetattr[m(args, [95m"resume"[m, [1m[96mFalse[m):[55;185H[K[55;185H248,1[9C54%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;9Hckpt = latest_checkpoint(args.checkpoint_dir)[55;185H[K[55;185H249,1[9C54%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mif[m ckpt:[55;185H[K[55;185H250,0-1[7C55%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hlogger.info(f[95m"Resuming from {ckpt}"[m)[55;185H[K[55;185H251,1[9C55%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13Hloaded = load_checkpoint_compatible(model, ckpt, device, ddp=is_ddp)[55;185H[K[55;185H252,1[9C55%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13H[93mif[m [95m"optimizer_state_dict"[m [93min[m loaded:[55;185H[K[55;185H253,1[9C55%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;17Hoptimizer.load_state_dict(loaded[[95m"optimizer_state_dict"[m])[55;185H[K[55;185H254,1[9C56%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [49;1H[1;54r[54;1H
[1;55r[54;13H[93mif[m [95m"scheduler_state_dict"[m [93min[m loaded:[55;185H[K[55;185H255,1[9C56%[49;1H[?25h[?25l[55;175H~@k[49;1H[55;175H   [48;1H[55;187H4[48;1H[?25h[?25l[55;175H~@k[48;1H[55;175H   [47;1H[55;187H3[47;1H[?25h[?25l[55;175H~@k[47;1H[55;175H   [46;1H[55;187H2[46;1H[?25h[?25l[55;175H~@k[46;1H[55;175H   [45;1H[55;187H1[45;1H[?25h[?25l[55;175H~@k[45;1H[55;175H   [44;1H[55;187H0,0-1[44;1H[?25h[?25l[55;175H~@k[44;1H[55;175H   [43;1H[55;186H49,1  [43;1H[?25h[?25l[55;175H~@k[43;1H[55;175H   [42;1H[55;187H8[42;1H[?25h[?25l[55;175H~@k[42;1H[55;175H   [41;1H[55;187H7,0-1[41;1H[?25h[?25l[55;175H~@k[41;1H[55;175H   [40;1H[55;187H6,1  [40;1H[?25h[?25l[55;175H~@k[40;1H[55;175H   [39;1H[55;187H5[39;1H[?25h[?25l[55;175H~@k[39;1H[55;175H   [38;1H[55;187H4,0-1[38;1H[?25h[?25l[55;175H~@k[38;1H[55;175H   [37;1H[55;187H3,1  [37;1H[?25h[?25l[55;175H~@k[37;1H[55;175H   [36;1H[55;187H2[36;1H[?25h[?25l[55;175H~@k[36;1H[55;175H   [35;1H[55;187H1[35;1H[?25h[?25l[55;175H~@k[35;1H[55;175H   [34;1H[55;187H0[34;1H[?25h[?25l[55;175H~@k[34;1H[55;175H   [33;1H[55;186H39[33;1H[?25h[?25l[55;175H~@k[33;1H[55;175H   [32;1H[55;187H8[32;1H[?25h[?25l[55;175H~@k[32;1H[55;175H   [31;1H[55;187H7[31;1H[?25h[?25l[55;175H~@k[31;1H[55;175H   [30;1H[55;187H6[30;1H[?25h[?25l[55;175H~@k[30;1H[55;175H   [29;1H[55;187H5[29;1H[?25h[?25l[55;175H~@k[29;1H[55;175H   [28;1H[55;187H4,0-1[28;1H[?25h[?25l[55;175H~@k[28;1H[55;175H   [26;1H[55;187H3,1  [26;1H[?25h[?25l[55;175H~@k[26;1H[55;175H   [25;1H[55;187H2[25;1H[?25h[?25l[55;175H~@k[25;1H[55;175H   [25;2H[55;189H2[25;2H[?25h[?25l[55;175H~@k[25;2H[55;175H   [25;3H[55;189H3[25;3H[?25h[?25l[55;175H~@k[25;3H[55;175H   [25;4H[55;189H4[25;4H[?25h[?25l[55;175H~@k[25;4H[55;175H   [25;5H[55;189H5[25;5H[?25h[?25l[55;175H~@k[25;5H[55;175H   [25;6H[55;189H6[25;6H[?25h[?25l[55;175H~@k[25;6H[55;175H   [25;7H[55;189H7[25;7H[?25h[?25l[55;175H~@k[25;7H[55;175H   [25;8H[55;189H8[25;8H[?25h[?25l[55;175H~@k[25;8H[55;175H   [25;9H[55;189H9[25;9H[?25h[?25l[55;175H~@k[25;9H[55;175H   [25;10H[55;189H10[25;10H[?25h[?25l[55;175H~@k[25;10H[55;175H   [25;11H[55;190H1[25;11H[?25h[?25l[55;175H~@k[25;11H[55;175H   [25;12H[55;190H2[25;12H[?25h[?25l[55;175H~@k[25;12H[55;175H   [25;13H[55;190H3[25;13H[?25h[?25l[55;175H~@k[25;13H[55;175H   [25;14H[55;190H4[25;14H[?25h[?25l[55;175H~@k[25;14H[55;175H   [25;15H[55;190H5[25;15H[?25h[?25l[55;175H~@k[25;15H[55;175H   [25;16H[55;190H6[25;16H[?25h[?25l[55;175H~@k[25;16H[55;175H   [25;17H[55;190H7[25;17H[?25h[?25l[55;175H~@k[25;17H[55;175H   [25;18H[55;190H8[25;18H[?25h[?25l[55;175H~@k[25;18H[55;175H   [25;19H[55;190H9[25;19H[?25h[?25l[55;175H~@k[25;19H[55;175H   [25;20H[55;189H20[25;20H[?25h[?25l[55;175H~@k[25;20H[55;175H   [25;21H[55;190H1[25;21H[?25h[?25l[55;175H~@k[25;21H[55;175H   [25;22H[55;190H2[25;22H[?25h[?25l[55;175H~@k[25;22H[55;175H   [25;23H[55;190H3[25;23H[?25h[?25l[55;175H~@k[25;23H[55;175H   [25;24H[55;190H4[25;24H[?25h[?25l[55;175H~@k[25;24H[55;175H   [25;25H[55;190H5[25;25H[?25h[?25l[55;175H~@k[25;25H[55;175H   [25;26H[55;190H6[25;26H[?25h[?25l[55;175H~@k[25;26H[55;175H   [25;27H[55;190H7[25;27H[?25h[?25l[55;175H~@k[25;27H[55;175H   [25;28H[55;190H8[25;28H[?25h[?25l[55;175H~@k[25;28H[55;175H   [25;29H[55;190H9[25;29H[?25h[?25l[55;175H~@k[25;29H[55;175H   [25;30H[55;189H30[25;30H[?25h[?25l[55;175H~@k[25;30H[55;175H   [25;31H[55;190H1[25;31H[?25h[?25l[55;175H~@k[25;31H[55;175H   [25;32H[55;190H2[25;32H[?25h[?25l[55;175H~@k[25;32H[55;175H   [25;33H[55;190H3[25;33H[?25h[?25l[55;175H~@k[25;33H[55;175H   [25;34H[55;190H4[25;34H[?25h[?25l[55;175H~@k[25;34H[55;175H   [25;35H[55;190H5[25;35H[?25h[?25l[55;175H~@k[25;35H[55;175H   [25;36H[55;190H6[25;36H[?25h[?25l[55;175H~@k[25;36H[55;175H   [25;37H[46m()[m[55;190H7[25;37H[?25h[?25l[55;175H~@k[25;37H[55;175H   [25;38H[55;190H8[25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [25;38H[?25h[?25l[55;175H~@k[25;38H[55;175H   [24;1H[25;37H()[55;187H1,0-1[24;1H[?25h[?25l[55;175H~@k[24;1H[55;175H   [24;1H[?25h[?25l[55;175H~@k[24;1H[55;175H   [23;38H[55;187H0,38 [23;38H[?25h[?25l[55;175H~@k[23;38H[55;175H   [23;39H[55;190H9[23;39H[?25h[?25l[55;175H~@k[23;39H[55;175H   [23;40H[55;189H40[23;40H[?25h[?25l[55;175H~@k[23;40H[55;175H   [23;41H[55;190H1[23;41H[?25h[?25l[55;175H~@k[23;41H[55;175H   [23;42H[55;190H2[23;42H[?25h[?25l[55;175H~@k[23;42H[55;175H   [23;43H[55;190H3[23;43H[?25h[?25l[55;175H~@k[23;43H[55;175H   [23;44H[55;190H4[23;44H[?25h[?25l[55;175H~@k[23;44H[55;175H   [23;45H[55;190H5[23;45H[?25h[?25l[55;175H~@k[23;45H[55;175H   [23;46H[55;190H6[23;46H[?25h[?25l[55;175H~@k[23;46H[55;175H   [23;47H[55;190H7[23;47H[?25h[?25l[55;175H~@k[23;47H[55;175H   [23;48H[55;190H8[23;48H[?25h[?25l[55;175H~@k[23;48H[55;175H   [23;49H[55;190H9[23;49H[?25h[?25l[55;175H~@k[23;49H[55;175H   [23;50H[55;189H50[23;50H[?25h[?25l[55;175H~@k[23;50H[55;175H   [23;51H[55;190H1[23;51H[?25h[?25l[55;175H~@k[23;51H[55;175H   [23;52H[55;190H2[23;52H[?25h[?25l[55;175H~@k[23;52H[55;175H   [23;53H[55;190H3[23;53H[?25h[?25l[55;175H~@k[23;53H[55;175H   [23;54H[55;190H4[23;54H[?25h[?25l[55;175H~@k[23;54H[55;175H   [23;55H[55;190H5[23;55H[?25h[?25l[55;175H~@k[23;55H[55;175H   [23;56H[55;190H6[23;56H[?25h[?25l[55;175H~@k[23;56H[55;175H   [23;57H[55;190H7[23;57H[?25h[?25l[55;175H~@k[23;57H[55;175H   [23;58H[55;190H8[23;58H[?25h[?25l[55;175H~@k[23;58H[55;175H   [23;59H[55;190H9[23;59H[?25h[?25l[55;175H~@k[23;59H[55;175H   [23;60H[55;189H60[23;60H[?25h[?25l[55;175H~@k[23;60H[55;175H   [23;61H[55;190H1[23;61H[?25h[?25l[55;175H~@k[23;61H[55;175H   [23;62H[55;190H2[23;62H[?25h[?25l[55;175H~@k[23;62H[55;175H   [23;63H[55;190H3[23;63H[?25h[?25l[55;175H~@k[23;63H[55;175H   [23;62H[55;190H2[23;62H[?25h[?25l[55;175H~@k[23;62H[55;175H   [23;61H[55;190H1[23;61H[?25h[?25l[55;175Hi[23;61H[55;175H [23;61H[55;1H[1m-- INSERT --[m[55;185H[K[55;185H230,61[8C56%[23;61H[?25h[?25lbatch_size, sampler=train_sampler, collate_fn=collate_fn)[23;117H[K[55;190H0[23;60H[?25h[?25lbatch_size, sampler=train_sampler, collate_fn=collate_fn)[23;116H[K[55;189H59[23;59H[?25h[?25lbatch_size, sampler=train_sampler, collate_fn=collate_fn)[23;115H[K[55;190H8[23;58H[?25h[?25lbatch_size, sampler=train_sampler, collate_fn=collate_fn)[23;114H[K[55;190H7[23;57H[?25h[?25lbatch_size, sampler=train_sampler, collate_fn=collate_fn)[23;113H[K[55;190H6[23;56H[?25h[?25lbatch_size, sampler=train_sampler, collate_fn=collate_fn)[23;112H[K[55;190H5[23;55H[?25h[?25lbatch_size, sampler=train_sampler, collate_fn=collate_fn)[23;111H[K[55;190H4[23;54H[?25h[?25lbatch_size, sampler=train_sampler, collate_fn=collate_fn)[23;110H[K[55;190H3[23;53H[?25h[?25lbatch_size, sampler=train_sampler, collate_fn=collate_fn)[23;109H[K[55;190H2[23;52H[?25h[?25l[55;187H1,1 [24;1H[?25h[?25l[25;37H[46m()[m[55;187H2,39[25;39H[?25h[?25l()[55;187H3,52[26;52H[?25h[?25l[55;187H4,1 [28;1H[?25h[?25l[29;51H[46m()[m[55;187H5,52[29;52H[?25h[?25l()[55;187H6,49[30;49H[?25h[?25l[55;187H7,52[31;52H[?25h[?25l[55;187H8,25[32;25H[?25h[?25l[55;187H9,32[33;32H[?25h[?25l[55;186H40,5[34;52H[?25h[?25l[55;187H1[35;52H[?25h[?25l[55;187H2[36;52H[?25h[?25l[55;187H3[37;52H[?25h[?25l[55;187H4,1 [38;1H[?25h[?25l[55;187H5,52[39;52H[?25h[?25l[40;23H[46m()[m[55;187H6,25[40;25H[?25h[?25l()[55;187H7,1 [41;1H[?25h[?25l[42;38H[46m()[m[55;187H8,40[42;40H[?25h[?25l()[43;27H[46m()[m[55;187H9,29[43;29H[?25h[?25l()[55;186H50,1 [44;1H[?25h[?25l[55;187H1,13[45;13H[?25h[?25l[55;187H2,20[46;20H[?25h[?25l[55;187H3,39[47;39H[?25h[?25l[55;187H4,52[48;52H[?25h[?25l[55;187H5,17[49;17H[?25h[?25l[1;54r[54;1H
[1;55r[54;17Hscheduler.load_state_dict(loaded[[95m"scheduler_state_dict"[m])[55;185H[K[55;185H256,49[8C56%[49;24H[46m([23C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;13Hstart_epoch = loaded.get([95m"epoch"[m, [95m0[m)[55;185H[K[55;185H257,52[8C56%[48;24H([23C)[49;52H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93melse[m:[55;185H[K[55;185H258,49[8C57%[49;49H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hlogger.info([95m"No checkpoint found; starting fresh"[m)[55;185H[K[55;185H259,52[8C57%[49;52H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H260,49[8C57%[49;49H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mif[m rank == [95m0[m:[55;185H[K[55;185H261,52[8C58%[49;52H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hwandb.init(project=[1m[96mgetattr[m(args, [95m"wandb_project"[m, [95m"lcm-training"[m), config=[1m[96mvars[m(args), resume=[95m"allow"[m [93mif[m [1m[96mgetattr[m(args, [95m"resume"[m, [1m[96mFalse[m) [93melse[m [1m[96mNone[m)[55;185H[K[55;185H262,49[8C58%[49;37H[46m([10C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;9Hwandb.watch(model, log=[95m"gradients"[m [93mif[m [1m[96mgetattr[m(args, [95m"log_grads"[m, [1m[96mFalse[m) [93melse[m [1m[96mNone[m)[55;185H[K[55;185H263,14[8C58%[48;37H([10C)[49;14H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H264,52[8C58%[49;52H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hscaler = torch.cuda.amp.GradScaler()[55;185H[K[55;185H265,1[9C59%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Haccum_steps = [1m[96mint[m([1m[96mgetattr[m(args, [95m"accum_steps"[m, [95m4[m))[55;185H[K[55;185H266,18[8C59%[49;18H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H267,52[8C59%[49;52H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hlogger.info(f[95m"Starting training: epochs={args.epochs}, per_step_batch_size={args.per_step_batch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[55;185H[K[55;185H268,52[8C59%[49;52H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H269,1[9C60%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;5H[93mfor[m epoch [93min[m [1m[96mrange[m(start_epoch, args.epochs):[55;185H[K[55;185H270,41[8C60%[49;39H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;9H[93mif[m is_ddp:[55;185H[K[55;185H271,52[8C60%[48;39H()[49;52H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htrain_sampler.set_epoch(epoch) [93mif[m train_sampler [93mis[m [93mnot[m [1m[96mNone[m [93melse[m [1m[96mNone[m[55;185H[K[55;185H272,1[9C61%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hmodel.train()[55;185H[K[55;185H273,52[8C61%[49;52H[?25h[?25l[55;190H3[49;53H[?25h[?25l[55;190H4[49;54H[?25h[?25l[55;190H5[49;55H[?25h[?25l[55;190H6[49;56H[?25h[?25l[49;45H[95m[46m{[11C}[m[55;190H7[49;57H[?25h[?25l[55;190H8[49;58H[?25h[?25l[49;45H[95m{[11C}[m[55;190H9[49;59H[?25h[?25l[55;189H60[49;60H[?25h[?25l[55;190H1[49;61H[?25h[?25l[55;190H2[49;62H[?25h[?25l[55;190H3[49;63H[?25h[?25l[55;190H4[49;64H[?25h[?25l[55;190H5[49;65H[?25h[?25l[55;190H6[49;66H[?25h[?25l[55;190H7[49;67H[?25h[?25l[55;190H8[49;68H[?25h[?25l[55;190H9[49;69H[?25h[?25l[55;189H70[49;70H[?25h[?25l[55;190H1[49;71H[?25h[?25l[55;190H2[49;72H[?25h[?25l[55;190H3[49;73H[?25h[?25l[55;190H4[49;74H[?25h[?25l[55;190H5[49;75H[?25h[?25l[55;190H6[49;76H[?25h[?25l[55;190H7[49;77H[?25h[?25l[55;190H8[49;78H[?25h[?25l[55;190H9[49;79H[?25h[?25l[1C[95m[46m{[24C}[m[55;189H80[49;80H[?25h[?25l[55;190H1[49;81H[?25h[?25l[95m{[24C}[m[55;190H2[49;82H[?25h[?25l[55;190H3[49;83H[?25h[?25l[55;190H4[49;84H[?25h[?25l[55;190H5[49;85H[?25h[?25l[55;190H6[49;86H[?25h[?25l[55;190H7[49;87H[?25h[?25l[55;190H8[49;88H[?25h[?25l[55;190H9[49;89H[?25h[?25l[55;189H90[49;90H[?25h[?25l[55;190H1[49;91H[?25h[?25l[55;190H2[49;92H[?25h[?25l[55;190H3[49;93H[?25h[?25l[55;190H4[49;94H[?25h[?25l[55;190H5[49;95H[?25h[?25l[55;190H6[49;96H[?25h[?25l[55;190H5[49;95H[?25h[?25l[95mbatch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[49;148H[K[55;190H4[49;94H[?25h[?25l[95mbatch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[49;147H[K[55;190H3[49;93H[?25h[?25l[95mbatch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[49;146H[K[55;190H2[49;92H[?25h[?25l[95mbatch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[49;145H[K[55;190H1[49;91H[?25h[?25l[95mbatch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[49;144H[K[55;190H0[49;90H[?25h[?25l[95mbatch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[49;143H[K[55;189H89[49;89H[?25h[?25l[95mbatch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[49;142H[K[55;190H8[49;88H[?25h[?25l[95mbatch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[49;141H[K[55;190H7[49;87H[?25h[?25l[95mbatch_size}, accum_steps={accum_steps}, ddp={is_ddp}"[m)[49;140H[K[55;190H6[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H274,1[9C61%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[96m# Create fresh loader in case it was recreated after OOM[m[55;185H[K[55;185H275,50[8C61%[49;50H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Htrain_loader = make_train_loader()[55;185H[K[55;185H276,19[8C62%[49;19H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H277,82[8C62%[49;82H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hepoch_loss = epoch_ce = epoch_stft = epoch_wf = epoch_count = [95m0.0[m[55;185H[K[55;185H278,22[8C62%[49;20H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;9Hrestart_epoch = [1m[96mFalse[m[55;185H[K[55;185H279,1[9C62%[48;20H()
[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H280,65[8C63%[49;65H[?25h[?25l[1;54r[1;1H[2M[1;55r[53;9Hoptimizer.zero_grad()[54;9H[96m# iterate with index to enable no_sync decisions[m[55;185H[K[55;185H281,43[8C63%[48;41H[46m()[?25h[?25l[m()[55;187H2,1 [49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mfor[m batch_idx, (degraded, teacher, mask) [93min[m [1m[96menumerate[m(train_loader):[55;185H[K[55;185H283,74[8C63%[49;74H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hdegraded, teacher, mask = degraded.to(device), teacher.to(device), mask.to(device)[55;185H[K[55;185H284,30[8C64%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H285,1[9C64%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[96m# choose no_sync context for DDP when not stepping this iter[m[55;185H[K[55;185H286,30[8C64%[49;28H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;13Huse_no_sync = is_ddp [93mand[m ((batch_idx + [95m1[m) % accum_steps != [95m0[m)[55;185H[K[55;185H287,57[8C65%[48;28H()[49;57H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hddp_ctx = model.no_sync [93mif[m use_no_sync [93melse[m nullcontext[55;185H[K[55;185H288,77[8C65%[49;77H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H289,86[8C65%[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[93mtry[m:[55;185H[K[55;185H290,1[9C65%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[93mwith[m ddp_ctx():[55;185H[K[55;185H291,73[8C66%[49;73H[?25h[?25l[1;54r[54;1H
[1;55r[54;21H[93mwith[m torch.cuda.amp.autocast():[55;185H[K[55;185H292,74[8C66%[49;38H[46m([34C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hlogits = model(degraded, attention_mask=mask)  [96m# [B, S, vocab, n_codebooks][m[55;185H[K[55;185H293,68[8C66%[48;38H([34C)[49;68H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hce_loss = [95m0.0[m[55;185H[K[55;185H294,1[9C66%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[93mfor[m i [93min[m [1m[96mrange[m(n_codebooks):[55;185H[K[55;185H295,17[8C67%[49;17H[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hce_loss += F.cross_entropy(logits[..., i].transpose([95m1[m,[95m2[m), teacher[..., i], reduction=[95m'mean'[m)[55;185H[K[55;185H296,32[8C67%[49;32H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hce_loss = ce_loss / [1m[96mfloat[m(n_codebooks)[55;185H[K[55;185H297,52[8C67%[49;52H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H298,86[8C68%[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[96m# decode under no_grad()[m[55;185H[K[55;185H299,38[8C68%[49;38H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hpred_tokens = torch.argmax(logits, dim=[95m2[m).transpose([95m1[m,[95m2[m)[55;185H[K[55;185H300,53[8C68%[49;53H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hteacher_codes = teacher.transpose([95m1[m,[95m2[m)[55;185H[K[55;185H301,86[8C68%[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[93mwith[m torch.no_grad():[55;185H[K[55;185H302,63[8C69%[49;50H[46m([11C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;29Hpred_wav = encodec_model.decode([(pred_tokens, [1m[96mNone[m)])[55;185H[K[55;185H303,1[9C69%[48;50H([11C)
[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hteacher_wav = encodec_model.decode([(teacher_codes, [1m[96mNone[m)])[55;185H[K[55;185H304,49[8C69%[49;47H[96m[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[55;185H[K[55;185H305,81[8C69%[48;47H[96m()[m[49;76H[46m([3C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25H[96m# compute audio losses (detached from autograd)[m[55;185H[K[55;185H306,63[8C70%[48;76H([3C)[49;58H[46m([3C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hstft_loss = stft_fn(pred_wav, teacher_wav).detach()[55;185H[K[55;185H307,46[8C70%[48;58H([3C)[49;46H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hwf_loss = wf_fn(pred_wav, teacher_wav).detach()[55;185H[K[55;185H308,83[8C70%[49;60H[46m([21C)[?25h[?25l[1;54r[m[54;1H
[1;55r[55;185H[K[55;185H309,86[8C71%[48;60H([21C)[49;64H[46m[[21C][?25h[?25l[1;54r[m[54;1H
[1;55r[54;25H[96m# combine losses but scale CE for accumulation[m[55;185H[K[55;185H310,1[9C71%[48;64H[[21C]
[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hloss = ce_loss + args.lambda_waveform * wf_loss + args.lambda_stft * stft_loss[55;185H[K[55;185H311,72[8C71%[49;48H[96m[46m([22C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hloss_scaled = loss / accum_steps[55;185H[K[55;185H312,76[8C71%[48;48H[96m([22C)[m[49;74H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[55;185H[K[55;185H313,72[8C72%[48;74H()[49;70H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;21Hscaler.scale(loss_scaled).backward()[55;185H[K[55;185H314,1[9C72%[48;70H()
[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H315,71[8C72%[49;71H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[96m# Step when accumulation boundary reached[m[55;185H[K[55;185H316,86[8C72%[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[54;17His_last_step = (batch_idx + [95m1[m == [1m[96mlen[m(train_loader))[55;185H[K[55;185H317,57[8C73%[49;57H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[93mif[m ((batch_idx + [95m1[m) % accum_steps == [95m0[m) [93mor[m is_last_step:[55;185H[K[55;185H318,1[9C73%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;21Hscaler.step(optimizer)[55;185H[K[55;185H319,57[8C73%[49;55H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;21Hscaler.update()[55;185H[K[55;185H320,1[9C74%[48;55H()
[?25h[?25l[1;54r[54;1H
[1;55r[54;21Hoptimizer.zero_grad()[55;185H[K[55;185H321,58[8C74%[49;58H[?25h[?25l[1;54r[54;1H
[1;55r[54;21Hscheduler.step()[55;185H[K[55;185H322,68[8C74%[49;32H[46m([34C)[?25h[?25l[1;54r[m[54;1H
[1;55r[55;185H[K[55;185H323,73[8C74%[48;32H([34C)[49;73H[?25h[?25l[1;54r[54;1H
[1;55r[54;17Hbsz = degraded.size([95m0[m)[55;185H[K[55;185H324,43[8C75%[49;32H[46m([9C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17Hepoch_loss += loss.item() * bsz[55;185H[K[55;185H325,36[8C75%[48;32H([9C)[49;34H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17Hepoch_ce += ce_loss.item() * bsz[55;185H[K[55;185H326,42[8C75%[48;34H()[49;40H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17Hepoch_stft += stft_loss.item() * bsz[55;185H[K[55;185H327,37[8C75%[48;40H()[49;35H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17Hepoch_wf += wf_loss.item() * bsz[55;185H[K[55;185H328,1[9C76%[48;35H()
[?25h[?25l[1;54r[54;1H
[1;55r[54;17Hepoch_count += bsz[55;185H[K[55;185H329,39[8C76%[49;36H[46m([1C)[?25h[?25l[1;54r[m[54;1H
[1;55r[55;185H[K[55;185H330,48[8C76%[48;36H([1C)[49;48H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[93mexcept[m [38;5;121mRuntimeError[m [93mas[m e:[55;185H[K[55;185H331,49[8C77%[49;49H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[96m# Detect OOM[m[55;185H[K[55;185H332,53[8C77%[49;53H[?25h[?25l[1;54r[54;1H
[1;55r[54;17Hoom = ([95m"out of memory"[m [93min[m [1m[96mstr[m(e).lower()) [93mor[m ([95m"cuda out of memory"[m [93min[m [1m[96mstr[m(e).lower())[55;185H[K[55;185H333,49[8C77%[49;49H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[93mif[m [93mnot[m oom:[55;185H[K[55;185H334,35[8C77%[49;35H[?25h[?25l[1;54r[54;1H
[1;55r[54;21H[93mraise[m[55;185H[K[55;185H335,1[9C78%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H336,38[8C78%[49;38H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[96m# free what we can locally[m[55;185H[K[55;185H337,29[8C78%[49;29H[?25h[?25l[1;54r[54;1H
[1;55r[54;17Hlogging.warning(f[95m"OOM at epoch {epoch} batch {batch_idx}: {e}"[m)[55;185H[K[55;185H338,86[8C78%[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[54;17Htorch.cuda.empty_cache()[55;185H[K[55;185H339,28[8C79%[49;28H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H340,26[8C79%[49;26H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[96m# signal local OOM (1) or success (0)[m[55;185H[K[55;185H341,1[9C79%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;17Hlocal_oom = torch.tensor([[95m1[m], device=device, dtype=torch.int32)[55;185H[K[55;185H342,43[8C80%[49;43H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H343,80[8C80%[49;32H[46m([46C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17H[96m# reduce across ranks to see if any rank OOMed[m[55;185H[K[55;185H344,41[8C80%[48;32H([46C)[49;39H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17H[93mif[m is_ddp:[55;185H[K[55;185H345,1[9C80%[48;39H()
[?25h[?25l[1;54r[54;1H
[1;55r[54;21Hglobal_oom = local_oom.clone()[55;185H[K[55;185H346,54[8C81%[49;51H[96m[46m([1C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;21Hdist.all_reduce(global_oom, op=dist.ReduceOp.SUM)[55;185H[K[55;185H347,80[8C81%[48;51H[96m(0)[m[49;41H[46m([37C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;21Hany_oom = [1m[96mint[m(global_oom.item()) > [95m0[m[55;185H[K[55;185H348,1[9C81%[48;41H([37C)
[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[93melse[m:[55;185H[K[55;185H349,63[8C81%[49;63H[?25h[?25l[1;54r[54;1H
[1;55r[54;21Hany_oom = [1m[96mTrue[m[55;185H[K[55;185H350,27[8C82%[49;27H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H351,51[8C82%[49;49H[46m()[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17H[93mif[m any_oom:[55;185H[K[55;185H352,70[8C82%[48;49H()[49;36H[46m([32C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;21H[96m# rank 0 decides the new batch size (halved)[m[55;185H[K[55;185H353,57[8C83%[48;36H([32C)[49;57H[?25h[?25l[1;54r[54;1H
[1;55r[54;21H[93mif[m is_ddp:[55;185H[K[55;185H354,22[8C83%[49;22H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[93mif[m rank == [95m0[m:[55;185H[K[55;185H355,35[8C83%[49;35H[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hnew_bs = [1m[96mmax[m([95m1[m, args.per_step_batch_size // [95m2[m)[55;185H[K[55;185H356,1[9C83%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;29Hdecide = torch.tensor([new_bs], device=device, dtype=torch.int32)[55;185H[K[55;185H357,28[8C84%[49;28H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[93melse[m:[55;185H[K[55;185H358,65[8C84%[49;57H[96m[46m([6C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;29Hdecide = torch.tensor([[95m0[m], device=device, dtype=torch.int32)[55;185H[K[55;185H359,31[8C84%[48;57H[96m(halved)[49;31H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hdist.broadcast(decide, src=[95m0[m)[55;185H[K[55;185H360,38[8C84%[49;38H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hnew_bs = [1m[96mint[m(decide.item())[55;185H[K[55;185H361,75[8C85%[49;41H[46m([32C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;21H[93melse[m:[55;185H[K[55;185H362,86[8C85%[48;41H([32C)[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hnew_bs = [1m[96mmax[m([95m1[m, args.per_step_batch_size // [95m2[m)[55;185H[K[55;185H363,30[8C85%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H364,86[8C86%[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[54;21H[93mif[m new_bs < args.per_step_batch_size:[55;185H[K[55;185H365,54[8C86%[49;39H[46m([13C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hlogging.warning(f[95m"Synchronized decision: reducing per_step_batch_size {args.per_step_batch_size} -> {new_bs}"[m)[55;185H[K[55;185H366,52[8C86%[48;39H([13C)[49;37H[46m([13C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hargs.per_step_batch_size = new_bs[55;185H[K[55;185H367,26[8C86%[48;37H([13C)[49;26H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[96m# recreate loader in next epoch loop[m[55;185H[K[55;185H368,71[8C87%[49;37H[46m([32C)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;25Hrestart_epoch = [1m[96mTrue[m[55;185H[K[55;185H369,1[9C87%[48;37H([32C)
[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[93mbreak[m[55;185H[K[55;185H370,58[8C87%[49;58H[?25h[?25l[1;54r[54;1H
[1;55r[54;21H[93melse[m:[55;185H[K[55;185H371,86[8C87%[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[96m# already at 1 and still OOM -> abort training[m[55;185H[K[55;185H372,58[8C88%[49;58H[?25h[?25l[1;54r[54;1H
[1;55r[54;25Hlogging.error([95m"OOM at per_step_batch_size==1 on all ranks; cannot recover. Aborting."[m)[55;185H[K[55;185H373,61[8C88%[49;61H[?25h[?25l[1;54r[54;1H
[1;55r[54;25H[93mraise[m e[55;185H[K[55;185H374,45[8C88%[49;45H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H375,30[8C89%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mif[m restart_epoch:[55;185H[K[55;185H376,26[8C89%[49;26H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[96m# continue to next epoch iteration which will rebuild loader and retry same epoch[m[55;185H[K[55;185H377,71[8C89%[49;71H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H[93mcontinue[m[55;185H[K[55;185H378,86[8C89%[49;86H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H379,32[8C90%[49;32H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[96m# Aggregate epoch stats across ranks[m[55;185H[K[55;185H380,1[9C90%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mif[m is_ddp:[55;185H[K[55;185H381,26[8C90%[49;26H[?25h[?25l[55;187H0,1 [48;1H[?25h[?25l[55;186H79,32[47;32H[?25h[?25l[55;187H8,86[46;86H[?25h[?25l[55;187H7,71[45;71H[?25h[?25l[55;187H6,26[44;26H[?25h[?25l[55;187H5,30[43;30H[?25h[?25l[55;187H4,45[42;45H[?25h[?25l[55;187H3,61[41;61H[?25h[?25l[55;187H2,58[40;58H[?25h[?25l[55;187H1,86[39;86H[?25h[?25l[55;187H0,58[38;58H[?25h[?25l[55;186H69,1 [37;1H[?25h[?25l[36;37H[46m([32C)[m[55;187H8,71[36;71H[?25h[?25l[55;190H0[36;70H[?25h[?25l[36;37H([32C)[55;189H69[36;69H[?25h[?25l[55;190H8[36;68H[?25h[?25l[55;190H7[36;67H[?25h[?25l[55;190H6[36;66H[?25h[?25l[55;190H5[36;65H[?25h[?25l[55;190H4[36;64H[?25h[?25l[55;190H3[36;63H[?25h[?25l[55;190H2[36;62H[?25h[?25l[55;190H1[36;61H[?25h[?25l[55;190H0[36;60H[?25h[?25l[55;189H59[36;59H[?25h[?25l[55;190H8[36;58H[?25h[?25l[55;190H7[36;57H[?25h[?25l[55;190H6[36;56H[?25h[?25l[55;190H5[36;55H[?25h[?25l[55;190H4[36;54H[?25h[?25l[55;190H5[36;55H[?25h[?25l[55;190H6[36;56H[?25h[?25latch_size // [95m2[m)[36;70H[K[55;190H5[36;55H[?25h[?25latch_size // [95m2[m)[36;69H[K[55;190H4[36;54H[?25h[?25latch_size // [95m2[m)[36;68H[K[55;190H3[36;53H[?25h[?25latch_size // [95m2[m)[36;67H[K[55;190H2[36;52H[?25h[?25latch_size // [95m2[m)[36;66H[K[55;190H1[36;51H[?25h[?25latch_size // [95m2[m)[36;65H[K[55;190H0[36;50H[?25h[?25latch_size // [95m2[m)[36;64H[K[55;189H49[36;49H[?25h[?25latch_size // [95m2[m)[36;63H[K[55;190H8[36;48H[?25h[?25latch_size // [95m2[m)[36;62H[K[55;190H7[36;47H[?25h[?25latch_size // [95m2[m)[36;61H[K[55;190H6[36;46H[?25h[?25lbatch_size // [95m2[m)[55;190H7[36;47H[?25h[?25l[55;187H7,26[35;26H[?25h[?25l[55;187H6,47[34;47H[?25h[?25l[55;187H5[33;47H[?25h[?25l[55;187H4[32;47H[?25h[?25l[55;187H3,30[31;30H[?25h[?25l[55;187H2,47[30;47H[?25h[?25l[55;190H8[30;48H[?25h[?25l[55;190H9[30;49H[?25h[?25lr[46m([42C)[m[55;189H50[30;50H[?25h[?25l([46m[[mnew_bs[46m][m[34C)[55;190H1[30;51H[?25h[?25l[55;190H2[30;52H[?25h[?25l[new_bs][55;190H3[30;53H[?25h[?25l[55;190H4[30;54H[?25h[?25l[55;187H1[29;54H[?25h[?25l[55;190H5[29;55H[?25h[?25l[55;190H6[29;56H[?25h[?25l[55;190H7[29;57H[?25h[?25l[55;190H8[29;58H[?25h[?25l[55;190H9[29;59H[?25h[?25lbatch_size // [95m2[m)[29;74H[K[55;190H8[29;58H[?25h[?25lbatch_size // [95m2[m)[29;73H[K[55;190H7[29;57H[?25h[?25lbatch_size // [95m2[m)[29;72H[K[55;190H6[29;56H[?25h[?25lbatch_size // [95m2[m)[29;71H[K[55;190H5[29;55H[?25h[?25lbatch_size // [95m2[m)[29;70H[K[55;190H4[29;54H[?25h[?25lbatch_size // [95m2[m)[29;69H[K[55;190H3[29;53H[?25h[?25lbatch_size // [95m2[m)[29;68H[K[55;190H2[29;52H[?25h[?25lbatch_size // [95m2[m)[29;67H[K[55;190H1[29;51H[?25h[?25lbatch_size // [95m2[m)[29;66H[K[55;190H0[29;50H[?25h[?25l[30;50H[46m([42C)[m[55;187H2[30;50H[?25h[?25l([42C)[55;187H3,3[31;30H[?25h[?25l[32;50H[46m([37C)[m[55;187H4,5[32;50H[?25h[?25l([37C)[55;187H5[33;50H[?25h[?25l[34;49H[46m()[m[55;187H6[34;50H[?25h[?25l()[55;187H7,26[35;26H[?25h[?25l[55;187H8,50[36;50H[?25h[?25l[55;187H9,1 [37;1H[?25h[?25l[55;186H70,50[38;50H[?25h[?25l[55;187H1[39;50H[?25h[?25l[55;187H2[40;50H[?25h[?25l[55;187H1[39;50H[?25h[?25l[55;187H0[38;50H[?25h[?25l[55;189H49[38;49H[?25h[?25l[55;190H8[38;48H[?25h[?25l[55;190H7[38;47H[?25h[?25l[55;190H6[38;46H[?25h[?25l[55;190H5[38;45H[?25h[?25l[55;190H4[38;44H[?25h[?25l[55;190H5[38;45H[?25h[?25l[55;190H6[38;46H[?25h[?25l[55;190H7[38;47H[?25h[?25lbatch_size:[38;57H[K[55;190H6[38;46H[?25h[?25lbatch_size:[38;56H[K[55;190H5[38;45H[?25h[?25lbatch_size:[38;55H[K[55;190H4[38;44H[?25h[?25lbatch_size:[38;54H[K[55;190H3[38;43H[?25h[?25lbatch_size:[38;53H[K[55;190H2[38;42H[?25h[?25lbatch_size:[38;52H[K[55;190H1[38;41H[?25h[?25lbatch_size:[38;51H[K[55;190H0[38;40H[?25h[?25lbatch_size:[38;50H[K[55;189H39[38;39H[?25h[?25lbatch_size:[38;49H[K[55;190H8[38;38H[?25h[?25l[55;187H1[39;38H[?25h[?25l[55;187H2[40;38H[?25h[?25l[55;190H9[40;39H[?25h[?25l[55;189H40[40;40H[?25h[?25l[55;189H39[40;39H[?25h[?25lbatch_size = new_bs[40;57H[K[55;190H8[40;38H[?25h[?25lbatch_size = new_bs[40;56H[K[55;190H7[40;37H[?25h[?25lbatch_size = new_bs[40;55H[K[55;190H6[40;36H[?25h[?25lbatch_size = new_bs[40;54H[K[55;190H5[40;35H[?25h[?25lbatch_size = new_bs[40;53H[K[55;190H4[40;34H[?25h[?25lbatch_size = new_bs[40;52H[K[55;190H3[40;33H[?25h[?25lbatch_size = new_bs[40;51H[K[55;190H2[40;32H[?25h[?25lbatch_size = new_bs[40;50H[K[55;190H1[40;31H[?25h[?25lbatch_size = new_bs[40;49H[K[55;190H0[40;30H[?25h[?25l[55;187H3[41;30H[?25h[?25l[55;187H4[42;30H[?25h[?25l[55;187H5[43;30H[?25h[?25l[55;187H6,26[44;26H[?25h[?25l[55;187H7,30[45;30H[?25h[?25l[55;187H8[46;30H[?25h[?25l[55;187H9[47;30H[?25h[?25l[55;186H80,1 [48;1H[?25h[?25l[55;187H1,26[49;26H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hstats = torch.tensor([epoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count], device=device)[55;185H[K[55;185H382,30[8C90%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hdist.all_reduce(stats, op=dist.ReduceOp.SUM)[55;185H[K[55;185H383,21[8C91%[49;21H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hepoch_loss, epoch_ce, epoch_stft, epoch_wf, epoch_count = [stats[i].item() [93mfor[m i [93min[m [1m[96mrange[m([95m5[m)][55;185H[K[55;185H384,1[9C91%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H385,30[8C91%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Havg_loss = epoch_loss / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[m[55;185H[K[55;185H386,19[8C92%[49;19H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Havg_ce = epoch_ce / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[m[55;185H[K[55;185H387,30[8C92%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Havg_stft = epoch_stft / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[m[55;185H[K[55;185H388,30[8C92%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Havg_wf = epoch_wf / epoch_count [93mif[m epoch_count > [95m0[m [93melse[m [95m0.0[m[55;185H[K[55;185H389,30[8C92%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H390,1[9C93%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[96m# validation[m[55;185H[K[55;185H391,30[8C93%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;9Hval_metrics = [1m[96mNone[m[55;185H[K[55;185H392,30[8C93%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mif[m val_loader [93mis[m [93mnot[m [1m[96mNone[m:[55;185H[K[55;185H393,30[8C93%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hval_metrics = validate_one_epoch(val_loader, model, device, encodec_model, n_codebooks=args.n_codebooks, lambda_waveform=args.lambda_waveform, lambda_stft=args.lambda_stft, is_ddp=is_ddp)[55;185H[K[55;185H394,30[8C94%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H395,1[9C94%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;9H[93mif[m rank == [95m0[m:[55;185H[K[55;185H396,21[8C94%[49;21H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hlogger.info(f[95m"Epoch {epoch+1}: train loss={avg_loss:.6f} ce={avg_ce:.6f} stft={avg_stft:.6f} wf={avg_wf:.6f} | val: {val_metrics}"[m)[55;185H[K[55;185H397,27[8C95%[49;27H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hos.makedirs(args.checkpoint_dir, exist_ok=[1m[96mTrue[m)[55;185H[K[55;185H398,30[8C95%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Hckpt_path = os.path.join(args.checkpoint_dir, f[95m"lcm_epoch{epoch+1}.pt"[m)[55;185H[K[55;185H399,30[8C95%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;13Htorch.save({[55;185H[K[55;185H400,1[9C95%[49;1H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"epoch"[m: epoch+[95m1[m,[55;185H[K[55;185H401,22[8C96%[49;22H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"model_state_dict"[m: model.module.state_dict() [93mif[m is_ddp [93melse[m model.state_dict(),[55;185H[K[55;185H402,30[8C96%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"optimizer_state_dict"[m: optimizer.state_dict(),[55;185H[K[55;185H403,30[8C96%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"scheduler_state_dict"[m: scheduler.state_dict(),[55;185H[K[55;185H404,30[8C96%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H}, ckpt_path)[55;185H[K[55;185H405,25[8C97%[49;24H[46m{[54;13H}[49;25H[?25h[?25l[1;54r[m[54;1H
[1;55r[54;13Hwandb.log({[55;185H[K[55;185H406,30[8C97%[48;24H{[53;13H}[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"epoch"[m: epoch+[95m1[m,[55;185H[K[55;185H407,30[8C97%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"train_loss"[m: avg_loss,[55;185H[K[55;185H408,30[8C98%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"train_ce"[m: avg_ce,[55;185H[K[55;185H409,30[8C98%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H[95m"train_stft"[m: avg_stft,[55;185H[K[55;185H410,26[8C98%[44;23H[46m([49;25H)[?25h[?25l[1;54r[m[54;1H
[1;55r[54;17H[95m"train_wf"[m: avg_wf,[55;185H[K[55;185H411,24[8C98%[43;23H([48;25H)[49;24H[?25h[?25l[1;54r[54;1H
[1;55r[54;17H**({f[95m"val_{k}"[m: v [93mfor[m k, v [93min[m (val_metrics [93mor[m {}).items()} )[55;185H[K[55;185H412,30[8C99%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;13H})[55;185H[K[55;185H413,30[8C99%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[55;185H[K[55;185H414,30[8C99%[49;30H[?25h[?25l[1;54r[54;1H
[1;55r[54;5Hlogger.info([95m"Training finished"[m)[55;185H[K[55;185H415,30[8CBot[49;30H[?25h[?25l[55;187H6[50;30H[?25h[?25l[51;27H[95m[46m{[1C}[m[55;187H7[51;30H[?25h[?25l[45;22H[46m([m[51;27H[95m{k}[m[52;14H[46m)[m[55;187H8,15[52;15H[?25h[?25l[45;22H([52;14H)[55;187H9,1 [53;1H[?25h[?25l[55;186H20,30[54;30H[?25h[55;1H[K[54;29H[?25l[55;175H^[[54;29H[55;175H  [54;30H[55;185H420,29[8CBot[54;29H[?25h[?25l[55;175H:[54;29H[55;175H[K[55;1H:[?25hwq[?25l[?2004l[>4;m"../lcm.py" 420L, 18654B written[23;2t[23;1t
[?1004l[?2004l[?1l>[?25h[>4;m[?1049l[23;0;0t[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ vim ../lcm.py [6@training5[C[C[C[C[16@tail -n 30 -f ../training_final.log[C[7Psbatch exec_lcm_training3.sh[C
[?2004lSubmitted batch job 163421
[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ sbatch exec_lcm_training3.sh [15Pvim ../lcm.py[C[6@training5[C[C[C[C[16@tail -n 30 -f ../training_final.log[C
[?2004lActivating virtual environment...
Starting Latent Consistency Model training (DDP mode)
Job Node: mscluster106.ms.wits.ac.za
GPUs available: 
Thu Oct 16 07:15:12 2025       
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 565.57.01              Driver Version: 565.57.01      CUDA Version: 12.7     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  Quadro RTX 8000                Off |   00000000:17:00.0 Off |                  Off |
| 34%   53C    P5             39W /  260W |       4MiB /  49152MiB |      0%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+
|   1  Quadro RTX 8000                Off |   00000000:73:00.0 Off |                  Off |
| 33%   56C    P8             27W /  260W |       4MiB /  49152MiB |      0%      Default |
|                                         |                        |                  N/A |
+-----------------------------------------+------------------------+----------------------+
                                                                                         
+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|  No running processes found                                                             |
+-----------------------------------------------------------------------------------------+
[2025-10-16 07:15:18,171] torch.distributed.run: [WARNING] master_addr is only used for static rdzv_backend and when rdzv_endpoint is not specified.
mscluster106:3312481:3312481 [0] NCCL INFO Bootstrap : Using enp0s31f6:10.100.14.106<0>
mscluster106:3312481:3312481 [0] NCCL INFO NET/Plugin : Plugin load (libnccl-net.so) returned 2 : libnccl-net.so: cannot open shared object file: No such file or directory
mscluster106:3312481:3312481 [0] NCCL INFO NET/Plugin : No plugin found, using internal implementation
mscluster106:3312481:3312481 [0] NCCL INFO cudaDriverVersion 12070
NCCL version 2.18.1+cuda12.1
mscluster106:3312482:3312482 [1] NCCL INFO cudaDriverVersion 12070
mscluster106:3312482:3312482 [1] NCCL INFO Bootstrap : Using enp0s31f6:10.100.14.106<0>
mscluster106:3312482:3312482 [1] NCCL INFO NET/Plugin : Plugin load (libnccl-net.so) returned 2 : libnccl-net.so: cannot open shared object file: No such file or directory
mscluster106:3312482:3312482 [1] NCCL INFO NET/Plugin : No plugin found, using internal implementation
mscluster106:3312481:3312532 [0] NCCL INFO NET/IB : No device found.
mscluster106:3312481:3312532 [0] NCCL INFO NET/Socket : Using [0]enp0s31f6:10.100.14.106<0>
mscluster106:3312481:3312532 [0] NCCL INFO Using network Socket
mscluster106:3312482:3312533 [1] NCCL INFO NET/IB : No device found.
mscluster106:3312482:3312533 [1] NCCL INFO NET/Socket : Using [0]enp0s31f6:10.100.14.106<0>
mscluster106:3312482:3312533 [1] NCCL INFO Using network Socket
mscluster106:3312482:3312533 [1] NCCL INFO Setting affinity for GPU 1 to 0fffff,ff000000,0fffffff
mscluster106:3312481:3312532 [0] NCCL INFO Setting affinity for GPU 0 to 0fffff,ff000000,0fffffff
mscluster106:3312481:3312532 [0] NCCL INFO Channel 00/04 :    0   1
mscluster106:3312482:3312533 [1] NCCL INFO Trees [0] -1/-1/-1->1->0 [1] 0/-1/-1->1->-1 [2] -1/-1/-1->1->0 [3] 0/-1/-1->1->-1
mscluster106:3312481:3312532 [0] NCCL INFO Channel 01/04 :    0   1
mscluster106:3312482:3312533 [1] NCCL INFO P2P Chunksize set to 524288
mscluster106:3312481:3312532 [0] NCCL INFO Channel 02/04 :    0   1
mscluster106:3312481:3312532 [0] NCCL INFO Channel 03/04 :    0   1
mscluster106:3312481:3312532 [0] NCCL INFO Trees [0] 1/-1/-1->0->-1 [1] -1/-1/-1->0->1 [2] 1/-1/-1->0->-1 [3] -1/-1/-1->0->1
mscluster106:3312481:3312532 [0] NCCL INFO P2P Chunksize set to 524288
mscluster106:3312481:3312532 [0] NCCL INFO Channel 00/0 : 0[17000] -> 1[73000] via P2P/IPC
mscluster106:3312482:3312533 [1] NCCL INFO Channel 00/0 : 1[73000] -> 0[17000] via P2P/IPC
mscluster106:3312481:3312532 [0] NCCL INFO Channel 01/0 : 0[17000] -> 1[73000] via P2P/IPC
mscluster106:3312482:3312533 [1] NCCL INFO Channel 01/0 : 1[73000] -> 0[17000] via P2P/IPC
mscluster106:3312481:3312532 [0] NCCL INFO Channel 02/0 : 0[17000] -> 1[73000] via P2P/IPC
mscluster106:3312482:3312533 [1] NCCL INFO Channel 02/0 : 1[73000] -> 0[17000] via P2P/IPC
mscluster106:3312481:3312532 [0] NCCL INFO Channel 03/0 : 0[17000] -> 1[73000] via P2P/IPC
mscluster106:3312482:3312533 [1] NCCL INFO Channel 03/0 : 1[73000] -> 0[17000] via P2P/IPC
mscluster106:3312481:3312532 [0] NCCL INFO Connected all rings
mscluster106:3312481:3312532 [0] NCCL INFO Connected all trees
mscluster106:3312481:3312532 [0] NCCL INFO threadThresholds 8/8/64 | 16/8/64 | 512 | 512
mscluster106:3312481:3312532 [0] NCCL INFO 4 coll channels, 0 nvls channels, 4 p2p channels, 4 p2p channels per peer
mscluster106:3312482:3312533 [1] NCCL INFO Connected all rings
mscluster106:3312482:3312533 [1] NCCL INFO Connected all trees
mscluster106:3312482:3312533 [1] NCCL INFO threadThresholds 8/8/64 | 16/8/64 | 512 | 512
mscluster106:3312482:3312533 [1] NCCL INFO 4 coll channels, 0 nvls channels, 4 p2p channels, 4 p2p channels per peer
mscluster106:3312481:3312532 [0] NCCL INFO comm 0x9a0c320 rank 0 nranks 2 cudaDev 0 busId 17000 commId 0x2924d1f4cbaa0a16 - Init COMPLETE
mscluster106:3312482:3312533 [1] NCCL INFO comm 0x895b6c0 rank 1 nranks 2 cudaDev 1 busId 73000 commId 0x2924d1f4cbaa0a16 - Init COMPLETE
[DDP] Initialized with 2 processes
Detected 32 codebooks from dataset sample
[DDP] Model wrapped successfully
2025-10-16 07:15:25 | INFO | Logging to /datasets/onailana/checkpoints3/train_20251016_071525_rank1.log (rank 1)
2025-10-16 07:15:25 | INFO | Logging to /datasets/onailana/checkpoints3/train_20251016_071525_rank0.log (rank 0)
/home-mscluster/onailana/miniconda3/envs/env/lib/python3.9/site-packages/torch/nn/utils/weight_norm.py:30: UserWarning: torch.nn.utils.weight_norm is deprecated in favor of torch.nn.utils.parametrizations.weight_norm.
  warnings.warn("torch.nn.utils.weight_norm is deprecated in favor of torch.nn.utils.parametrizations.weight_norm.")
/home-mscluster/onailana/miniconda3/envs/env/lib/python3.9/site-packages/torch/nn/utils/weight_norm.py:30: UserWarning: torch.nn.utils.weight_norm is deprecated in favor of torch.nn.utils.parametrizations.weight_norm.
  warnings.warn("torch.nn.utils.weight_norm is deprecated in favor of torch.nn.utils.parametrizations.weight_norm.")
2025-10-16 07:15:43 | INFO | No checkpoint found; starting fresh
2025-10-16 07:15:43 | INFO | No checkpoint found; starting fresh
2025-10-16 07:15:43 | INFO | Starting training: epochs=1500, per_step_batch_size=2, accum_steps=4, ddp=True
wandb: Currently logged in as: ratinailana (ratinailana-university-of-the-witwatersrand) to https://api.wandb.ai. Use `wandb login --relogin` to force relogin
wandb: setting up run kuiwg1sq
wandb: Tracking run with wandb version 0.22.1
wandb: Run data is saved locally in /home-mscluster/onailana/ASR-LCM-Research/scripts/wandb/run-20251016_071544-kuiwg1sq
wandb: Run `wandb offline` to turn off syncing.
wandb: Syncing run expert-mountain-2
wandb: â­ï¸ View project at https://wandb.ai/ratinailana-university-of-the-witwatersrand/lcm-distill
wandb: ðŸš€ View run at https://wandb.ai/ratinailana-university-of-the-witwatersrand/lcm-distill/runs/kuiwg1sq
2025-10-16 07:15:47 | INFO | Starting training: epochs=1500, per_step_batch_size=2, accum_steps=4, ddp=True
^C
[?2004honailana@mscluster-login1:~/ASR-LCM-Research/scripts$ wz[K[Kexti[K[Kit
[?2004lexit

Script done on 2025-10-16 07:29:34+02:00 [COMMAND_EXIT_CODE="130"]
